<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard de Evaluaciones</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;800&display=swap" rel="stylesheet">
<!-- Cargamos la librería de Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  /* Estilos base (los mismos de tu otro archivo para consistencia) */
  :root{
    --bg:#0f1724; --card:#071022; --accent:#06b6d4; --muted:#93a3b3; --glass: rgba(255,255,255,0.03);
    --success:#10b981; --danger:#ef4444; --warning: #f59e0b; --text:#e6eef6; --strong:#cbd5e1;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071226 0%, #071423 60%);color:var(--text)}
  .wrap{max-width:1200px;margin:18px auto;padding:18px;}
  header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;margin-bottom:24px;}
  .logo{display:flex;gap:14px;align-items:center}
  .logo-icon{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:800;color:#021226;font-size:20px}
  h1{margin:0;font-size:18px;color:var(--strong)}
  p.lead{margin:6px 0 12px;color:var(--muted);font-size:13px}
  .btn{padding:10px 14px;border-radius:8px;border:0;background:linear-gradient(90deg,var(--accent),#7c3aed);color:#021226;font-weight:700;cursor:pointer}
  
  /* Grid para las tarjetas */
  #cardGrid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
  }
  
  /* Estilo de cada tarjeta */
  .eval-card {
    background: var(--card);
    padding: 16px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.03);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .eval-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  }
  .card-info {
    font-size: 14px;
    color: var(--muted);
  }
  .card-info strong {
    font-size: 16px;
    color: var(--strong);
    display: block;
    margin-bottom: 4px;
  }
  .card-risk {
    font-size: 28px;
    font-weight: 800;
    text-align: right;
  }
  .card-risk span {
    font-size: 14px;
    font-weight: 500;
    display: block;
    text-transform: uppercase;
  }
  
  /* Colores de Riesgo */
  .risk-alto { color: var(--danger); }
  .risk-medio { color: var(--warning); }
  .risk-bajo { color: var(--success); }

  /* Modal de Detalle */
  .modal-overlay {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.8);
    backdrop-filter: blur(5px);
    align-items: center;
    justify-content: center;
  }
  .modal-content {
    background: var(--card);
    border: 1px solid rgba(255,255,255,0.05);
    padding: 24px;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }
  .modal-header h2 {
    margin: 0;
    color: var(--accent);
  }
  .modal-close {
    font-size: 24px;
    font-weight: 700;
    color: var(--muted);
    cursor: pointer;
    background: none;
    border: none;
  }
  .modal-body dl {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 10px;
    font-size: 14px;
  }
  .modal-body dt {
    color: var(--muted);
    font-weight: 700;
  }
  .modal-body dd {
    margin: 0;
    color: var(--text);
    background: var(--bg);
    padding: 6px 10px;
    border-radius: 6px;
  }

  @keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* INICIA ESTILOS DE MÉTRICAS */
#metricsBar {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}
.metric-card {
  background: var(--card);
  padding: 16px;
  border-radius: 10px;
  border: 1px solid var(--glass);
  text-align: center;
}
.metric-card h3 {
  margin: 0 0 8px 0;
  font-size: 13px;
  color: var(--muted);
  font-weight: 500;
  text-transform: uppercase;
}
.metric-card p {
  margin: 0;
  font-size: 28px;
  font-weight: 800;
  color: var(--strong);
}
/* Usamos los mismos colores de riesgo */
.metric-card.risk-alto p { color: var(--danger); }
.metric-card.risk-medio p { color: var(--warning); }
.metric-card.risk-bajo p { color: var(--success); }

  /* Spinner */
  #loadingSpinner {
    border: 4px solid var(--glass);
    border-top: 4px solid var(--accent);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 40px auto;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
</head>
<body>
    <div id="metricsBar">
  <div class="metric-card">
    <h3>Total Evals</h3>
    <p id="metric-total">0</p>
  </div>
  <div class="metric-card">
    <h3>Riesgo Promedio</h3>
    <p id="metric-avg-risk">0.0</p>
  </div>
  <div class="metric-card risk-alto">
    <h3>Alto Riesgo</h3>
    <p id="metric-high">0</p>
  </div>
  <div class="metric-card risk-medio">
    <h3>Medio Riesgo</h3>
    <p id="metric-medium">0</p>
  </div>
  <div class="metric-card risk-bajo">
    <h3>Bajo Riesgo</h3>
    <p id="metric-low">0</p>
  </div>
</div>
<div id="loadingSpinner"></div>

<div class="wrap">
  <header>
    <div class="logo">
      <div class="logo-icon">EG</div>
      <div>
        <h1>Dashboard de Evaluaciones</h1>
        <p class="lead">Resultados de Ergonomía en Bipedestación</p>
      </div>
    </div>
    <button class="btn" id="exportBtn" onclick="exportToXLSX()">Exportar a Excel</button>
  </header>

  <!-- Contenedor para las tarjetas -->
  <div id="loadingSpinner"></div>
  <div id="cardGrid">
    <!-- Las tarjetas se insertarán aquí con JS -->
  </div>
</div>

<!-- Modal para ver el detalle -->
<div id="detailModal" class="modal-overlay" onclick="hideDetail()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 id="modalTitle">Detalle de Evaluación</h2>
      <button class="modal-close" onclick="hideDetail()">&times;</button>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- El detalle se insertará aquí con JS -->
    </div>
  </div>
</div>


<script>
  // --- 1. Inicialización de Supabase ---
  const supabaseUrl = 'https://hvwygpnuunuuylzondxt.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2d3lncG51dW51dXlsem9uZHh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDUzMTEsImV4cCI6MjA3NjEyMTMxMX0.FxjCX9epT_6LgWGdzdPhRUTP2vn4CLdixRqpFMRZK70';
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  // Almacén global para los datos
  let allEvaluations = [];

  // --- 2. Cargar Datos al Iniciar ---
  window.addEventListener('DOMContentLoaded', async () => {
    await fetchEvaluations();
  });

async function fetchEvaluations() {
  const grid = document.getElementById('cardGrid');
  const spinner = document.getElementById('loadingSpinner');
  grid.innerHTML = '';
  spinner.style.display = 'block';

  try {
    const { data, error } = await supabase
      .from('evaluaciones_bipedestacion')
      .select('*');

    if (error) throw error;

    allEvaluations = data;
    
    // 1. Ordenas los datos
    allEvaluations.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

    // 2. (ESTA ES LA LÍNEA AÑADIDA)
    // Llamas a la función que calcula y muestra las métricas (Totales, Promedio, etc.)
    calculateAndRenderMetrics(allEvaluations); 
    
    // 3. (LÍNEA ORIGINAL)
    // Llamas a la función que dibuja las tarjetas individuales
    renderCards(allEvaluations);

  } catch (error) {
    grid.innerHTML = `<p style="color:var(--danger)">Error al cargar los datos: ${error.message}</p>`;
  } finally {
    spinner.style.display = 'none';
  }
}

  // --- 3. Renderizar Tarjetas ---
  function renderCards(evaluations) {
    const grid = document.getElementById('cardGrid');
    if (evaluations.length === 0) {
      grid.innerHTML = '<p>No se encontraron evaluaciones.</p>';
      return;
    }

    evaluations.forEach(eval => {
      const riskClass = eval.clasificacion.toLowerCase();
      const riskColorClass = `risk-${riskClass}`;

      const cardHTML = `
        <div class="eval-card" onclick="showDetail(${eval.id})">
          <div class="card-info">
            <strong>${eval.trabajador_id || 'Sin ID'}</strong>
            ${eval.area_puesto || 'Sin área'}
            <br>
            <span style="font-size: 12px;">${new Date(eval.created_at).toLocaleString()}</span>
          </div>
          <div class="card-risk ${riskColorClass}">
            ${eval.indice_riesgo}
            <span class="${riskColorClass}">${eval.clasificacion}</span>
          </div>
        </div>
      `;
      grid.innerHTML += cardHTML;
    });
  }

  function calculateAndRenderMetrics(evaluations) {
  const total = evaluations.length;
  let high = 0;
  let medium = 0;
  let low = 0;
  let riskSum = 0;

  if (total === 0) {
    document.getElementById('metric-total').innerText = '0';
    document.getElementById('metric-avg-risk').innerText = '0.0';
    document.getElementById('metric-high').innerText = '0';
    document.getElementById('metric-medium').innerText = '0';
    document.getElementById('metric-low').innerText = '0';
    return;
  }

  evaluations.forEach(eval => {
    // Aseguramos que indice_riesgo sea un número
    riskSum += Number(eval.indice_riesgo) || 0; 
    
    const riskClass = eval.clasificacion.toLowerCase();
    if (riskClass === 'alto') high++;
    else if (riskClass === 'medio') medium++;
    else if (riskClass === 'bajo') low++;
  });

  const avgRisk = (riskSum / total).toFixed(1);

  // Renderizar los valores en el HTML
  document.getElementById('metric-total').innerText = total;
  document.getElementById('metric-avg-risk').innerText = avgRisk;
  document.getElementById('metric-high').innerText = high;
  document.getElementById('metric-medium').innerText = medium;
  document.getElementById('metric-low').innerText = low;
}

  // --- 4. Lógica del Modal (Detalle) ---
  function showDetail(id) {
    const eval = allEvaluations.find(e => e.id === id);
    if (!eval) return;

    document.getElementById('modalTitle').innerText = `Evaluación: ${eval.trabajador_id}`;
    
    const body = document.getElementById('modalBody');
    body.innerHTML = `
      <dl>
        <dt>ID Trabajador</dt><dd>${eval.trabajador_id}</dd>
        <dt>Área/Puesto</dt><dd>${eval.area_puesto}</dd>
        <dt>Fecha</dt><dd>${new Date(eval.created_at).toLocaleString()}</dd>
        
        <dt>Clasificación</dt><dd style="font-weight:700;" class="risk-${eval.clasificacion.toLowerCase()}">${eval.clasificacion}</dd>
        <dt>Índice Riesgo</dt><dd style="font-weight:700;" class="risk-${eval.clasificacion.toLowerCase()}">${eval.indice_riesgo} / 100</dd>
        
        <dt>VAS (Dolor)</dt><dd>${eval.vas}</dd>
        <dt>Borg (Fatiga)</dt><dd>${eval.borg}</dd>
        <dt>Horas de Pie</dt><dd>${eval.horas_pie}</dd>
        <dt>Horas Caminando</dt><dd>${eval.horas_caminando}</dd>
        <dt>Tipo Postura</dt><dd>${eval.tipo_postura}</dd>
        <dt>Pudo Sentarse</dt><dd>${eval.pudo_sentarse}</dd>
        <dt>Síntomas</dt><dd>${eval.sintomas_nmq ? eval.sintomas_nmq.join(', ') : 'Ninguno'}</dd>
        
        <dt>Comentarios</dt><dd>${eval.comentarios || 'N/A'}</dd>
        
        <dt>--- Puntos ---</dt><dd></dd>
        <dt>Puntos (Bruto)</dt><dd>${eval.puntos_brutos}</dd>
        <dt>Puntos (VAS)</dt><dd>${eval.puntos_vas}</dd>
        <dt>Puntos (Borg)</dt><dd>${eval.puntos_borg}</dd>
        <dt>Puntos (Horas)</dt><dd>${eval.puntos_horas}</dd>
        <dt>Puntos (Síntomas)</dt><dd>${eval.puntos_sintomas}</dd>
        <dt>Puntos (Sentarse)</dt><dd>${eval.puntos_sentarse}</dd>
        <dt>Puntos (Postura)</dt><dd>${eval.puntos_postura}</dd>
        <dt>Puntos (Caminar)</dt><dd>${eval.puntos_caminar}</dd>
      </dl>
    `;

    document.getElementById('detailModal').style.display = 'flex';
  }

  function hideDetail() {
    document.getElementById('detailModal').style.display = 'none';
  }

  // --- 5. (MODIFICADO) Exportar a Excel (.xlsx) ---
function exportToXLSX() {
  if (allEvaluations.length === 0) {
    alert('No hay datos para exportar.');
    return;
  }
    // Opcional: Mapeamos los datos para tener cabeceras limpias
    // y formatear los arrays (como el de síntomas)
const dataToExport = allEvaluations.map(row => ({
    "ID Trabajador": row.trabajador_id,
    "Área/Puesto": row.area_puesto,
    "Fecha": new Date(row.created_at).toLocaleString(),
    "Índice Riesgo": row.indice_riesgo,
    "Clasificación": row.clasificacion,
    "Puntos Brutos": row.puntos_brutos,
    "VAS (Dolor)": row.vas,
    "Borg (Fatiga)": row.borg,
    "Horas de Pie": row.horas_pie,
    "Horas Caminando": row.horas_caminando,
    "Tipo Postura": row.tipo_postura,
    "Pudo Sentarse": row.pudo_sentarse,
    "Síntomas": row.sintomas_nmq ? row.sintomas_nmq.join('; ') : '',
    "Comentarios": row.comentarios,
    "Calzado Cómodo": row.calzado_comido,
    "Usa Plantillas": row.uso_plantillas,
    "Efecto Plantillas": row.efecto_plantillas,
    "Puntos VAS": row.puntos_vas,
    "Puntos Borg": row.puntos_borg,
    "Puntos Horas": row.puntos_horas,
    "Puntos Síntomas": row.puntos_sintomas,
    "Puntos Sentarse": row.puntos_sentarse,
    "Puntos Postura": row.puntos_postura,
    "Puntos Caminar": row.puntos_caminar
  }));

const ws = XLSX.utils.json_to_sheet(dataToExport);

  // 2. Definir el estilo de cabecera
  const headerStyle = {
    font: { bold: true },
    fill: { fgColor: { rgb: "E0E0E0" }, patternType: "solid" } // Gris claro
  };

  // 3. Obtener el rango de la hoja
  const range = XLSX.utils.decode_range(ws['!ref']);
  const headerRow = range.s.r; // Fila de cabecera (normalmente 0)

  // 4. Iterar por cada celda de la cabecera (columnas)
  for (let C = range.s.c; C <= range.e.c; ++C) {
    const cellAddress = XLSX.utils.encode_cell({ r: headerRow, c: C });
    const cell = ws[cellAddress];

    if (cell) {
      // Aplicar el estilo
      cell.s = headerStyle;

      // Convertir el valor a mayúsculas
      if (cell.t === 's' && cell.v) { // 's' es tipo string
        cell.v = cell.v.toUpperCase();
      }
    }
  }

  // 5. Crear el libro y descargar
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Resultados");

  const fileName = `export_evaluaciones_bipedestacion.xlsx`;
  XLSX.writeFile(wb, fileName);
}

</script>
</body>
</html>

