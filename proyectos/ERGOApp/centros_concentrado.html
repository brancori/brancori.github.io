<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centros de Trabajo - Vista Concentrada</title>
    <link rel="stylesheet" href="./componentes/globals.css">
    <link rel="stylesheet" href="areas.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./componentes/globals.js"></script>
    <script src="./componentes/supabase-config.js"></script>
    
    
</head>

<body>
    <!-- P√°gina Principal de Centros Concentrado -->
    <div id="centros-concentrado-page" class="page active">
        <div class="container">
            <header class="header">
                <div class="header-content">
                    <button class="btn btn-ghost" onclick="goBack()">
                        <span class="icon">‚Üê</span>
                        Regresar
                    </button>
                    <button class="btn btn-ghost" onclick="window.location.href='areas.html'">
                        <span class="icon">üè¢</span>
                        Ver por √Åreas
                    </button>
                </div>
            </header>
            
            <main class="main-content">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <h2>Todos los centros</h2>
                        <span id="centros-count" class="count-badge">0 centros</span>
                    </div>
                    
                    <div class="toolbar-actions">
                        <button class="btn btn-ghost" onclick="toggleCentrosFilters()">
                            <span class="icon">üîç</span>
                            Filtros
                        </button>
                        <button class="btn btn-ghost" onclick="toggleCentrosView()">
                            <span class="icon" id="view-toggle-icon">üìã</span>
                            <span id="view-toggle-text">Lista</span>
                        </button>
                        <button class="btn btn-ghost" onclick="exportCentrosPDF()">
                            <span class="icon">üìÑ</span>
                            Exportar PDF
                        </button>
                    </div>
                </div>

                <!-- Filtros para centros -->
                <div class="filters-container" id="centros-filters" style="display: none;">
                    <input type="text" id="filter-centro-name" placeholder="Buscar por nombre..." class="filter-input">
                    <select id="filter-centro-area" class="filter-select">
                        <option value="">Todas las √°reas</option>
                    </select>
                    <input type="text" id="filter-centro-responsible" placeholder="Buscar responsable..." class="filter-input">
                    <select id="filter-centro-score" class="filter-select">
                        <option value="">Todos los riesgos</option>
                        <option value="low">Bajo (‚â§25%)</option>
                        <option value="moderate-low">Medio Bajo (25-42.5%)</option>
                        <option value="moderate-high">Medio Alto (42.5-60%)</option>                        
                        <option value="high">Alto (61-75%)</option>
                    </select>
                    <select id="filter-centro-status" class="filter-select">
                        <option value="">Todos los estados</option>
                        <option value="evaluated">Con evaluaciones</option>
                        <option value="pending">Sin evaluar</option>
                    </select>
                    <select id="filter-centro-orden" class="filter-select">
                        <option value="">Orden predeterminado</option>
                        <option value="riesgo-desc">Mayor a menor riesgo</option>
                        <option value="riesgo-asc">Menor a mayor riesgo</option>
                        <option value="nombre">Por nombre A-Z</option>
                    </select>
                    <button class="btn btn-ghost btn-sm" onclick="clearCentrosFilters()">Limpiar filtros</button>
                </div>
                
                <div id="centros-container" class="content-grid">
                    <!-- Los centros se renderizan aqu√≠ -->
                </div>
            </main>
        </div>
    </div>

    <!-- Toast para notificaciones -->
    <div id="toast" class="toast">
        <span id="toast-message"></span>
    </div>

    <script>


        // Configuraci√≥n para usar Supabase o localStorage
        const USE_SUPABASE = window.ERGOConfig.USE_SUPABASE;

        // Variables globales
        let areas = [];
        let workCenters = [];
        let currentView = 'grid'; // 'grid' o 'list'
        let filtersVisible = false;
async function loadAreas() {
    try {
        console.log('üìÅ Cargando √°reas desde Supabase...');
        const areasData = await dataClient.getAreas();
        if (areasData && areasData.length > 0) {
            areas = areasData;
            console.log('‚úÖ √Åreas cargadas:', areas.length);
            return areas;
        } else {
            console.log('‚ö†Ô∏è No se encontraron √°reas');
            areas = [];
            return areas;
        }
    } catch (error) {
        console.error('‚ùå Error cargando √°reas:', error);
        areas = [];
        return areas;
    }
}

    async function loadAllWorkCenters() {
    const CACHE_KEY = 'workCentersCache';
    const CACHE_EXPIRY_HOURS = 6;
    const now = new Date().getTime();

    // 1. Intentar cargar desde el cach√©
    const cachedData = localStorage.getItem(CACHE_KEY);
    if (cachedData) {
        const { timestamp, data } = JSON.parse(cachedData);
        if (now - timestamp < CACHE_EXPIRY_HOURS * 60 * 60 * 1000) {
            console.log('‚úÖ Centros de trabajo cargados desde el cach√©.');
            workCenters = data;
            return workCenters;
        }
    }
    
    // 2. Si no hay cach√© o ha expirado, cargar de Supabase
    console.log('‚è≥ Cargando centros de trabajo desde Supabase...');
    try {
         workCenters = await dataClient.getWorkCentersWithScores() || []; // <-- L√≠nea original REACTIVADA
        // workCenters = await dataClient.testGetBaseTable() || []; // <-- L√≠nea de PRUEBA DESACTIVADA
        // Guardar en el cach√©
        localStorage.setItem(CACHE_KEY, JSON.stringify({
            timestamp: now,
            data: workCenters
        }));
        console.log('‚úÖ Centros de trabajo y scores guardados en cach√©.');
    } catch (error) {
        console.error('Error loading work centers with scores:', error);
        // Fallback a un array vac√≠o si la llamada falla
        workCenters = []; 
    }
    return workCenters;
}

        // Funciones de vista
        function toggleCentrosView() {
            currentView = currentView === 'grid' ? 'list' : 'grid';
            const icon = document.getElementById('view-toggle-icon');
            const text = document.getElementById('view-toggle-text');
            
            if (currentView === 'list') {
                icon.textContent = '‚äû';
                text.textContent = 'Tarjetas';
            } else {
                icon.textContent = 'üìã';
                text.textContent = 'Lista';
            }
            
            renderCentros();
        }

        // Funciones de filtros
        function toggleCentrosFilters() {
            filtersVisible = !filtersVisible;
            const filtersContainer = document.getElementById('centros-filters');
            if (filtersContainer) {
                filtersContainer.style.display = filtersVisible ? 'flex' : 'none';
            }
        }

        function clearCentrosFilters() {
            const nameFilter = document.getElementById('filter-centro-name');
            const areaFilter = document.getElementById('filter-centro-area');
            const responsibleFilter = document.getElementById('filter-centro-responsible');
            const scoreFilter = document.getElementById('filter-centro-score');
            const statusFilter = document.getElementById('filter-centro-status');
            const ordenFilter = document.getElementById('filter-centro-orden');
            
            if (ordenFilter) ordenFilter.value = '';
            if (nameFilter) nameFilter.value = '';
            if (areaFilter) areaFilter.value = '';
            if (responsibleFilter) responsibleFilter.value = '';
            if (scoreFilter) scoreFilter.value = '';
            if (statusFilter) statusFilter.value = '';
            
            renderCentros();
        }

        // Funci√≥n para filtrar centros
        function filterCentros(centrosToFilter) {
    const nameFilter = document.getElementById('filter-centro-name')?.value.toLowerCase() || '';
    const areaFilter = document.getElementById('filter-centro-area')?.value || '';
    const responsibleFilter = document.getElementById('filter-centro-responsible')?.value.toLowerCase() || '';
    const scoreFilter = document.getElementById('filter-centro-score')?.value || '';
    const statusFilter = document.getElementById('filter-centro-status')?.value || '';
    
    return centrosToFilter.filter(center => {
        // Los datos del score ahora est√°n dentro del objeto 'center'
        if (nameFilter && !center.name.toLowerCase().includes(nameFilter)) return false;
        if (areaFilter && center.area_id !== areaFilter) return false;
        if (responsibleFilter && !(center.responsible || '').toLowerCase().includes(responsibleFilter)) return false;
        
        if (scoreFilter) {
            const score = parseFloat(center.score_actual || 0);
            switch (scoreFilter) {
                case 'low': if (score > 25) return false; break;
                case 'moderate-low': if (score <= 25 || score > 42.5) return false; break;
                case 'moderate-high': if (score <= 42.5 || score > 60) return false; break;                            
                case 'high': if (score <= 60) return false; break;
            }
        }

        if (statusFilter) {
            const hasEvaluation = center.score_actual > 0;
            if (statusFilter === 'evaluated' && !hasEvaluation) return false;
            if (statusFilter === 'pending' && hasEvaluation) return false;
        }
        
        return true;
    });
}

// Funci√≥n para ordenar centros (ya no necesita scoreInfos)
function sortCentros(centrosToSort) {
    const ordenFilter = document.getElementById('filter-centro-orden')?.value || '';
    
    if (!ordenFilter) return centrosToSort;
    
    // Usamos el spread operator para crear una copia y no mutar el array original
    return [...centrosToSort].sort((a, b) => {
        switch (ordenFilter) {
            case 'riesgo-desc': return (b.score_actual || 0) - (a.score_actual || 0);
            case 'riesgo-asc': return (a.score_actual || 0) - (b.score_actual || 0);
            case 'nombre': return a.name.localeCompare(b.name);
            default: return 0;
        }
    });
}

        function updateCentrosCount(count) {
            const countElement = document.getElementById('centros-count');
            if (countElement) {
                countElement.textContent = `${count} ${count === 1 ? 'centro' : 'centros'}`;
            }
        }

        // Funci√≥n para poblar el filtro de √°reas
        function populateAreaFilter() {
            const areaFilter = document.getElementById('filter-centro-area');
            if (!areaFilter) return;

            // Limpiar opciones existentes (excepto la primera)
            areaFilter.innerHTML = '<option value="">Todas las √°reas</option>';
            console.log('√Åreas recibidas de Supabase:', areas);
            // Agregar √°reas disponibles
            areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area.id;
                option.textContent = area.name;
                areaFilter.appendChild(option);
            });
        }

        // Funci√≥n para obtener score desde Supabase con fallback a localStorage

        async function renderCentros() {
    const container = document.getElementById('centros-container');
    
    // aqui inicia
    if (workCenters.length === 0) {
                updateCentrosCount(0); 
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No hay centros de trabajo registrados</h3>
                        <p>Los centros aparecer√°n aqu√≠ cuando se creen desde las √°reas</p>
                    </div>
                `;
                return;
            }
            
            const filteredCentros = filterCentros(workCenters);
            const sortedCentros = sortCentros(filteredCentros);

            updateCentrosCount(sortedCentros.length);

            container.className = currentView === 'list' ? 'content-list' : 'content-grid';

            if (sortedCentros.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <h3>No se encontraron centros</h3>
                        <p>Intenta ajustar los filtros de b√∫squeda</p>
                    </div>
                `;
                return;
            }
            
            if (currentView === 'list') {
                container.innerHTML = sortedCentros.map(center => {
                     
                    return `
                        <div class="card-list" style="cursor: pointer;" onclick="navigateToCenterDetail('${center.id}', '${center.area_id}', '${encodeURIComponent(areaName)}', '${encodeURIComponent(center.name)}', '${encodeURIComponent(center.responsible)}')">
                            <div class="card-list__header">
                                <span class="card-list__id">${center.id}</span>
                                <span class="card-list__name">${center.name}</span>
                            </div>
                            <div class="card-list__details">
                                <div class="card-list__detail">üìç ${center.areaName}</div>
                                <div class="card-list__detail">üë§ ${center.responsible}</div>
                                <div class="card-list__detail card-list__detail--score">
                                    <span class="card-list__score-indicator" style="background-color: ${center.color_riesgo};"></span>
                                    ${center.score_actual} - ${center.categoria_riesgo}
                                </div>
                            </div>
                            <div class="card-list__footer">${ERGOUtils.formatDate(center.created_at)}</div>
                        </div>
                    `;
                }).join('');
            } else {
            container.innerHTML = sortedCentros.map(center => {
                    const areaName = center.area_name || '√Årea no encontrada';
                    
                    // Creamos un objeto 'scoreInfo' para compatibilidad, con valores por defecto
                     const scoreInfo = {
                        score_actual: center.score_actual || 0,
                        nFivel_riesgo_ergonomico: center.nivel_riesgo_ergonomico || 'No evaluado',
                        categoria_riesgo: center.categoria_riesgo || 'Sin datos',
                        color_riesgo: center.color_riesgo || '#a9a9a9' // Un color gris por defecto
                    };
                    // Pasamos el centro y el objeto de score con valores por defecto
                   return ERGOUtils.createWorkCenterCard(center, center, areaName, 'grid');
                }).join('');
            }
        }
        // Funci√≥n para navegar al √°rea espec√≠fica con el centro seleccionado
        function navigateToAreaCenter(areaId, centerId, areaName, centerName, responsible) {
            const url = `areas.html?area=${areaId}&areaName=${areaName}&fromConcentrado=true`;
            window.location.href = url;
        }

        // Funci√≥n para navegar al detalle del centro
        function navigateToCenterDetail(centerId, areaId, areaName, centerName, responsible) {
        const url = `/centro-trabajo.html?workCenter=${centerId}&area=${areaId}&areaName=${areaName}&centerName=${centerName}&responsible=${responsible}`;
            window.location.href = url;
        }
        // Funci√≥n para exportar datos
        function exportCentrosData() {
            const data = {
                centros: workCenters.map(center => {
                    const area = areas.find(a => a.id === center.area_id);
                    return {
                        id: center.id,
                        nombre: center.name,
                        responsable: center.responsible,
                        area: area ? area.area_name : '√Årea no encontrada',
                        score_actual: center.score_actual || 0, // A√±adido
                        is_closed: center.is_closed || false, // A√±adido
                        fecha_creacion: center.created_at
                    };
                }),
                exportDate: new Date().toISOString(),
                totalCentros: workCenters.length,
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});           
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `centros-concentrado-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            ERGOUtils.showToast('Datos exportados exitosamente');
        }
        // Event listeners e inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async function() {
            // 1. Inicializar y verificar el contexto de autenticaci√≥n ANTES de hacer nada.
            //    Esta es la l√≠nea clave que faltaba.
            if (!ERGOAuth.initializeAuthContext()) {
                console.log('‚ùå No hay sesi√≥n v√°lida en centros_concentrado.js, redirigiendo...');
                ERGOAuth.redirectToLogin();
                return;
            }
            console.log('‚úÖ Sesi√≥n y token verificados en centros_concentrado.js');

            // 2. Ahora s√≠, cargar los datos (dataClient ya tiene el token).
            try {
                areas = await loadAreas();
                await loadAllWorkCenters();
                
                populateAreaFilter();
                await renderCentros();
                
            } catch (error) {
                console.error('Error loading data:', error);
                ERGOUtils.showToast('Error al cargar los datos', 'error');
            }
            
            // 3. Configurar el resto de la p√°gina.
            ERGOAuth.applyPermissionControls();
           
            const setupFilters = () => {
                const nameFilter = document.getElementById('filter-centro-name');
                const areaFilter = document.getElementById('filter-centro-area');
                const responsibleFilter = document.getElementById('filter-centro-responsible');
                const scoreFilter = document.getElementById('filter-centro-score');
                const statusFilter = document.getElementById('filter-centro-status');
                const ordenFilter = document.getElementById('filter-centro-orden');             
                if (nameFilter) nameFilter.addEventListener('input', ERGOUtils.debounce(renderCentros, 300));
                if (areaFilter) areaFilter.addEventListener('change', renderCentros);
                if (responsibleFilter) responsibleFilter.addEventListener('input', ERGOUtils.debounce(renderCentros, 300));
                if (scoreFilter) scoreFilter.addEventListener('change', renderCentros);
                if (statusFilter) statusFilter.addEventListener('change', renderCentros);
                if (ordenFilter) ordenFilter.addEventListener('change', renderCentros);
            };
            setTimeout(setupFilters, 500);
        });
        // Manejar navegaci√≥n de vuelta desde areas.html
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                // La p√°gina se est√° mostrando desde el cache del navegador
                renderCentros();
            }
        });
    </script>
    <script src="./componentes/auth-client.js"></script>
    <script src="./componentes/realtime-client.js"></script>
    <script src="./componentes/header-component.js"></script>

</body>
</html>