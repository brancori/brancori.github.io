##INSTRUCCIONES PARA PROMPT
no reescribas todo el cÃ³digo sÃ³lo dame las partes que hay que cambias modificar editar o eliminar, si hay cÃ³digo que no se usa por favor indicarlo para eliminarlo, y dame las instrucciones exactas para implementar el cÃ³digo, que me das, procura la optimizaciÃ³n de recursos. 

# ERGOApp - DocumentaciÃ³n Completa del Sistema

**Nombre de la APP:** ERGOApp  
**PropÃ³sito:** Sistema de evaluaciÃ³n ergonÃ³mica para evaluar Ã¡reas y centros de trabajo

## ðŸš€ TecnologÃ­as

- **Frontend:** HTML, CSS, JavaScript
- **Backend:** Supabase (PostgreSQL, autenticaciÃ³n, almacenamiento de archivos y eventos en tiempo real)


**Arquitectura:**
- PatrÃ³n MVC simplificado
- Funciones globales centralizadas (globals.js)
- Manejo hÃ­brido Supabase/localStorage para compatibilidad

---

## Estructura de Base de Datos (Supabase)

### Tabla: `usuarios`
GestiÃ³n de autenticaciÃ³n y permisos del sistema.

| column_name | data_type                | descripciÃ³n |
| ----------- | ------------------------ | ----------- |
| id          | serial PRIMARY KEY       | ID Ãºnico del usuario |
| usuario     | text UNIQUE              | Nombre de usuario para login |
| password    | text                     | ContraseÃ±a (sin encriptar) |
| nombre      | text                     | Nombre completo para UI |
| puesto      | text                     | Cargo/rol para mostrar |
| rango       | integer                  | Nivel de permisos (1=Admin, 2=Editor, 3=Visualizador) |

### Tabla: `areas`
GestiÃ³n de Ã¡reas de trabajo con mÃ©tricas calculadas.

| column_name          | data_type                | descripciÃ³n |
| -------------------- | ------------------------ | ----------- |
| id                   | text                     | ID Ãºnico del Ã¡rea |
| name                 | text                     | Nombre del Ã¡rea |
| responsible          | text                     | Responsable del Ã¡rea |
| created_at           | timestamp with time zone | Fecha de creaciÃ³n |
| total_centros        | integer                  | Total de centros en el Ã¡rea |
| centros_evaluados    | integer                  | Centros con evaluaciÃ³n |
| promedio_score       | numeric                  | Promedio de riesgo del Ã¡rea |
| color_promedio       | text                     | Color para UI segÃºn riesgo |
| ultima_actualizacion | timestamp with time zone | Ãšltima actualizaciÃ³n |

### Tabla: `work_centers`
Centros de trabajo vinculados a Ã¡reas.

| column_name | data_type                | descripciÃ³n |
| ----------- | ------------------------ | ----------- |
| id          | text                     | ID Ãºnico del centro |
| name        | text                     | Nombre del centro |
| responsible | text                     | Responsable del centro |
| area_id     | text                     | FK a tabla areas |
| created_at  | timestamp with time zone | Fecha de creaciÃ³n |

### Tabla: `evaluaciones`
Evaluaciones ergonÃ³micas principales con resultados.

| column_name             | data_type                | descripciÃ³n |
| ----------------------- | ------------------------ | ----------- |
| id                      | text                     | ID Ãºnico de evaluaciÃ³n |
| work_center_id          | text                     | FK a work_centers |
| area_id                 | text                     | FK a areas |
| fecha_evaluacion        | date                     | Fecha de la evaluaciÃ³n |
| nombre_area             | text                     | Nombre del Ã¡rea evaluada |
| ubicacion_area          | text                     | UbicaciÃ³n del Ã¡rea |
| responsable_area        | text                     | Responsable del Ã¡rea |
| criterios               | jsonb                    | Criterios seleccionados |
| respuestas              | jsonb                    | Respuestas del cuestionario |
| score_final             | numeric                  | Score final de riesgo (0-100) |
| categoria_riesgo        | text                     | CategorÃ­a de riesgo textual |
| nivel_riesgo_ergonomico | text                     | Nivel de riesgo como % |
| color_riesgo            | text                     | Color para UI segÃºn riesgo |
| created_at              | timestamp with time zone | Fecha de creaciÃ³n |
| updated_at              | timestamp with time zone | Ãšltima actualizaciÃ³n |

### Tabla: `fotos_centros`
GestiÃ³n de fotos de los centros de trabajo.

| column_name    | data_type                | descripciÃ³n |
| -------------- | ------------------------ | ----------- |
| id             | uuid                     | ID Ãºnico de la foto |
| area_id        | text                     | FK a areas |
| work_center_id | text                     | FK a work_centers |
| foto_url       | character varying        | URL/path de la foto |
| foto_name      | text                     | Nombre original del archivo |
| created_at     | timestamp with time zone | Fecha de subida |

### Tabla: `scores_resumen` (OptimizaciÃ³n)
Tabla optimizada para consultas rÃ¡pidas de scores.

| column_name              | data_type                | descripciÃ³n |
| ------------------------ | ------------------------ | ----------- |
| work_center_id           | text PRIMARY KEY         | FK a work_centers |
| area_id                  | text                     | FK a areas |
| score_actual             | numeric                  | Ãšltimo score del centro |
| categoria_riesgo         | text                     | CategorÃ­a actual |
| color_riesgo             | text                     | Color para UI |
| fecha_ultima_evaluacion  | timestamp with time zone | Ãšltima evaluaciÃ³n |
| total_evaluaciones       | integer                  | Total de evaluaciones |
| updated_at              | timestamp with time zone | Ãšltima actualizaciÃ³n |

## ðŸŽ¨ Notas de diseÃ±o UX/UI

- EstÃ©tica general basada en **glassmorphism**: transparencias, desenfoques (`backdrop-filter`) y bordes suaves.
- Transiciones suaves (`transition: all 0.3s ease-in-out`) en botones e inputs.
- Uso de **fuentes sans-serif modernas**: `Inter`, `Poppins` o `Roboto`.
- Layout basado en **grid flexible** (CSS Grid o Flexbox).
- Efecto **parallax** en la pantalla principal (fondo animado con `transform: translateZ()`).
- Compatibilidad optimizada para dispositivos Android con EMUI y Android 14.


## Sistema de Usuarios y Permisos

### Usuarios Configurados

| Usuario    | ContraseÃ±a | Rango | Permisos | DescripciÃ³n |
| ---------- | ---------- | ----- | -------- | ----------- |
| `bran`     | `7563`     | 1     | CRUD completo | Administrador total |
| `invitado` | `1234`     | 3     | Solo lectura | Visualizador |

### Niveles de Permisos

**Rango 1 - Administrador:**
- âœ… Read (Leer)
- âœ… Create (Crear)
- âœ… Update (Editar)
- âœ… Delete (Eliminar)

**Rango 2 - Editor:**
- âœ… Read (Leer)
- âœ… Create (Crear)
- âŒ Update (Editar)
- âŒ Delete (Eliminar)

**Rango 3 - Visualizador:**
- âœ… Read (Leer)
- âŒ Create (Crear)
- âŒ Update (Editar)
- âŒ Delete (Eliminar)

---

## Arquitectura del Sistema

### Archivos Principales

**ðŸ“ Archivos Core:**
- `globals.js` - Funciones globales centralizadas
- `supabase-config.js` - ConfiguraciÃ³n y cliente de Supabase
- `index.js` - AplicaciÃ³n principal y dashboard
- `areas.js` - GestiÃ³n de Ã¡reas y centros de trabajo
- `eval_int.js` - Sistema de evaluaciones ergonÃ³micas

**ðŸ“ Archivos HTML:**
- `index.html` - PÃ¡gina de login y dashboard
- `areas.html` - GestiÃ³n de Ã¡reas y centros
- `centro-trabajo.html` - Vista detallada de centros
- `eval_int.html` - Formulario de evaluaciÃ³n inicial

### globals.js - Sistema Centralizado

**Funciones principales organizadas en mÃ³dulos:**

```javascript
// ConfiguraciÃ³n global
window.ERGOConfig = {
    USE_SUPABASE: true,
    SUPABASE_URL: '...',
    SUPABASE_ANON_KEY: '...',
    SESSION_DURATION: 8 * 60 * 60 * 1000, // 8 horas
    ACTIVITY_CHECK_INTERVAL: 60000 // 1 minuto
}

// Sistema de autenticaciÃ³n y permisos
window.ERGOAuth = {
    getCurrentUser(),
    hasPermission(action),
    checkPermissionAndShowError(action),
    checkSession(),
    updateActivity(),
    logout(reason),
    redirectToLogin(),
    applyPermissionControls(),
    hideCreateButtons(),
    hideDeleteButtons(),
    setupSessionMonitoring()
}

// Utilidades generales
window.ERGOUtils = {
    generateShortId(),
    formatDate(dateString),
    formatDateTime(dateString),
    showToast(message, type),
    getScoreColor(score),
    getScoreCategory(score),
    sanitizeFilename(filename),
    debounce(func, wait)
}

// NavegaciÃ³n unificada
window.ERGONavigation = {
    getUrlParams(),
    getParam(paramName),
    buildUrl(basePath, params),
    navigateToAreas(areaId),
    navigateToWorkCenter(workCenterId, areaId, areaName, centerName, responsible),
    navigateToEvaluation(workCenterId, areaId, areaName, centerName, responsible),
    navigateToSpecificEvaluation(type, workCenterId, areaId, areaName, centerName, responsible)
}

// Manejo de almacenamiento
window.ERGOStorage = {
    setLocal(key, value),
    getLocal(key, defaultValue),
    removeLocal(key),
    setSession(key, value),
    getSession(key, defaultValue),
    removeSession(key),
    clearAll()
}

// Sistema de modales
window.ERGOModal = {
    open(modalId),
    close(modalId),
    setupCloseOnOverlay(modalId)
}

// Validaciones
window.ERGOValidation = {
    isValidEmail(email),
    isValidPhone(phone),
    isValidId(id),
    validateRequired(fields),
    clearValidationErrors()
}
```

---

## Funcionalidades Principales

### 1. Dashboard Principal (index.html)
- **Login seguro** con validaciÃ³n de usuarios
- **Tablas dinÃ¡micas** con datos de Supabase
- **Indicadores KPI** por Ã¡rea
- **Top 10 centros con mÃ¡s riesgo**
- **NavegaciÃ³n directa** a Ã¡reas y centros especÃ­ficos

### 2. GestiÃ³n de Ãreas (areas.html)
- **CRUD completo** de Ã¡reas (segÃºn permisos)
- **Vista de centros** por Ã¡rea
- **Scores en tiempo real** con colores por riesgo
- **NavegaciÃ³n breadcrumb** mejorada

### 3. Centros de Trabajo (centro-trabajo.html)
- **Vista detallada** del centro
- **GestiÃ³n de fotos** (mÃ¡x. 5 por centro)
- **Notas y observaciones**
- **Evaluaciones especÃ­ficas** (REBA, RULA, OCRA, NIOSH)
- **ExportaciÃ³n a PDF** completa

### 4. Sistema de Evaluaciones (eval_int.html)
- **Cuestionario ergonÃ³mico** completo
- **CÃ¡lculo automÃ¡tico** de scores de riesgo
- **Recomendaciones de mÃ©todos** especÃ­ficos
- **Guardado hÃ­brido** Supabase/localStorage

---

## Mejoras Implementadas en v2.0

### ðŸš€ Refactoring Completo
- **EliminaciÃ³n de cÃ³digo duplicado** (~800 lÃ­neas menos)
- **Funciones centralizadas** en globals.js
- **Consistencia** en toda la aplicaciÃ³n
- **Mantenimiento simplificado**

### ðŸ” Sistema de Seguridad Mejorado
- **Sesiones con expiraciÃ³n** (8 horas + inactividad 30 min)
- **Monitoreo de actividad** automÃ¡tico
- **Permisos granulares** por funciÃ³n
- **RedirecciÃ³n segura** entre pÃ¡ginas

### ðŸ“Š OptimizaciÃ³n de Rendimiento
- **Tabla scores_resumen** para consultas rÃ¡pidas
- **Consultas hÃ­bridas** Supabase/localStorage
- **Carga asÃ­ncrona** de datos
- **Manejo eficiente** de errores

### ðŸŽ¨ Experiencia de Usuario
- **NavegaciÃ³n unificada** con URLs limpias
- **Modales centralizados** con manejo consistente
- **Toasts informativos** para feedback
- **Breadcrumbs inteligentes**

### ðŸ› ï¸ Mantenibilidad
- **Funciones puras** y testeables
- **SeparaciÃ³n de responsabilidades**
- **ConfiguraciÃ³n centralizada**
- **DocumentaciÃ³n completa**

---

## Flujos de Trabajo

### Login y AutenticaciÃ³n
```mermaid
graph TD
    A[Usuario ingresa credenciales] --> B[ValidaciÃ³n en Supabase]
    B --> C{Â¿Usuario vÃ¡lido?}
    C -->|SÃ­| D[Crear sesiÃ³n + permisos]
    C -->|No| E[Mostrar error]
    D --> F[Redirigir a dashboard]
    E --> A
```

### EvaluaciÃ³n ErgonÃ³mica
```mermaid
graph TD
    A[Seleccionar centro] --> B[Cargar evaluaciÃ³n existente o nueva]
    B --> C[Completar cuestionario]
    C --> D[Calcular score automÃ¡tico]
    D --> E[Mostrar categorÃ­a de riesgo]
    E --> F[Recomendar mÃ©todos especÃ­ficos]
    F --> G[Guardar en Supabase + localStorage]
```

### GestiÃ³n de Permisos
```mermaid
graph TD
    A[Usuario logueado] --> B[Verificar rango]
    B --> C{Â¿Rango 1?}
    C -->|SÃ­| D[Mostrar todos los botones]
    B --> E{Â¿Rango 2?}
    E -->|SÃ­| F[Ocultar botones de ediciÃ³n/eliminaciÃ³n]
    B --> G{Â¿Rango 3?}
    G -->|SÃ­| H[Solo mostrar botones de lectura]
```