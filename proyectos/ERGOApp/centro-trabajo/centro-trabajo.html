<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Trabajo</title>
    <link rel="stylesheet" href="../componentes/globals.css">
    <link rel="stylesheet" href="./centro-trabajo.css">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.11/purify.min.js" 
        integrity="sha512-7VVGl2bh7eYo6iZo5deNVxT3wLGRjGFHpN5eLPbfGdvqNGJiJMhZzMBiLTz6qy5F4FYdRdqG0OdSqQQfXCMxA==" 
        crossorigin="anonymous" 
        referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.min.js" defer></script>
    <script src="../componentes/globals.js" defer></script>
    <script src="../componentes/auth-client.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.1/dist/browser-image-compression.js" defer></script>
    <script src="../componentes/supabase-config.js" defer></script>
    <script src="../componentes/header-component.js" defer></script>
</head>
<body>
    <div class="container">
        <!-- Header del centro -->
<header class="centro-header">
    <nav class="breadcrumb">
        <a href="../areas.html">Ãreas</a>
        <span class="separator">/</span>
        <a href="areas.html#area-ZI90HE" id="breadcrumb-area">asd</a>
        <span class="separator">/</span>
        <span id="breadcrumb-centro">asd</span>
    </nav>
    
    <div class="centro-title">
        <div class="centro-info">
            <div class="title-block">
                <h1 id="centro-name">asd</h1>
                <p id="centro-responsable" class="centro-responsable">Responsable: asda</p>
            </div>

            <div id="evaluacion-inicial-info" class="details-grid">
                <div class="detail-item">
                    <span class="detail-label">Fecha</span>
                    <span id="eval-fecha" class="detail-value">Pendiente</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Sugerencias</span>
                    <span id="eval-sugeridas" class="detail-value">Realizar evaluaciÃ³n inicial</span>
                </div>
            </div>
        </div>

        <div id="environmental-card" class="environmental-card info-card" onclick="abrirModalCondiciones()">
            <div class="environmental-item" id="display-condicion-iluminacion">
                <span class="label">IluminaciÃ³n:</span>
                <span class="value" id="condicion-iluminacion-valor">300</span>
            </div>
            <div class="environmental-item" id="display-condicion-temperatura">
                <span class="label">Temperatura:</span>
                <span class="value" id="condicion-temperatura-valor">36.5</span>
            </div>
            <div class="environmental-item" id="display-condicion-ruido">
                <span class="label">Ruido:</span>
                <span class="value" id="condicion-ruido-valor">75</span>
            </div>
            <div class="environmental-item hidden" id="display-condicion-personal">
                <span class="label">Personal Exp.:</span>
                <span class="value" id="condicion-personal-valor">--</span>
            </div>
            <div class="environmental-item" id="display-condicion-art">
                <span class="label">ART:</span>
                <span class="value" id="condicion-art-valor">--</span>
            </div>
            <div class="environmental-item hidden" id="display-condicion-cargas">
                <span class="label">Manejo Cargas:</span>
                <span class="value" id="condicion-cargas-valor">--</span>
            </div>
            <div class="environmental-item hidden" id="display-condicion-puestos">
                <span class="label">Puestos:</span>
                <span class="value" id="condicion-puestos-valor">--</span>
            </div>
        </div>
            
        <div class="score-container info-card">
            <div>
                <div id="score-value" class="score-value" style="color: rgb(107, 114, 128);">--</div>
                <div id="score-category" class="score-category">Sin evaluar</div>
            </div>
            
            <button id="btn-toggle-status" class="btn btn-status-toggle" onclick="toggleCenterStatus()">Cerrar Centro</button>

            <div class="evaluacion-link-container">
                <span class="evaluacion-link-title">ğŸ“Š EvaluaciÃ³n Inicial</span>
                
                <button class="btn btn-ghost btn-sm" onclick="abrirEvaluacion()">Ver EvaluaciÃ³n</button>
                <button class="btn btn-ghost btn-sm" onclick="exportarPDFCompleto()" style="background-color: rgba(33, 49, 139, 0.779); color: aliceblue; font-weight: 600;">PDF</button>
            </div>
        </div>
    </div>
</header>

        <!-- Contenido principal -->
        <main class="content-sections">
            <!-- SecciÃ³n de Fotos -->
            <section class="section-card">
                <div class="section-header">
                    <h2 class="section-title">ğŸ“¸ Fotos del Centro</h2>
                    <span class="fotos-counter">
                        <span id="fotos-count">0</span>/5 fotos
                    </span>
                </div>
                
                <div class="fotos-grid" id="fotos-grid">
                    <!-- Los slots de fotos se generan dinÃ¡micamente -->
                </div>
                
                <div class="fotos-info" id="fotos-info-texto">
                    Haz clic en un slot vacÃ­o para agregar una foto (mÃ¡ximo 5)
                    <br>
                    <small>Formatos: JPG, PNG, WEBP (mÃ¡x. 5MB cada una)</small>
                </div>
                
                <input type="file" id="foto-input" accept="image/*" style="display: none;" multiple>
            </section>

            </section>

<section class="section-card">
    <div class="section-header">
        <h2 class="section-title">ğŸ’¬ Comentarios Generales</h2>
    </div>
    <div class="comentarios-container">
        <div id="comentarios-generales" style="height: 150px;" placeholder="AÃ±ade comentarios sobre el centro de trabajo en general..." rows="4"></div>
        <div class="comentarios-actions">
<button id="btn-comentarios" class="btn btn-secondary">Editar Comentario</button>    </div>
</section>
<section class="section-card">

            <!-- SecciÃ³n de Evaluaciones EspecÃ­ficas -->
            <section class="section-card">
                <div class="section-header">
                    <h2 class="section-title">Actividades</h2>
                <button class="btn btn-primary" onclick="abrirModalActividad()">+ AGREGAR ACTIVIDAD</button>
                </div>
                
                <div id="evaluaciones-container" class="evaluaciones-list">
                    <div class="empty-evaluations">
                        <p>No hay evaluaciones especÃ­ficas realizadas</p>
                        <small>Agrega evaluaciones REBA, RULA, OCRA, NIOSH segÃºn corresponda</small>
                    </div>
                </div>
            </section>

            <!-- SecciÃ³n de Notas -->
            <section class="section-card">
                <div class="section-header">
                    <h2 class="section-title">ğŸ“ Notas y Observaciones</h2>
                    <button id="btn-abrir-modal-nota" class="btn btn-primary" onclick="openNotaModal()">
                        + AGREGAR NOTA
                    </button>
                    <span class="count-badge" id="notas-count">0 notas</span>
                </div>
                
                <div id="notas-container" class="notas-list">
                    <div class="empty-notas">
                        <p>No hay notas registradas</p>
                        <small>Usa el botÃ³n "AGREGAR NOTA" para documentar observaciones</small>
                    </div>
                </div>
            </section>

            <!-- Botones de acciÃ³n -->
            <section class="section-card">
                <div class="section-header">
                    <h2 class="section-title">ğŸ“„ Acciones</h2>
                </div>
                
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="exportarPDFCompleto()">
                        ğŸ“„ Exportar PDF Completo
                    </button>
                    <button class="btn btn-ghost" onclick="volverACentros()">
                        â† Volver a Centros
                    </button>
                </div>
            </section>
            
        </main>
    </div>

        <div id="modal-comentarios" class="modal">
        <div class="modal-overlay" onclick="cerrarModalComentarios()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Comentarios Generales</h3>
                <button class="modal-close" onclick="cerrarModalComentarios()"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <!-- El editor Quill vivirÃ¡ aquÃ­ dentro -->
                <div id="comentarios-editor-modal" style="height: 250px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="cerrarModalComentarios()">Cancelar</button>
                <button type="button" id="btn-guardar-comentarios-modal" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Modal para agregar nota -->
<div id="modal-crear-evaluacion" class="modal-nota">
    <div class="modal-nota-content">
        <h3 id="modal-crear-evaluacion-titulo" style="margin-bottom: 1rem;">Nueva EvaluaciÃ³n</h3>
        
        <div class="form-group">
            <label for="nueva-evaluacion-titulo">TÃ­tulo o Identificador</label>
            <input 
                type="text" 
                id="nueva-evaluacion-titulo" 
                placeholder="Ej. REBA - Operador de Prensa"
                style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: var(--border-radius-md);"
            >
            <small style="color: var(--gray-500); font-size: 0.75rem; margin-top: 4px; display: block;">
                Dale un nombre Ãºnico para identificar esta evaluaciÃ³n fÃ¡cilmente.
            </small>
        </div>
        
        <div style="display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: flex-end;">
            <button class="btn btn-ghost" onclick="cerrarModalCrearEvaluacion()">Cancelar</button>
            <button class="btn btn-primary" onclick="confirmarCreacionEvaluacion()">Crear EvaluaciÃ³n</button>
        </div>
    </div>
</div>


<!-- Modal para agregar Actividades -->
<div id="modal-actividad" class="modal">
    <div class="modal-overlay" onclick="cerrarModalActividad()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-actividad-titulo">Nueva Actividad</h3>
            <button class="modal-close" onclick="cerrarModalActividad()"><span>&times;</span></button>
        </div>
        
        <form id="form-actividad" onsubmit="event.preventDefault(); guardarActividad();">
            <div class="modal-body">
                <input type="hidden" id="actividad-id">

<div class="form-grid">
    <div>
        <div class="form-group">
            <label for="actividad-nombre">Nombre de la actividad</label>
            <input type="text" id="actividad-nombre" class="input-field" required>
        </div>
        <div >
            <div class="form-group" style="width: 400px;">
                <label for="actividad-metodo">MÃ©todo de EvaluaciÃ³n</label>
                <div class="input-with-button">
                    <select id="actividad-metodo" class="input-field">
                        <option value="" disabled selected>Selecciona un mÃ©todo...</option>
                        <option value="REBA">REBA (Cuerpo completo)</option>
                        <option value="RULA">RULA (Miembros superiores)</option>
                        <option value="OCRA">OCRA (Movimientos repetitivos)</option>
                        <option value="NIOSH">NIOSH (Levantamiento de cargas)</option>
                    </select>
                    <button id="btn-evaluar-metodo" type="button" class="btn btn-secondary" disabled>Evaluar</button>
                </div>
            </div>
                <div class="form-group">
                    <label>Manejo de cargas manuales</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="radio-label">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="cargas_manuales" value="si"> SÃ­
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="radio-label">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="cargas_manuales" value="no"> No
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small class="help-text">Marque sÃ­, si las cargas son mayores a 3kg de forma repetitiva</small>
                  <div id="evaluar-cargas-container" class="evaluar-cargas-wrapper" style="display: none;">
                      <button type="button" class="btn btn-primary" onclick="window.location.href='../componentes/pages/cargas_manuales.html'">Evaluar</button>
                  </div>
        </div>


    </div>

    <div>
         <div class="form-group">
            <label id="tipo-analisis-label">Tipo de AnÃ¡lisis</label>
            <div class="input-with-button">
                <div class="btn-group" id="tipo-analisis-group" role="group" aria-labelledby="tipo-analisis-label">
                    <button type="button" class="btn-toggle" data-value="EJA">EJA</button>
                    <button type="button" class="btn-toggle" data-value="WS">WS</button>
                </div>
                <button id="btn-evaluar-tipo" type="button" class="btn btn-secondary">Evaluar</button>
            </div>
        </div>
    </div>
</div> 
                <div id="seccion-fotos-actividad" class="form-group full-width" style="display: none;">
                    <label>Fotos de la Actividad</label>
                    <div class="fotos-grid" id="fotos-grid-actividad">
                        </div>
                    <button type="button" class="btn btn-secondary" style="width: 100%; margin-top: 1rem;" onclick="document.getElementById('foto-input-actividad').click();">
                        + Cargar Fotos
                    </button>
                </div>
                <input type="file" id="foto-input-actividad" accept="image/*" style="display: none;" multiple>

                <div class="form-group full-width">
                    <label for="actividad-comentarios">Comentarios</label>
                    <div id="actividad-comentarios" class="input-field" rows="4"></div>
                </div>

                <div class="form-group full-width">
                    <label for="actividad-recomendaciones">Recomendaciones</label>
                    <div id="actividad-recomendaciones" class="input-field" rows="4"></div>
                </div>
            </div> <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="cerrarModalActividad()">Cancelar</button>
                <button type="submit" id="modal-actividad-btn-guardar" class="btn btn-primary">Guardar</button>
            </div>
        </form>
    </div>
</div>

    <!-- Modal para vista completa de fotos -->
<div id="foto-modal" class="foto-modal">
    <div class="foto-modal-content">
        <button class="foto-modal-close" onclick="closeFotoModal()">Ã—</button>
        <button class="foto-modal-controls foto-modal-prev" onclick="prevFoto()" id="foto-prev-btn">â€¹</button>
        <button class="foto-modal-controls foto-modal-next" onclick="nextFoto()" id="foto-next-btn">â€º</button>
        <div class="foto-modal-counter" id="foto-counter">1 / 1</div>
        
        <img id="foto-modal-image" class="foto-modal-image" src="" alt="Foto ampliada">
        <div class="foto-modal-info" id="foto-modal-info">
            <div id="foto-modal-name">Nombre de la foto</div>
        </div>
    </div>
</div>

<div id="closed-state-banner" class="notification is-warning" style="display: none;">
        ğŸ”’ **Modo de solo lectura:** Este centro de trabajo estÃ¡ cerrado. Para realizar cambios, un administrador debe abrirlo.
    </div>

    <div id="modal-password-confirm" class="modal">
        <div class="modal-overlay" onclick="closePasswordConfirmModal()"></div>
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="modal-password-title">Confirmar AcciÃ³n</h3>
                <button class="modal-close" onclick="closePasswordConfirmModal()"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <p id="modal-password-message" style="margin-bottom: 1rem; color: var(--gray-600);"></p>
                <div class="form-group">
                    <label for="password-confirm-input">Ingresa tu contraseÃ±a</label>
                    <input type="password" id="password-confirm-input" class="input-field" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="closePasswordConfirmModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmPasswordAction()">Confirmar</button>
            </div>
        </div>
    </div>

        <div id="modal-nota" class="modal-nota">
            <div class="modal-nota-content">
                <h3 style="margin-bottom: 1rem;">Agregar Nueva Nota</h3>
                <div name="note_content" id="nota-texto" placeholder="Escribe tus observaciones aquÃ­..."></div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem; justify-content: flex-end;">
                    <button class="btn btn-ghost" onclick="closeNotaModal()">Cancelar</button>
                    <button class="btn btn-primary" onclick="guardarNota()">Guardar Nota</button>
                </div>
            </div>
        </div>

<div id="modal-condiciones" class="modal" role="dialog" aria-modal="true">
    <div class="modal-overlay" onclick="cerrarModalCondiciones()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Condiciones Ambientales</h3>
            <button class="modal-close" onclick="cerrarModalCondiciones()"><span>&times;</span></button>
        </div>
        <form id="form-condiciones" onsubmit="event.preventDefault(); guardarCondicionesAmbientales();">
            <div class="modal-body">
                <div class="form-group-inline">
                    <label for="condiciones-iluminacion-input">IluminaciÃ³n (lux)</label>
                    <input type="number" step="any" id="condiciones-iluminacion-input" class="input-field">
                    <label class="na-label">
                        <input type="checkbox" id="condiciones-iluminacion-na"> N/A
                    </label>
                </div>
                <div class="form-group-inline">
                    <label for="condiciones-temperatura-input">Temperatura (Â°C)</label>
                    <input type="number" step="any" id="condiciones-temperatura-input" class="input-field">
                    <label class="na-label">
                        <input type="checkbox" id="condiciones-temperatura-na"> N/A
                    </label>
                </div>
                <div class="form-group-inline">
                    <label for="condiciones-ruido-input">Ruido (dB)</label>
                    <input type="number" step="any" id="condiciones-ruido-input" class="input-field">
                    <label class="na-label">
                        <input type="checkbox" id="condiciones-ruido-na"> N/A
                    </label>
                </div>
                <div class="form-group-inline">
                    <label for="condiciones-personal-input">Personal Expuesto</label>
                    <input type="number" step="any" id="condiciones-personal-input" class="input-field">
                    <label class="na-label">
                        <input type="checkbox" id="condiciones-personal-na"> N/A
                    </label>
                </div>
                <div class="form-group-inline">
                    <label>Manejo de cargas manuales</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="manejo_cargas" value="si" id="condiciones-cargas-si"> SÃ­
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="manejo_cargas" value="no" id="condiciones-cargas-no"> No
                        </label>
                    </div>
                    <small style="color: var(--gray-500); font-size: 0.75rem;">Marque sÃ­, si las cargas son mayores a 3kg de forma repetitiva</small>
                </div>
                <div class="form-group-inline">
                    <label for="condiciones-puestos-input">Puestos involucrados</label>
                    <select id="condiciones-puestos-input" class="input-field">
                        <option value="">Seleccionar puesto...</option>
                    </select>
                    <label class="na-label">
                        <input type="checkbox" id="condiciones-puestos-na"> N/A
                    </label>
                </div>
                 <div class="form-group">
                    <label for="condiciones-art-input">ART</label>
                    <input type="text" id="condiciones-art-input" class="input-field">
                </div>               
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="cerrarModalCondiciones()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>
<script src="centro-trabajo.js" defer></script>
<script src="centro-trabajo-init.js" defer></script>
<script src="centro-trabajo-data.js" defer></script>
<script src="centro-trabajo-actions.js" defer></script>
    
</body>
</html>