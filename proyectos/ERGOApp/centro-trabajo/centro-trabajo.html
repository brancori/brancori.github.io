<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Trabajo</title>
    <link rel="stylesheet" href="../componentes/globals.css">
    <link rel="stylesheet" href="./centro-trabajo.css">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.11/purify.min.js" 
        integrity="sha512-7VVGl2bh7eYo6iZo5deNVxT3wLGRjGFHpN5eLPbfGdvqNGJiJMhZzMBiLTz6qy5F4FYdRdqG0OdSqQQfXCMxA==" 
        crossorigin="anonymous" 
        referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.min.js" defer></script>
    <script src="../componentes/globals.js" defer></script>
    <script src="../componentes/auth-client.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.1/dist/browser-image-compression.js" defer></script>
    <script src="../componentes/supabase-config.js" defer></script>
    <script src="../componentes/header-component.js" defer></script>
</head>
<body>
    <div class="container">
        <!-- Header del centro -->
<header class="centro-header">
    <nav class="breadcrumb">
        <a href="../areas.html">√Åreas</a>
        <span class="separator">/</span>
        <a href="areas.html#area-ZI90HE" id="breadcrumb-area">asd</a>
        <span class="separator">/</span>
        <span id="breadcrumb-centro">asd</span>
    </nav>
    
    <div class="centro-title">
        <div class="centro-info">
            <div class="title-block">
                <h1 id="centro-name">asd</h1>
                <p id="centro-responsable" class="centro-responsable">Responsable: asda</p>
            </div>

            <div id="evaluacion-inicial-info" class="details-grid">
                <div class="detail-item">
                    <span class="detail-label">Fecha</span>
                    <span id="eval-fecha" class="detail-value">Pendiente</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Sugerencias</span>
                    <span id="eval-sugeridas" class="detail-value">Realizar evaluaci√≥n inicial</span>
                </div>
            </div>
        </div>

        <div id="environmental-card" class="environmental-card info-card" onclick="abrirModalCondiciones()">
            <div class="environmental-item" id="display-condicion-iluminacion">
                <span class="label">Iluminaci√≥n:</span>
                <span class="value" id="condicion-iluminacion-valor">300</span>
            </div>
            <div class="environmental-item" id="display-condicion-temperatura">
                <span class="label">Temperatura:</span>
                <span class="value" id="condicion-temperatura-valor">36.5</span>
            </div>
            <div class="environmental-item" id="display-condicion-ruido">
                <span class="label">Ruido:</span>
                <span class="value" id="condicion-ruido-valor">75</span>
            </div>
            <div class="environmental-item hidden" id="display-condicion-personal">
                <span class="label">Personal Exp.:</span>
                <span class="value" id="condicion-personal-valor">--</span>
            </div>
            <div class="environmental-item" id="display-condicion-art">
                <span class="label">ART:</span>
                <span class="value" id="condicion-art-valor">--</span>
            </div>
            <div class="environmental-item hidden" id="display-condicion-cargas">
                <span class="label">Manejo Cargas:</span>
                <span class="value" id="condicion-cargas-valor">--</span>
            </div>
            <div class="environmental-item hidden" id="display-condicion-puestos">
                <span class="label">Puestos:</span>
                <span class="value" id="condicion-puestos-valor">--</span>
            </div>
        </div>
            
<div class="score-container info-card">
                <div>
                <div id="score-value" class="score-value" style="color: rgb(107, 114, 128);">--</div>
                <div id="score-category" class="score-category">Sin evaluar</div>
            </div>
<button id="btn-toggle-status" class="btn btn-status-toggle" onclick="toggleCenterStatus()">Cerrar Centro</button>
<div class="evaluacion-link-container">
    <span class="evaluacion-link-title">üìä Evaluaci√≥n Inicial</span>

    <button class="btn btn-ghost btn-sm" onclick="abrirEvaluacion()">Ver Evaluaci√≥n</button>

    <!-- Bot√≥n 1: PDF Evaluaci√≥n Inicial (SIN inline styles) -->
    <button class="btn btn-ghost btn-sm"
            onclick="exportarPDFCompleto()"> 
        PDF Eval. Inicial 
    </button>

    <!-- Bot√≥n 2: PDF Reporte Consolidado (CON ID y clase correcta, SIN inline styles) -->
<button id="btn-ver-reporte-principal" type="button"
        class="btn btn-primary btn-sm" 
        style="margin-top: 5px;"
        disabled>
    PDF Consolidado
</button>

</div>
</div>
    </div>
</header>

        <!-- Contenido principal -->
        <main class="content-sections">
            <!-- Secci√≥n de Fotos -->
            <section class="section-card">
                <div class="section-header">
                    <h2 class="section-title">üì∏ Fotos del Centro</h2>
                    <span class="fotos-counter">
                        <span id="fotos-count">0</span>/5 fotos
                    </span>
                </div>
                
                <div class="fotos-grid" id="fotos-grid">
                    <!-- Los slots de fotos se generan din√°micamente -->
                </div>
                
                <div class="fotos-info" id="fotos-info-texto">
                    Haz clic en un slot vac√≠o para agregar una foto (m√°ximo 5)
                    <br>
                    <small>Formatos: JPG, PNG, WEBP (m√°x. 5MB cada una)</small>
                </div>
                
                <input type="file" id="foto-input" accept="image/*" style="display: none;" multiple>
            </section>

            </section>

<section class="section-card">
    <div class="section-header">
        <h2 class="section-title">üí¨ Comentarios Generales</h2>

    </div>
    <div class="comentarios-container">
        <div id="comentarios-generales" style="height: 150px;" placeholder="A√±ade comentarios sobre el centro de trabajo en general..." rows="4"></div>
        <div class="comentarios-actions">
<button id="btn-comentarios" class="btn btn-secondary">Editar Comentario</button>    </div>

</section>
<section class="section-card">

            <!-- Secci√≥n de Evaluaciones Espec√≠ficas -->
            <section class="section-card">
                <div class="section-header">
                    <h2 class="section-title">Actividades</h2>
                    <button class="btn btn-primary" onclick="abrirModalActividad()">+ AGREGAR ACTIVIDAD</button>                </div>
                
                <div id="evaluaciones-container" class="evaluaciones-list">
                    <div class="empty-evaluations">
                        <p>No hay evaluaciones espec√≠ficas realizadas</p>
                        <small>Agrega evaluaciones REBA, RULA, OCRA, NIOSH seg√∫n corresponda</small>
                    </div>
                </div>
            </section>

            <!-- Secci√≥n de Notas -->
            <section class="section-card">
                <div class="section-header">
                    <h2 class="section-title">üìù Notas y Observaciones</h2>
                    <button id="btn-abrir-modal-nota" class="btn btn-primary" onclick="openNotaModal()">
                        + AGREGAR NOTA
                    </button>
                    <span class="count-badge" id="notas-count">0 notas</span>
                </div>
                
                <div id="notas-container" class="notas-list">
                    <div class="empty-notas">
                        <p>No hay notas registradas</p>
                        <small>Usa el bot√≥n "AGREGAR NOTA" para documentar observaciones</small>
                    </div>
                </div>
            </section>

            <!-- Botones de acci√≥n -->
            <section class="section-card">
                <div class="section-header">
                    <h2 class="section-title">üìÑ Acciones</h2>
                </div>
                
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="exportarPDFCompleto()">
                        üìÑ Exportar PDF Completo
                    </button>
                    <button class="btn btn-ghost" onclick="volverACentros()">
                        ‚Üê Volver a Centros
                    </button>
                </div>
            </section>
            
        </main>
    </div>

        <div id="modal-comentarios" class="modal">
        <div class="modal-overlay" onclick="cerrarModalComentarios()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Comentarios Generales</h3>
                <button class="modal-close" onclick="cerrarModalComentarios()"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <!-- El editor Quill vivir√° aqu√≠ dentro -->
                <div id="comentarios-editor-modal" style="height: 250px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="cerrarModalComentarios()">Cancelar</button>
                <button type="button" id="btn-guardar-comentarios-modal" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Modal para agregar nota -->
<div id="modal-crear-evaluacion" class="modal-nota">
    <div class="modal-nota-content">
        <h3 id="modal-crear-evaluacion-titulo" style="margin-bottom: 1rem;">Nueva Evaluaci√≥n</h3>
        
        <div class="form-group">
            <label for="nueva-evaluacion-titulo">T√≠tulo o Identificador</label>
            <input 
                type="text" 
                id="nueva-evaluacion-titulo" 
                placeholder="Ej. REBA - Operador de Prensa"
                style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: var(--border-radius-md);"
            >
            <small style="color: var(--gray-500); font-size: 0.75rem; margin-top: 4px; display: block;">
                Dale un nombre √∫nico para identificar esta evaluaci√≥n f√°cilmente.
            </small>
        </div>
        
        <div style="display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: flex-end;">
            <button class="btn btn-ghost" onclick="cerrarModalCrearEvaluacion()">Cancelar</button>
            <button class="btn btn-primary" onclick="confirmarCreacionEvaluacion()">Crear Evaluaci√≥n</button>
        </div>
    </div>
</div>


<div id="modal-actividad" class="modal">
    <div class="modal-overlay" onclick="cerrarModalActividad()"></div>
    <div class="modal-content">
        <form id="form-actividad" onsubmit="event.preventDefault(); guardarActividad();">

            <div class="modal-header">
                <h3 id="modal-actividad-titulo">Nuevo Hallazgo</h3>
                <button type="button" class="modal-close" onclick="cerrarModalActividad()"><span>&times;</span></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="actividad-id">

                <div class="form-grid">
                    <div>
                        <div class="form-group">
                            <label for="actividad-nombre">Tarea Espec√≠fica (Hallazgo)</label>
                            <input type="text" id="actividad-nombre" class="input-field" required>
                        </div>
                        <div class="form-group">
                            <label for="puesto_involucrado">Puesto Involucrado</label>
                            <input type="text" id="puesto_involucrado" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="grupo_riesgo">Grupo de Riesgo</label>
                            <input type="text" id="grupo_riesgo" class="input-field">
                        </div>
                        <div class="form-group" style="width: 400px;">
                            <label for="actividad-metodo">Evaluaci√≥n Espec√≠fica</label>
                            <div class="input-with-button">
                                <select id="actividad-metodo" class="input-field">
                                    <option value="" disabled selected>Selecciona un m√©todo...</option>
                                    <option value="REBA">REBA (Cuerpo completo)</option>
                                    <option value="RULA">RULA (Miembros superiores)</option>
                                    <option value="OCRA">OCRA (Movimientos repetitivos)</option>
                                    <option value="NIOSH">NIOSH (Levantamiento de cargas)</option>
                                    <option value="NOM036">NOM-036 (Cargas Manuales)</option>
                                    <option value="EJA">EJA (Johnson)</option>
                                </select>
                                <button id="btn-evaluar-metodo" type="button" class="btn btn-secondary" disabled>Evaluar</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="tipo_control">Tipo de Control</label>
                            <input type="text" id="tipo_control" class="input-field" placeholder="Ej. Ingenier√≠a, Administrativo...">
                        </div>
                        <div class="form-group">
                            <label for="art">ART (An√°lisis de Riesgo)</label>
                            <input type="text" id="art" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="responsable">Responsable</label>
                            <input type="text" id="responsable" class="input-field">
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="descripcion_riesgo">Descripci√≥n del Riesgo</label>
                            <textarea id="descripcion_riesgo" class="input-field" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="cumplimiento">Cumplimiento</label>
                            <input type="text" id="cumplimiento" class="input-field" placeholder="Ej. NOM-036, NOM-001...">
                        </div>
                        <div class="form-group">
                            <label for="nivel_riesgo">Nivel de Riesgo Identificado</label>
                            <input type="text" id="nivel_riesgo" class="input-field" placeholder="Este campo se llenar√° con la evaluaci√≥n">
                        </div>
                        <div class="form-group">
                            <label for="nuevo_nivel_riesgo">Nuevo Nivel de Riesgo (Esperado)</label>
                            <input type="text" id="nuevo_nivel_riesgo" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="accion">Acci√≥n</label>
                            <input type="text" id="accion" class="input-field">
                        </div>
                        <div class="form-group">
                            <label id="tipo-analisis-label">Tipo de An√°lisis</label>
                            <div class="input-with-button">
                                <div class="btn-group" id="tipo-analisis-group" role="group" aria-labelledby="tipo-analisis-label">
                                    <button type="button" class="btn-toggle" data-value="EJA">EJA</button>
                                    <button type="button" class="btn-toggle" data-value="WS">WS</button>
                                </div>
                                <button id="btn-evaluar-tipo" type="button" class="btn btn-secondary">Evaluar</button>
                            </div>
                        </div>
                    </div>
                </div> <div class="form-group full-width">
                    <label for="descripcion_detallada">Descripci√≥n Detallada del Hallazgo</label>
                    <textarea id="descripcion_detallada" class="input-field" rows="3"></textarea>
                </div>
                <div id="seccion-fotos-actividad" class="form-group full-width" style="display: none;">
                    <label>Fotos de la Actividad</label>
                    <div class="fotos-grid" id="fotos-grid-actividad"></div>
                    <button type="button" class="btn btn-secondary" style="width: 100%; margin-top: 1rem;" onclick="document.getElementById('foto-input-actividad').click();">
                        + Cargar Fotos
                    </button>
                </div>
                <input type="file" id="foto-input-actividad" accept="image/*" style="display: none;" multiple>
                <div class="form-group full-width">
                    <label for="actividad-comentarios">Comentarios</label>
                    <div id="actividad-comentarios" class="input-field" rows="4"></div>
                </div>
                <div class="form-group full-width">
                    <label for="actividad-recomendaciones">Medida de Control Propuesta</label>
                    <div id="actividad-recomendaciones" class="input-field" rows="4"></div>
                </div>
            </div> <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="cerrarModalActividad()">Cancelar</button>
                <button type="submit" id="modal-actividad-btn-guardar" class="btn btn-primary">Crear Hallazgo</button>
            </div>

        </form>
    </div>
</div>

    <!-- Modal para vista completa de fotos -->
<div id="foto-modal" class="foto-modal">
    <div class="foto-modal-content">
        <button class="foto-modal-close" onclick="closeFotoModal()">√ó</button>
        <button class="foto-modal-controls foto-modal-prev" onclick="prevFoto()" id="foto-prev-btn">‚Äπ</button>
        <button class="foto-modal-controls foto-modal-next" onclick="nextFoto()" id="foto-next-btn">‚Ä∫</button>
        <div class="foto-modal-counter" id="foto-counter">1 / 1</div>
        
        <img id="foto-modal-image" class="foto-modal-image" src="" alt="Foto ampliada">
        <div class="foto-modal-info" id="foto-modal-info">
            <div id="foto-modal-name">Nombre de la foto</div>
        </div>
    </div>
</div>

<div id="closed-state-banner" class="notification is-warning" style="display: none;">
        üîí **Modo de solo lectura:** Este centro de trabajo est√° cerrado. Para realizar cambios, un administrador debe abrirlo.
    </div>

    <div id="modal-password-confirm" class="modal">
        <div class="modal-overlay" onclick="closePasswordConfirmModal()"></div>
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="modal-password-title">Confirmar Acci√≥n</h3>
                <button class="modal-close" onclick="closePasswordConfirmModal()"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <p id="modal-password-message" style="margin-bottom: 1rem; color: var(--gray-600);"></p>
                <div class="form-group">
                    <label for="password-confirm-input">Ingresa tu contrase√±a</label>
                    <input type="password" id="password-confirm-input" class="input-field" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="closePasswordConfirmModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmPasswordAction()">Confirmar</button>
            </div>
        </div>
    </div>

        <div id="modal-nota" class="modal-nota">
            <div class="modal-nota-content">
                <h3 style="margin-bottom: 1rem;">Agregar Nueva Nota</h3>
                <div name="note_content" id="nota-texto" placeholder="Escribe tus observaciones aqu√≠..."></div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem; justify-content: flex-end;">
                    <button class="btn btn-ghost" onclick="closeNotaModal()">Cancelar</button>
                    <button class="btn btn-primary" onclick="guardarNota()">Guardar Nota</button>
                </div>
            </div>
        </div>

<div id="modal-condiciones" class="modal" role="dialog" aria-modal="true">
    <div class="modal-overlay" onclick="cerrarModalCondiciones()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Condiciones Ambientales</h3>
            <button class="modal-close" onclick="cerrarModalCondiciones()"><span>&times;</span></button>
        </div>
        <form id="form-condiciones" onsubmit="event.preventDefault(); guardarCondicionesAmbientales();">
            <div class="modal-body">
                <div class="form-group-inline">
                    <label for="condiciones-iluminacion-input">Iluminaci√≥n (lux)</label>
                    <input type="number" step="any" id="condiciones-iluminacion-input" class="input-field">
                    <label class="na-label">
                        <input type="checkbox" id="condiciones-iluminacion-na"> N/A
                    </label>
                </div>
                <div class="form-group-inline">
                    <label for="condiciones-temperatura-input">Temperatura (¬∞C)</label>
                    <input type="number" step="any" id="condiciones-temperatura-input" class="input-field">
                    <label class="na-label">
                        <input type="checkbox" id="condiciones-temperatura-na"> N/A
                    </label>
                </div>
                <div class="form-group-inline">
                    <label for="condiciones-ruido-input">Ruido (dB)</label>
                    <input type="number" step="any" id="condiciones-ruido-input" class="input-field">
                    <label class="na-label">
                        <input type="checkbox" id="condiciones-ruido-na"> N/A
                    </label>
                </div>
                <div class="form-group-inline">
                    <label for="condiciones-personal-input">Personal Expuesto</label>
                    <input type="number" step="any" id="condiciones-personal-input" class="input-field">
                    <label class="na-label">
                        <input type="checkbox" id="condiciones-personal-na"> N/A
                    </label>
                </div>
                <div class="form-group-inline">
                    <label>Manejo de cargas manuales</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="manejo_cargas" value="si" id="condiciones-cargas-si"> S√≠
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="manejo_cargas" value="no" id="condiciones-cargas-no"> No
                        </label>
                    </div>
                    <small style="color: var(--gray-500); font-size: 0.75rem;">Marque s√≠, si las cargas son mayores a 3kg de forma repetitiva</small>
                </div>
                <div class="form-group-inline">
                    <label for="condiciones-puestos-input">Puestos involucrados</label>
                    <select id="condiciones-puestos-input" class="input-field">
                        <option value="">Seleccionar puesto...</option>
                    </select>
                    <label class="na-label">
                        <input type="checkbox" id="condiciones-puestos-na"> N/A
                    </label>
                </div>
                 <div class="form-group">
                    <label for="condiciones-art-input">ART</label>
                    <input type="text" id="condiciones-art-input" class="input-field">
                </div>               
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" onclick="cerrarModalCondiciones()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>

<script src="centro-trabajo.js" defer></script>
<script src="centro-trabajo-init.js" defer></script>
<script src="centro-trabajo-data.js" defer></script>
<script src="centro-trabajo-actions.js" defer></script>
    
</body>
</html>