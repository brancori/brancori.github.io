<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="./reporte_dictamen.css">

    <title>Dictamen Ergon√≥mico</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <script src="../componentes/globals.js" defer></script>
    <script src="../componentes/supabase-config.js" defer></script>
    

    
</head>
<body>

    <!-- BARRA DE HERRAMIENTAS -->
    <div class="toolbar">
        <div class="logo-watermark">
            <img src="./siresi.jpg" alt="Logo" style="max-width: 100%; height: auto;">
        </div>
        <button class="btn-save" onclick="guardarBorrador()">üíæ Guardar Borrador</button>
        <button class="btn-export" onclick="exportarPDF()">üìÑ Exportar PDF</button>
        <button class="btn-preview" onclick="toggleEditMode()">üëÅÔ∏è Vista Previa</button>
    </div>

    <div class="container">
        
        <!-- PORTADA -->
        <div class="page portada">
            <!-- TODO: Reemplazar con logo real de J&J -->


            <h1>Dictamen Ergon√≥mico</h1> 
            <h2>Johnson and Johnson</h2>

            <div class="portada-info">
                <div class="info-row">
                    <span class="info-label">Centro de Trabajo:</span>  
                    <span class="info-value" id="centro-trabajo">[Cargando...]</span>
                </div>
                <div class="info-row">
                    <span class="info-label">√Årea:</span> 
                    <span class="info-value" id="area-nombre">[Cargando...]</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Fecha de realizaci√≥n:</span> 
                    <input type="date" class="editable-field" id="fecha-realizacion" 
                           style="width: 100%; border: none; padding: 0.5rem; text-align: center;">
                </div>
                <div class="info-row">
                    <span class="info-label">Evaluador:</span> 
                    <span class="info-value">Lic. Brandon Cortes Rivera
                </div>
                <div class="info-row">
                    <span class="info-label">Tareas Observadas:</span> 
                    <div class="editable-field" contenteditable="true" id="tareas-observadas"
                         style="width: 100%; min-height: 60px;">
                    </div>
                </div>
                        <div class="logo-watermark">
            <img src="./siresi.jpg" alt="Logo" style="max-width: 100%; height: auto;">
        </div>
            </div>
        </div>

        <!-- P√ÅGINA 2: RESUMEN EJECUTIVO -->
        <div class="page">
            <div class="page-content">
                <h1 class="section-title" id="titulo-centro">[NOMBRE DEL CENTRO DE TRABAJO]</h1>

                <!-- TODO: Aqu√≠ se puede agregar el score general del centro si se desea -->
                
                <div class="editor-toolbar">
                    <button onclick="formatText('bold')"><b>B</b></button>
                    <button onclick="formatText('italic')"><i>I</i></button>
                    <button onclick="formatText('underline')"><u>U</u></button>
                    <button onclick="formatText('insertUnorderedList')">‚Ä¢ Lista</button>
                    <button onclick="formatText('insertOrderedList')">1. Lista</button>
                </div>
                <div class="rich-editor" contenteditable="true" id="resumen-ejecutivo">
                    <p>La evaluaci√≥n inicial arroj√≥ una puntuaci√≥n de <strong><span id="resumen-score">[Score]</span>%</strong>. Este score es <span id="resumen-adjetivo">[elevado/bajo]</span> se deriva principalmente del siguiente hallazgo:</p>
                    <ul id="lista-hallazgos-resumen">
                        <li><strong>Hallazgo Principal 1:</strong> Descripci√≥n del hallazgo y su impacto.</li>
                    </ul>
                    <p><strong>Plan de Acci√≥n y Proyecci√≥n de Reducci√≥n del Score:</strong></p>
                    <p>Se proponen las siguientes soluciones de ingenier√≠a y administrativas para abordar directamente los hallazgos:</p>
                    <ol>
                        <li>Acci√≥n correctiva 1</li>
                        <li>Acci√≥n correctiva 2</li>
                        <li>Acci√≥n correctiva 3</li>
                    </ol>
                    <p><strong>Impacto Cuantitativo en el Score:</strong></p>
                    <p>La implementaci√≥n de estas dar√° un nuevo Score Proyectado = [X]% (Riesgo Bajo). Esto representa una reducci√≥n de m√°s del [X]% en el score de riesgo.</p>
                </div>
            </div>
        </div>

        <!-- P√ÅGINA 3: DICTAMEN ERGON√ìMICO -->
        <div class="page">
            <div class="page-content">
                <h1 class="section-title">Dictamen Ergon√≥mico: √Årea de <span id="area-dictamen">[√Årea]</span></h1>

                <h2 class="subsection-number">I. Introducci√≥n y Objetivo del An√°lisis</h2>
                
                <div class="editor-toolbar">
                    <button onclick="formatText('bold')"><b>B</b></button>
                    <button onclick="formatText('italic')"><i>I</i></button>
                    <button onclick="formatText('underline')"><u>U</u></button>
                    <button onclick="formatText('insertUnorderedList')">‚Ä¢ Lista</button>
                    <button onclick="formatText('insertOrderedList')">1. Lista</button>
                </div>
                <div class="rich-editor" contenteditable="true" id="introduccion">
                    <p><strong>Contexto del An√°lisis:</strong> Este dictamen se enmarca en el programa proactivo de ergonom√≠a de la organizaci√≥n, cuyo principio es "ajustar el trabajo a las personas y no la persona al trabajo".</p>
                    <p><strong>Objetivo Espec√≠fico:</strong> El objetivo es identificar, analizar y documentar los factores de riesgo ergon√≥mico.</p>
                    <p><strong>Alcance de la Evaluaci√≥n:</strong> La evaluaci√≥n inicial arroj√≥ una puntuaci√≥n de riesgo [nivel] del [X]%.</p>
                </div>

                <h2 class="subsection-number">Evidencia Fotogr√°fica General del Centro</h2>
                <div class="centro-fotos-grid" id="centro-fotos-grid-container">
                    <p style="color: #666; font-style: italic; grid-column: 1 / -1;">
                        Cargando fotos generales del centro...
                    </p>
                </div>
                <h2 class="subsection-number">II. An√°lisis de Condiciones Ergon√≥micas y de Dise√±o del √Årea de Trabajo</h2>

                <!-- CONTENEDOR DE HALLAZGOS -->
                <div id="hallazgos-container">
                    <!-- Los hallazgos se cargar√°n din√°micamente aqu√≠ desde Supabase -->
                    <p style="color: #666; font-style: italic;">Cargando hallazgos desde la base de datos...</p>
                </div>

            </div>
        </div>

        <!-- P√ÅGINA 4: MATRIZ Y CONCLUSIONES -->
        <div class="page">
            <div class="page-content">
                <h2 class="subsection-title">Tabla 1: Matriz de Incumplimientos y Acciones</h2>

                <!-- TODO: Esta tabla se llenar√° con datos de actividades desde Supabase -->
                <table class="matriz-table" id="matriz-table">
                    <thead>
                        <tr>
                            <th style="width: 20%;">Actividad<br>(√Årea Cr√≠tica)</th>
                            <th style="width: 30%;">Descripci√≥n del Incumplimiento y Riesgo Derivado</th>
                            <th style="width: 30%;">Medida de Control Propuesta (Jerarqu√≠a)</th>
                            <th style="width: 20%;">Justificaci√≥n (Principio de Dise√±o)</th>
                        </tr>
                    </thead>
                    <tbody id="matriz-tbody">
                        <tr>
                            <td colspan="4" style="text-align: center; color: #666;">
                                Cargando datos desde la base de datos...
                            </td>
                        </tr>
                    </tbody>
                </table>

                <h2 class="subsection-number" style="margin-top: 3rem;">III. Conclusiones</h2>
                
                <div class="editor-toolbar">
                    <button onclick="formatText('bold')"><b>B</b></button>
                    <button onclick="formatText('italic')"><i>I</i></button>
                    <button onclick="formatText('underline')"><u>U</u></button>
                    <button onclick="formatText('insertUnorderedList')">‚Ä¢ Lista</button>
                    <button onclick="formatText('insertOrderedList')">1. Lista</button>
                </div>
                <div class="rich-editor" contenteditable="true" id="conclusiones">
                    <p>El an√°lisis demuestra que [Nombre del √Årea] opera con incumplimientos [cr√≠ticos/moderados] de los principios de dise√±o ergon√≥mico. El score de [X]% no es solo un n√∫mero, sino el reflejo de un entorno de trabajo que [descripci√≥n del impacto].</p>
                    <p>Se requiere una intervenci√≥n [integral/prioritaria/gradual] para abordar los siguientes aspectos cr√≠ticos:</p>
                    <ul>
                        <li>Aspecto cr√≠tico 1</li>
                        <li>Aspecto cr√≠tico 2</li>
                        <li>Aspecto cr√≠tico 3</li>
                    </ul>
                </div>

                <h2 class="subsection-number">IV. Plan de Acci√≥n y Recomendaciones</h2>
                
                <div class="editor-toolbar">
                    <button onclick="formatText('bold')"><b>B</b></button>
                    <button onclick="formatText('italic')"><i>I</i></button>
                    <button onclick="formatText('underline')"><u>U</u></button>
                    <button onclick="formatText('insertUnorderedList')">‚Ä¢ Lista</button>
                    <button onclick="formatText('insertOrderedList')">1. Lista</button>
                </div>
                <div class="rich-editor" contenteditable="true" id="plan-accion">
                    <p><strong>A. Controles de Ingenier√≠a (Prioridad Alta)</strong></p>
                    <ol>
                        <li><strong>Acci√≥n 1:</strong> Descripci√≥n detallada de la acci√≥n correctiva.</li>
                        <li><strong>Acci√≥n 2:</strong> Descripci√≥n detallada de la acci√≥n correctiva.</li>
                        <li><strong>Acci√≥n 3:</strong> Descripci√≥n detallada de la acci√≥n correctiva.</li>
                    </ol>
                    <p><strong>B. Controles Administrativos (Implementaci√≥n Inmediata)</strong></p>
                    <ol>
                        <li><strong>Protocolo de Pausas Activas:</strong> Establecer un procedimiento.</li>
                        <li><strong>Capacitaci√≥n y Comunicaci√≥n:</strong> Realizar sesiones.</li>
                    </ol>
                </div>
            </div>
        </div>

    </div>

    <script>
// ============================================
// VARIABLES GLOBALES
// ============================================
let editMode = true;
let workCenterId = null;
let areaId = null;
let hallazgosData = [];

// ============================================
// INICIALIZACI√ìN
// ============================================
document.addEventListener('DOMContentLoaded', async () => {
    // Obtener par√°metros de la URL
    const urlParams = new URLSearchParams(window.location.search);
    workCenterId = urlParams.get('workCenter');
    areaId = urlParams.get('area');
    const centerName = decodeURIComponent(urlParams.get('centerName') || 'Centro de Trabajo');
    const areaName = decodeURIComponent(urlParams.get('areaName') || '√Årea');
    
    // Establecer fecha actual por defecto
    document.getElementById('fecha-realizacion').valueAsDate = new Date();

    await cargarDatosIniciales();
});

// ============================================
// CARGA DE DATOS
// ============================================

async function cargarDatosIniciales() {
    try {
        // Cargar informaci√≥n del centro de trabajo
        const { data: centro, error: errorCentro } = await dataClient.supabase
            .from('work_centers')
            .select('name')
            .eq('id', workCenterId)
            .single();
        
        if (errorCentro) throw errorCentro;

        // Cargar informaci√≥n del √°rea
        const { data: area, error: errorArea } = await dataClient.supabase
            .from('areas')
            .select('name') 
            .eq('id', areaId)
            .single();
        
        if (errorArea) throw errorArea;

        const { data: evaluaciones, error: errorEvals } = await dataClient.supabase
            .from('evaluaciones') 
            .select('score_final, categoria_riesgo, created_at')
            .eq('work_center_id', workCenterId)
            .order('created_at', { ascending: false }); // Obtener la m√°s reciente

        if (errorEvals) throw errorEvals;

        let score = '--';
        let categoria = 'Sin evaluar';

        if (evaluaciones && evaluaciones.length > 0) {
            const eval_ = evaluaciones[0]; // Tomar la m√°s reciente
            score = parseFloat(eval_.score_final || '0').toFixed(2);
            categoria = eval_.categoria_riesgo || 'Sin evaluar';
        }

        const resumenScoreEl = document.getElementById('resumen-score');
        const resumenRiesgoEl = document.getElementById('resumen-riesgo');
        const resumenAdjetivoEl = document.getElementById('resumen-adjetivo'); // <-- A√ëADE ESTA L√çNEA

        if (resumenScoreEl) resumenScoreEl.textContent = score;
        if (resumenRiesgoEl) resumenRiesgoEl.textContent = categoria;
        
        // A√ëADE ESTE BLOQUE para el adjetivo
        if (resumenAdjetivoEl) {
            // Esto quita "Riesgo " y deja solo "Alto", "Moderado", etc.
            const adjetivo = categoria.replace('Riesgo ', '');
            resumenAdjetivoEl.textContent = adjetivo;
        }

        // Actualizar encabezados (con verificaci√≥n)
        const centroTrabajoEl = document.getElementById('centro-trabajo');
        const areaNombreEl = document.getElementById('area-nombre');
        const tituloCentroEl = document.getElementById('titulo-centro');
        const areaDictamenEl = document.getElementById('area-dictamen');

        if (centroTrabajoEl) centroTrabajoEl.textContent = centro.name.toUpperCase();
        if (areaNombreEl) areaNombreEl.textContent = area.name;
        if (tituloCentroEl) tituloCentroEl.textContent = centro.name.toUpperCase();
        if (areaDictamenEl) areaDictamenEl.textContent = area.name;

        await cargarFotosCentro(workCenterId);
        
        // Cargar hallazgos (actividades)
        const { data: actividades, error: errorActividades } = await dataClient.supabase
            .from('actividades')
            .select('*')
            .eq('work_center_id', workCenterId)
            .order('created_at', { ascending: true });
        
        if (errorActividades) throw errorActividades;

        hallazgosData = actividades;

        const tareasContainer = document.getElementById('tareas-observadas');
        
        if (tareasContainer) {
            if (actividades && actividades.length > 0) {
                // Mapea los nombres y los une con un salto de l√≠nea (<br>)
                const tareasHtml = actividades.map(act => 
                        (act.nombre || 'Actividad sin nombre') // Obtiene el nombre
                    ).join('<br>'); // Une cada nombre con un salto de l√≠nea
                
                // Reemplaza el contenido
                tareasContainer.innerHTML = tareasHtml; 
            } else {
                // Mensaje si no hay actividades (sin <ul>)
                tareasContainer.innerHTML = 'No se encontraron tareas observadas.';
            }
        }
      renderizarHallazgos(actividades);
      renderizarMatriz(actividades);
      renderizarResumen(actividades);
   } catch (error) {
      console.error('Error cargando datos:', error);
      alert('Error al cargar los datos del centro de trabajo: ' + error.message);
      const urlParams = new URLSearchParams(window.location.search);
      const centerName = decodeURIComponent(urlParams.get('centerName') || 'Centro');
      const areaName = decodeURIComponent(urlParams.get('areaName') || '√Årea');
      cargarDatosPrueba(centerName, areaName);
   }

   // üëá Esta l√≠nea debe ir AQU√ç, fuera del try
   await cargarDictamenComplemento(workCenterId);
}

// ============================================
// CARGA DE FOTOS
// ============================================

async function cargarFotosCentro(workCenterId) {
    const container = document.getElementById('centro-fotos-grid-container');
    if (!container) return;

    try {
        // Usamos la tabla 'fotos_centros'
        const { data: fotos, error } = await dataClient.supabase
            .from('fotos_centros')
            .select('foto_url, foto_name')
            .eq('work_center_id', workCenterId);

        if (error) throw error;

        if (fotos && fotos.length > 0) {
            container.innerHTML = ''; // Limpiar mensaje de carga
            fotos.forEach(foto => {
                // Usamos el bucket 'fotos-centros'
                const { data: publicUrlData } = dataClient.supabase
                    .storage
                    .from('fotos-centros')
                    .getPublicUrl(foto.foto_url);

                const item = document.createElement('div');
                item.className = 'centro-foto-item';
                item.innerHTML = `
                    <img src="${publicUrlData.publicUrl}" alt="${foto.foto_name || 'Evidencia del centro'}">
                `;
                container.appendChild(item);
            });
        } else {
            container.innerHTML = '<p style="color: #666; font-style: italic;">No se encontraron fotos generales para este centro.</p>';
        }
    } catch (error) {
        console.error('Error cargando fotos del centro:', error);
        container.innerHTML = '<p style="color: red; font-style: italic;">Error al cargar las fotos del centro.</p>';
    }
}

async function cargarFotosHallazgo(hallazgoId, container) {
    // 1. Buscamos el contenedor padre de toda la secci√≥n
    const parentSection = container.closest('.evidencia-section');

    try {
        // Cargar fotos desde la tabla fotos_actividades
        const { data: fotos, error } = await dataClient.supabase
            .from('fotos_actividades')
            .select('storage_path, file_name')
            .eq('actividad_id', hallazgoId);

        if (error) throw error;

        if (fotos && fotos.length > 0) {
            // --- SI HAY FOTOS ---
            // Se comporta como antes: limpia el "Cargando..." y muestra las im√°genes.
            container.innerHTML = ''; // Limpiar placeholders
            fotos.forEach(foto => {
                const { data: publicUrlData } = dataClient.supabase
                    .storage
                    .from('fotos')
                    .getPublicUrl(foto.storage_path);

                const item = document.createElement('div');
                // NOTA: Usas 'evidencia-placeholder', podr√≠as cambiarlo a 'evidencia-item'
                item.className = 'evidencia-placeholder'; 
                item.innerHTML = `<img src="${publicUrlData.publicUrl}" alt="${foto.file_name || 'Evidencia'}" style="width: 100%; height: 100%; object-fit: cover;">`;
                container.appendChild(item);
            });
        } else {
            // --- NO HAY FOTOS ---
            // Ocultamos la secci√≥n completa (el div.evidencia-section)
            if (parentSection) {
                parentSection.style.display = 'none';
            }
        }
    } catch (error) {
        console.error('Error cargando fotos del hallazgo:', error);
        // --- SI HAY ERROR ---
        // Tambi√©n ocultamos la secci√≥n para no mostrar un bloque roto.
        if (parentSection) {
            parentSection.style.display = 'none';
        }
    }
}

// ============================================
// RENDERIZADO DE HALLAZGOS
// ============================================

function renderizarHallazgos(hallazgos) {
    const container = document.getElementById('hallazgos-container');
    container.innerHTML = '';

    hallazgos.forEach((hallazgo, index) => {
        const letra = String.fromCharCode(65 + index); // A, B, C...
        
        const hallazgoDiv = document.createElement('div');
        hallazgoDiv.className = 'hallazgo-item';
        hallazgoDiv.innerHTML = `
            <h3 class="subsection-title">${letra}. ${hallazgo.nombre}</h3>
            
            <div class="hallazgo-field">
                <div class="hallazgo-field-label">Hallazgo:</div>
                <div class="hallazgo-content">
                    ${hallazgo.descripcion_detallada || '[Descripci√≥n no disponible]'}
                </div>
            </div>

            <div class="hallazgo-field">
                <div class="hallazgo-field-label">An√°lisis y Riesgos Derivados:</div>
                <div class="editor-toolbar">
                    <button onclick="formatText('bold')"><b>B</b></button>
                    <button onclick="formatText('italic')"><i>I</i></button>
                    <button onclick="formatText('underline')"><u>U</u></button>
                    <button onclick="formatText('insertUnorderedList')">‚Ä¢ Lista</button>
                    <button onclick="formatText('insertOrderedList')">1. Lista</button>
                </div>
                <div class="rich-editor hallazgo-content" contenteditable="true" 
                     data-hallazgo-id="${hallazgo.id}" data-field="analisis_riesgo">
                    <p>Esta situaci√≥n obliga a los empleados a adoptar posturas forzadas y sostenidas. Describir el impacto espec√≠fico, las consecuencias documentadas, y la severidad del riesgo derivado de este hallazgo.]</p>
                </div>
            </div>

            <div class="hallazgo-field">
                <div class="hallazgo-field-label">Tarea Espec√≠fica:</div>
                <div class="editable-field" contenteditable="true" 
                     data-hallazgo-id="${hallazgo.id}" data-field="tarea_especifica"
                     style="min-height: 30px; padding: 0.5rem;">
                    [Agregar tarea espec√≠fica]
                </div>
            </div>

            <div class="hallazgo-field">
                <div class="hallazgo-field-label">Evaluaci√≥n Espec√≠fica:</div>
                <div class="editable-field" contenteditable="true" 
                     data-hallazgo-id="${hallazgo.id}" data-field="evaluacion_especifica"
                     style="min-height: 30px; padding: 0.5rem;">
                    [Agregar m√©todo de evaluaci√≥n: EJA, RULA, NIOSH, etc.]
                </div>
            </div>

            <!-- Evidencia Fotogr√°fica -->
            <div class="evidencia-section">
                <h4 style="margin: 0 0 1rem 0; font-size: 11pt;">Evidencia Fotogr√°fica</h4>
                <div class="evidencia-grid" data-hallazgo-id="${hallazgo.id}">
                    <div class="evidencia-placeholder">Cargando...</div>
                </div>
                <p style="margin-top: 0.5rem; font-size: 9pt; color: #666;">
                </p>
            </div>

            <!-- Evaluaciones Espec√≠ficas (EJA, RULA, NIOSH) -->
            <div class="evidencia-section" style="margin-top: 1rem;">
                <h4 style="margin: 0 0 1rem 0; font-size: 11pt;">Resultados de Evaluaciones</h4>
                <div data-hallazgo-id="${hallazgo.id}" class="evaluaciones-resultados">
                    <p style="font-size: 10pt; color: #666;">
                        <strong>Grupo de Riesgo:</strong> ${hallazgo.grupo_riesgo || 'N/A'}<br>
                        <strong>Nivel de Riesgo Inicial:</strong> ${hallazgo.nivel_riesgo || 'N/A'}<br>
                        <strong>Nivel de Riesgo Proyectado:</strong> ${hallazgo.nuevo_nivel_riesgo || 'N/A'}
                    </p>
                </div>
            </div>
        `;
        
        const fotosContainer = hallazgoDiv.querySelector('.evidencia-grid');
        if (fotosContainer) {
            cargarFotosHallazgo(hallazgo.id, fotosContainer);
        }
        container.appendChild(hallazgoDiv);
    });
}

// ============================================
// RENDERIZADO DE MATRIZ
// ============================================

function renderizarMatriz(hallazgos) {
    const tbody = document.getElementById('matriz-tbody');
    if (!tbody) return;
    tbody.innerHTML = '';

    if (!hallazgos || hallazgos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">No se encontraron hallazgos.</td></tr>';
        return;
    }

    hallazgos.forEach(hallazgo => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${hallazgo.nombre || 'Sin t√≠tulo'}</strong></td>
            <td>${hallazgo.descripcion_riesgo || '[Sin descripci√≥n]'}</td>
            <td>${hallazgo.recomendaciones || '[Sin recomendaciones]'}</td>
            <td>
                <div class="editable-field" contenteditable="true" 
                     data-hallazgo-id="${hallazgo.id}" data-field="justificacion"
                     style="min-height: 50px; padding: 0.5rem;">
                    [Agregar justificaci√≥n basada en principios de dise√±o ergon√≥mico]
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// ============================================
// RENDERIZADO DE RESUMEN EJECUTIVO
// ============================================

function renderizarResumen(hallazgos) {
    const ul = document.getElementById('lista-hallazgos-resumen');
    if (!ul) return;

    ul.innerHTML = ''; // Limpiar la lista

    if (hallazgos && hallazgos.length > 0) {
        hallazgos.forEach((hallazgo, index) => {
            const li = document.createElement('li');
            
            const titulo = hallazgo.nombre ? hallazgo.nombre.replace(/<[^>]*>/g, "") : 'Hallazgo sin t√≠tulo';

            li.innerHTML = `
                <strong>${titulo}:</strong>
                <div class="editable-field" contenteditable="true" 
                     data-hallazgo-id="${hallazgo.id}" 
                     data-field="resumen_impacto"
                     style="display: inline; padding: 0 4px; min-width: 200px; font-style: italic; background-color: #fffef7;">
                    [Descripci√≥n del hallazgo y su impacto]
                </div>
            `;
            ul.appendChild(li);
        });
    } else {
        ul.innerHTML = '<li>No se encontraron hallazgos para mostrar en el resumen.</li>';
    }
}

// ============================================
// DATOS DE PRUEBA
// ============================================

function cargarDatosPrueba(centerName, areaName) { 
    document.getElementById('centro-trabajo').textContent = centerName.toUpperCase();
    document.getElementById('area-nombre').textContent = areaName;
    document.getElementById('titulo-centro').textContent = centerName.toUpperCase();
    document.getElementById('area-dictamen').textContent = areaName;

    // Datos de prueba
    hallazgosData = [
        {
            id: '1',
            nombre: 'Dise√±o de Estaciones de Trabajo y Posturas Forzadas',
            descripcion_detallada: 'La principal deficiencia del √°rea es la falta de un sistema ergon√≥mico integrado. Si bien algunos empleados disponen de perif√©ricos como teclados, ratones o un monitor extra, la falta total de soportes para elevar las pantallas y el dise√±o espacial deficiente anulan cualquier beneficio ergon√≥mico.',
            descripcion_riesgo: 'Mobiliario no ajustable y falta de soportes. Riesgo alto de TME en cuello, hombros y espalda.',
            recomendaciones: '(Ingenier√≠a) Sustituir por equipamiento ergon√≥mico totalmente ajustable (sillas, soportes).',
            grupo_riesgo: 'R02 - Posturas Forzadas',
            nivel_riesgo: 'ALTO',
            nuevo_nivel_riesgo: 'BAJO'
        },
        {
            id: '2',
            nombre: 'Ambiente F√≠sico: Iluminaci√≥n y Ruido',
            descripcion_detallada: 'El entorno de trabajo presenta condiciones ambientales adversas. La iluminaci√≥n var√≠a de 393 a 1643 lux, lo que indica zonas de penumbra y otras de deslumbramiento. El nivel de ruido medido es de 71.15 dB.',
            descripcion_riesgo: 'Iluminaci√≥n deficiente y ruido elevado. Riesgo de fatiga visual y estr√©s.',
            recomendaciones: '(Ingenier√≠a) Instalar controles de iluminaci√≥n (filtros, difusores) y atenuaci√≥n ac√∫stica.',
            grupo_riesgo: 'R07 - Entorno Visual y Pantallas',
            nivel_riesgo: 'MODERADO',
            nuevo_nivel_riesgo: 'BAJO'
        },
        {
            id: '3',
            nombre: 'Configuraci√≥n Espacial y Densidad Ocupacional',
            descripcion_detallada: 'La oficina contiene a 5 personas en un espacio reducido, lo que limita severamente la movilidad. No hay espacio suficiente para colaboradores altos y el alcance para colaboradores de menor estatura es deficiente.',
            descripcion_riesgo: 'Espacio reducido para 5 personas, poca movilidad. Riesgo de fatiga est√°tica y estr√©s por congesti√≥n.',
            recomendaciones: '(Ingenier√≠a) Realizar una reconfiguraci√≥n del layout de la oficina.',
            grupo_riesgo: 'R08 - Postura Est√°tica',
            nivel_riesgo: 'ALTO',
            nuevo_nivel_riesgo: 'BAJO'
        }
    ];

    renderizarHallazgos(hallazgosData);
    renderizarMatriz(hallazgosData);
    renderizarResumen(hallazgosData);
}

// ============================================
// FUNCIONES DE EDICI√ìN
// ============================================

function formatText(command) {
    document.execCommand(command, false, null);
}

function toggleEditMode() {
    editMode = !editMode;
    const editables = document.querySelectorAll('[contenteditable]');
    editables.forEach(el => {
        el.contentEditable = editMode;
    });
    
    const toolbars = document.querySelectorAll('.editor-toolbar');
    toolbars.forEach(tb => {
        tb.style.display = editMode ? 'flex' : 'none';
    });

    const btn = event.target;
    btn.textContent = editMode ? 'üëÅÔ∏è Vista Previa' : '‚úèÔ∏è Modo Edici√≥n';
}

// ============================================
// GUARDAR BORRADOR
// ============================================

async function guardarBorrador() {
    if (!workCenterId) {
        alert('‚ö†Ô∏è No se detect√≥ el centro de trabajo.');
        return;
    }

    const data = {
        work_center_id: workCenterId,
        fecha_realizacion: document.getElementById('fecha-realizacion')?.value || null,
        tareas_observadas: document.getElementById('tareas-observadas')?.innerHTML || null,
        resumen_ejecutivo: document.getElementById('resumen-ejecutivo')?.innerHTML || null,
        introduccion: document.getElementById('introduccion')?.innerHTML || null,
        conclusiones: document.getElementById('conclusiones')?.innerHTML || null,
        plan_accion: document.getElementById('plan-accion')?.innerHTML || null,
        updated_at: new Date().toISOString()
    };

    try {
        // Comprobamos si ya existe registro
        const { data: existing, error: selectError } = await dataClient.supabase
            .from('dictamen_complementos')
            .select('id')
            .eq('work_center_id', workCenterId)
            .maybeSingle();

        if (selectError) throw selectError;

        if (existing) {
            console.log('üìù Actualizando dictamen existente...');
            await dataClient.supabase
                .from('dictamen_complementos')
                .update(data)
                .eq('work_center_id', workCenterId);
        } else {
            console.log('üÜï Creando nuevo dictamen...');
            await dataClient.supabase
                .from('dictamen_complementos')
                .insert(data);
        }

        alert('‚úÖ Borrador guardado correctamente.');
    } catch (error) {
        console.error('‚ùå Error al guardar el dictamen:', error);
        alert('Error al guardar el borrador. Revisa la consola.');
    }
}



// ============================================
// EXPORTAR PDF
// ============================================

function exportarPDF() {
    // Ocultar toolbars antes de imprimir
    const toolbars = document.querySelectorAll('.editor-toolbar');
    toolbars.forEach(tb => tb.style.display = 'none');

    // Cambiar t√≠tulo del documento
    const centerName = document.getElementById('centro-trabajo').textContent;
    const areaName = document.getElementById('area-nombre').textContent;
    document.title = `Dictamen Ergon√≥mico - ${centerName} - ${areaName}`;

    // Abrir di√°logo de impresi√≥n
    window.print();

    // Restaurar toolbars si est√° en modo edici√≥n
    setTimeout(() => {
        if (editMode) {
            toolbars.forEach(tb => tb.style.display = 'flex');
        }
    }, 100);
}

// ============================================
// UTILIDADES
// ============================================

// Prevenir p√©rdida de datos
window.addEventListener('beforeunload', (e) => {
    if (editMode) {
        e.preventDefault();
        e.returnValue = '¬øSeguro que quieres salir? Los cambios no guardados se perder√°n.';
    }
});

// Atajos de teclado
document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + S para guardar
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        guardarBorrador();
    }
    
    // Ctrl/Cmd + P para exportar PDF
    if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
        e.preventDefault();
        exportarPDF();
    }
});


async function cargarDictamenComplemento(workCenterId) {
    try {
        const { data, error } = await dataClient.supabase
            .from('dictamen_complementos')
            .select('*')
            .eq('work_center_id', workCenterId)
            .maybeSingle();

        if (error) throw error;
        if (!data) {
            console.log('üÜï No hay dictamen complementario guardado a√∫n.');
            return;
        }

        console.log('üìÑ Dictamen complementario cargado:', data);

        // Fecha de realizaci√≥n
        if (data.fecha_realizacion && document.getElementById('fecha-realizacion'))
            document.getElementById('fecha-realizacion').value = data.fecha_realizacion;

        // Tareas observadas
        if (data.tareas_observadas && document.getElementById('tareas-observadas'))
            document.getElementById('tareas-observadas').innerHTML = data.tareas_observadas;

        // Resumen Ejecutivo
        if (data.resumen_ejecutivo && document.getElementById('resumen-ejecutivo'))
            document.getElementById('resumen-ejecutivo').innerHTML = data.resumen_ejecutivo;

        // Introducci√≥n y sus subpartes
        if (data.introduccion && document.getElementById('introduccion'))
            document.getElementById('introduccion').innerHTML = data.introduccion;
        else {
            const intro = document.getElementById('introduccion');
            if (intro) {
                if (data.contexto_analisis)
                    intro.querySelector('p:nth-child(1)').innerText = `Contexto del An√°lisis: ${data.contexto_analisis}`;
                if (data.objetivo_especifico)
                    intro.querySelector('p:nth-child(2)').innerText = `Objetivo Espec√≠fico: ${data.objetivo_especifico}`;
                if (data.alcance_evaluacion)
                    intro.querySelector('p:nth-child(3)').innerText = `Alcance de la Evaluaci√≥n: ${data.alcance_evaluacion}`;
            }
        }

        // Conclusiones
        if (data.conclusiones && document.getElementById('conclusiones'))
            document.getElementById('conclusiones').innerHTML = data.conclusiones;

        // Plan de Acci√≥n
        if (data.plan_accion && document.getElementById('plan-accion'))
            document.getElementById('plan-accion').innerHTML = data.plan_accion;

    } catch (err) {
        console.error('Error cargando dictamen complementario:', err);
    }
}

console.log('%cüìã Dictamen Ergon√≥mico Cargado', 'color: #0066cc; font-size: 14px; font-weight: bold;');
console.log('%cATAJOS DE TECLADO:', 'color: #666; font-weight: bold;');
console.log('Ctrl/Cmd + S: Guardar borrador');
console.log('Ctrl/Cmd + P: Exportar PDF');
console.log('%cTODO: Implementar integraciones con Supabase', 'color: #ff6600; font-weight: bold;');
    </script>
</body>
</html>