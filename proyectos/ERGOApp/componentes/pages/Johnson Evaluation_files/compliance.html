<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo de Cumplimiento - ERGOApp</title>
    
    <!-- PASO 1: Carga de scripts y estilos globales -->
    <!-- globals.js establece la configuración (ERGOConfig) -->
    <script src="../../globals.js"></script>
    
    <!-- =================================================================== -->
    <!-- CORRECCIÓN CRÍTICA: Añadir la librería principal de Supabase desde CDN -->
    <!-- Esta línea es esencial. Proporciona el objeto global 'supabase' que -->
    <!-- 'auth-client.js' y 'supabase-config.js' necesitan para funcionar. -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- =================================================================== -->

    <link rel="stylesheet" href="../../globals.css">

    <style>
        /* Estilos específicos para el Módulo de Compliance */
        body {
            background-color: var(--gray-50);
            color: var(--gray-800);
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
        }

        .compliance-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #fff;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
        }

        h1 {
            color: var(--primary-700);
            text-align: center;
            margin-bottom: 2rem;
        }

        /* Indicadores de Cumplimiento */
        .compliance-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
            text-align: center;
        }

        .indicator {
            padding: 1.5rem;
            border-radius: var(--border-radius-md);
            background-color: var(--gray-100);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .indicator:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        .indicator .value {
            font-size: 2.5rem;
            font-weight: 700;
            display: block;
        }
        .indicator .label {
            font-size: 0.9rem;
            color: var(--gray-600);
            text-transform: uppercase;
        }
        #total-value { color: var(--primary-600); }
        #completed-value { color: var(--green-600); }
        #pending-value { color: var(--yellow-600); }
        #not-applicable-value { color: var(--gray-500); }

        /* Lista de Requerimientos */
        .compliance-list .item {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            padding: 1rem 1.5rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius-md);
            margin-bottom: 1rem;
            background-color: #fff;
        }

        .item-content h3 {
            margin: 0 0 0.5rem;
            color: var(--gray-800);
            font-size: 1.1rem;
        }
        .item-content p {
            margin: 0;
            color: var(--gray-600);
            font-size: 0.9rem;
        }
        .item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .status-btn {
            padding: 0.5rem 1rem;
            border: 1px solid transparent;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-completado { background-color: var(--green-100); color: var(--green-800); }
        .btn-completado:hover { background-color: var(--green-200); }
        .btn-pendiente { background-color: var(--yellow-100); color: var(--yellow-800); }
        .btn-pendiente:hover { background-color: var(--yellow-200); }
        .btn-no-aplica { background-color: var(--gray-200); color: var(--gray-700); }
        .btn-no-aplica:hover { background-color: var(--gray-300); }

        /* Modal para Evidencias */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-xl);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .modal-header h2 { margin: 0; }
        .close-btn { font-size: 1.5rem; cursor: pointer; border: none; background: none; }
        .modal-body textarea {
            width: 100%;
            min-height: 100px;
            margin-bottom: 1rem;
        }
        .file-upload-wrapper {
            border: 2px dashed var(--gray-300);
            border-radius: var(--border-radius-md);
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            margin-bottom: 1rem;
        }
        .file-upload-wrapper:hover {
            border-color: var(--primary-500);
        }
        #file-name {
            font-style: italic;
            color: var(--gray-600);
        }
        .modal-footer {
            text-align: right;
        }

        /* Estilo para el loader */
        #loader {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: var(--primary-600);
        }
    </style>
</head>
<body>
    <header-component></header-component>

    <main class="compliance-container">
        <h1>Módulo de Cumplimiento Normativo</h1>

        <div class="compliance-indicators">
            <div class="indicator">
                <span class="value" id="total-value">-</span>
                <span class="label">Total Requerimientos</span>
            </div>
            <div class="indicator">
                <span class="value" id="completed-value">-</span>
                <span class="label">Completados</span>
            </div>
            <div class="indicator">
                <span class="value" id="pending-value">-</span>
                <span class="label">Pendientes</span>
            </div>
            <div class="indicator">
                <span class="value" id="not-applicable-value">-</span>
                <span class="label">No Aplica</span>
            </div>
        </div>
        
        <div id="loader">Cargando datos de cumplimiento...</div>
        <div class="compliance-list" id="compliance-list" style="display: none;">
            <!-- Los items de cumplimiento se insertarán aquí dinámicamente -->
        </div>
    </main>

    <!-- Modal para Cargar Evidencia -->
    <div id="evidence-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Cargar Evidencia</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="current-item-id">
                <label for="evidence-text">Comentarios:</label>
                <textarea id="evidence-text" class="form-input" placeholder="Añade un comentario sobre la evidencia..."></textarea>
                
                <label for="file-input">Subir Archivo:</label>
                <div class="file-upload-wrapper" onclick="document.getElementById('file-input').click();">
                    <p>Haz clic aquí para seleccionar un archivo</p>
                    <span id="file-name">Ningún archivo seleccionado</span>
                </div>
                <input type="file" id="file-input" style="display: none;">
            </div>
            <div class="modal-footer">
                <button class="modal-btn btn-cancel">Cancelar</button>
                <button class="modal-btn btn-save">Guardar</button>
            </div>
        </div>
    </div>
    
    <!-- Contenedor para las notificaciones (toast) -->
    <div id="toast-container"></div>

    <!-- PASO 2: Carga de scripts de dependencias -->
    <!-- Se cargan al final para no bloquear el renderizado del HTML. -->
    <!-- El orden es crucial: la librería de Supabase ya se cargó en el <head>. -->
    <script src="../../supabase-config.js"></script>
    <script src="../../auth-client.js"></script>
    <script src="../../header-component.js"></script>

    <!-- PASO 3: Lógica principal de la página de Cumplimiento -->
    <script>
    // Este objeto encapsula toda la lógica de la página de cumplimiento.
    const complianceApp = {
        supabase: null,
        data: [],
        elements: {},

        async init() {
            this.supabase = window.dataClient.supabase;
            this.cacheDOMElements();
            this.addEventListeners();
            await this.fetchData();
        },

        cacheDOMElements() {
            this.elements = {
                list: document.getElementById('compliance-list'),
                loader: document.getElementById('loader'),
                totalValue: document.getElementById('total-value'),
                completedValue: document.getElementById('completed-value'),
                pendingValue: document.getElementById('pending-value'),
                notApplicableValue: document.getElementById('not-applicable-value'),
                modal: document.getElementById('evidence-modal'),
                modalTitle: document.getElementById('modal-title'),
                closeBtn: document.querySelector('.close-btn'),
                cancelBtn: document.querySelector('.btn-cancel'),
                saveBtn: document.querySelector('.btn-save'),
                evidenceText: document.getElementById('evidence-text'),
                fileInput: document.getElementById('file-input'),
                fileName: document.getElementById('file-name'),
                currentItemId: document.getElementById('current-item-id')
            };
        },

        addEventListeners() {
            this.elements.list.addEventListener('click', (e) => {
                if (e.target.classList.contains('status-btn')) {
                    const id = parseInt(e.target.dataset.id);
                    const type = e.target.dataset.type;
                    this.handleStatusClick(id, type);
                }
            });
            this.elements.closeBtn.onclick = () => this.closeModal();
            this.elements.cancelBtn.onclick = () => this.closeModal();
            this.elements.saveBtn.onclick = () => this.saveEvidence();
            this.elements.fileInput.onchange = (e) => {
                this.elements.fileName.textContent = e.target.files[0] ? e.target.files[0].name : 'Ningún archivo seleccionado';
            };
        },
        
        async fetchData() {
            this.elements.loader.style.display = 'block';
            this.elements.list.style.display = 'none';

            try {
                const { data, error } = await this.supabase
                    .from('compliance_evaluations')
                    .select(`
                        id,
                        status,
                        comment,
                        evidence_file_path,
                        action_plan,
                        due_date,
                        requirement:compliance_requirements (id, name, content, category)
                    `)
                    .order('id', { ascending: true });

                if (error) {
                    throw error;
                }
                
                this.data = data.map(item => ({
                    evaluation_id: item.id,
                    status: item.status,
                    ...item.requirement
                }));

                this.render();

            } catch (error) {
                console.error('Error al cargar los datos de cumplimiento:', error);
                this.elements.loader.textContent = 'Error al cargar los datos. Por favor, intente de nuevo.';
            } finally {
                this.elements.loader.style.display = 'none';
                this.elements.list.style.display = 'block';
            }
        },

        render() {
            this.elements.list.innerHTML = '';
            if (this.data.length === 0) {
                this.elements.list.innerHTML = '<p>No hay requerimientos de cumplimiento para mostrar.</p>';
                return;
            }
            this.data.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'item';
                itemEl.innerHTML = `
                    <div class="item-content">
                        <h3>${item.name}</h3>
                        <p>${item.content}</p>
                    </div>
                    <div class="item-actions">
                        <button class="status-btn btn-completado" data-id="${item.evaluation_id}" data-type="completado">Completado</button>
                        <button class="status-btn btn-pendiente" data-id="${item.evaluation_id}" data-type="pendiente">Pendiente</button>
                        <button class="status-btn btn-no-aplica" data-id="${item.evaluation_id}" data-type="no_aplica">No Aplica</button>
                    </div>
                `;
                this.elements.list.appendChild(itemEl);
            });
            this.updateIndicators();
        },

        updateIndicators() {
            const total = this.data.length;
            const completed = this.data.filter(item => item.status === 'completado').length;
            const pending = this.data.filter(item => item.status === 'pendiente').length;
            const notApplicable = this.data.filter(item => item.status === 'no_aplica').length;

            this.elements.totalValue.textContent = total;
            this.elements.completedValue.textContent = completed;
            this.elements.pendingValue.textContent = pending;
            this.elements.notApplicableValue.textContent = notApplicable;
        },

        handleStatusClick(id, type) {
            const item = this.data.find(i => i.evaluation_id === id);
            if (!item) return;

            if (type === 'no_aplica') {
                this.updateStatus(id, type, {});
            } else {
                this.openModal(id, type);
            }
        },

        async updateStatus(id, status, evidence) {
            console.log(`Actualizando ID ${id} a estado ${status} con evidencia:`, evidence);
            
            const item = this.data.find(i => i.evaluation_id === id);
            if(item) {
                item.status = status;
                this.render();
            }
        },

        openModal(itemId, type) {
            const item = this.data.find(i => i.evaluation_id === itemId);
            this.elements.currentItemId.value = itemId;
            this.elements.modalTitle.textContent = `Evidencia para: ${item.name}`;
            this.elements.modal.dataset.actionType = type;
            this.elements.modal.style.display = 'flex';
        },

        closeModal() {
            this.elements.modal.style.display = 'none';
            this.elements.evidenceText.value = '';
            this.elements.fileInput.value = '';
            this.elements.fileName.textContent = 'Ningún archivo seleccionado';
            this.elements.currentItemId.value = '';
        },

        async saveEvidence() {
            const requirementId = parseInt(this.elements.currentItemId.value);
            const item = this.data.find(i => i.evaluation_id === requirementId);
            if (!item) return;

            const status = this.elements.modal.dataset.actionType;
            const texto = this.elements.evidenceText.value;
            const archivoInput = this.elements.fileInput.files[0];

            this.elements.saveBtn.textContent = 'Guardando...';
            this.elements.saveBtn.disabled = true;

            await this.updateStatus(item.evaluation_id, status, { texto, archivo: archivoInput });

            this.elements.saveBtn.textContent = 'Guardar';
            this.elements.saveBtn.disabled = false;
            this.closeModal();
        }
    };

    // PASO 4: Punto de entrada de la aplicación.
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // Guardián de Autenticación:
            if (!window.authClient) {
                throw new Error("El cliente de autenticación (authClient) no se ha cargado. Verifica el orden de los scripts.");
            }
            
            const { data: { session } } = await window.authClient.supabase.auth.getSession();

            if (!session) {
                console.warn('Usuario no autenticado. Redirigiendo a la página de inicio de sesión...');
                window.location.href = '../../index.html'; 
            } else {
                console.log('Sesión de usuario activa. Inicializando módulo de cumplimiento.');
                complianceApp.init();
            }
        } catch (error) {
            console.error("Error crítico durante la inicialización de la página de cumplimiento:", error);
            document.body.innerHTML = `<div style="text-align: center; padding: 50px;">
                                            <h1>Error al Cargar la Página</h1>
                                            <p>No se pudo inicializar el módulo. Por favor, contacte a soporte.</p>
                                            <p><i>${error.message}</i></p>
                                        </div>`;
        }
    });
    </script>
</body>
</html>

