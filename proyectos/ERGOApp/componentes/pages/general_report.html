<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte General de Cumplimiento</title>
    
    <link rel="stylesheet" href="../globals.css">
    <link rel="stylesheet" href="./general_report.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <script src="../globals.js"></script>
    <script src="../supabase-config.js"></script>
    <script src="../realtime-client.js"></script>
    <script src="../auth-client.js"></script> 
    <script src="../header-component.js"></script>

</head>
<body>
    <div class="main-container">
        <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-icon-wrapper" style="background-color: #eef2ff;">
                <i class="fa-solid fa-layer-group kpi-icon" style="color: #4f46e5;"></i>
            </div>
            <div class="kpi-content">
            <p class="kpi-title">Total de Áreas</p>
            <div id="total-areas-kpi" class="kpi-value">
                <span class="kpi-number">--</span>
                <div class="areas-detail-panel">
                    <ul class="areas-detail-list">
                        <!-- Se llenará dinámicamente -->
                    </ul>
                </div>
            </div>
        </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon-wrapper" style="background-color: #f0fdf4;">
                <i class="fa-solid fa-clipboard-check kpi-icon" style="color: #22c55e;"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-title">Centros Evaluados</p>
                <p id="centros-evaluados-kpi" class="kpi-value">--</p>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon-wrapper" style="background-color: #fffbeb;">
                <i class="fa-solid fa-tachometer-alt kpi-icon" style="color: #f59e0b;"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-title">Score Promedio General</p>
                <p id="score-promedio-kpi" class="kpi-value">--</p>
            </div>
        </div>
         <div class="kpi-card">
            <div class="kpi-icon-wrapper" style="background-color: #fef2f2;">
                <i class="fa-solid fa-bolt kpi-icon" style="color: #ef4444;"></i>
            </div>
            <div class="kpi-content">
                <p class="kpi-title">Actividades Totales</p>
                <p id="total-actividades-kpi" class="kpi-value">--</p>
            </div>
        </div>
    </div>
         <div class="dashboard-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Distribución de Centros de Trabajo</h3>
                    <button class="expand-btn" title="Ampliar gráfica">
                        <i class="fa-solid fa-expand"></i>
                    </button>
                </div>
                <p class="chart-subtitle">Porcentaje del total de centros que representa cada área.</p>
                <div class="chart-container">
                    <canvas id="areasDistributionChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Actividades por Área</h3>
                    <button class="expand-btn" title="Ampliar gráfica">
                        <i class="fa-solid fa-expand"></i>
                    </button>
                </div>
                <p class="chart-subtitle">Número de actividades de riesgo registradas en cada área.</p>
                <div class="chart-container">
                    <canvas id="activitiesByAreaChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Composición de Riesgo por Área</h3>
                    <button class="expand-btn" title="Ampliar gráfica">
                        <i class="fa-solid fa-expand"></i>
                    </button>
                </div>
                <p class="chart-subtitle">Total de centros de trabajo y su desglose por nivel de riesgo.</p>
                <div class="chart-container">
                    <canvas id="riskCompositionChart"></canvas>
                </div>
            </div>
        </div>
        <div class="column-selector">
            <h3>Elegir Atributos a Visualizar</h3>
            <div class="checkbox-grid">
                <label class="custom-checkbox"><input type="checkbox" data-column="score" checked><span class="checkmark"></span> Score</label>
                <label class="custom-checkbox"><input type="checkbox" data-column="closed" checked><span class="checkmark"></span> Status</label>
                <label class="custom-checkbox"><input type="checkbox" data-column="eval-inicial" checked><span class="checkmark"></span> Eval. Inicial</label>
                <label class="custom-checkbox"><input type="checkbox" data-column="fotos" checked><span class="checkmark"></span> Fotos</label>
                <label class="custom-checkbox"><input type="checkbox" data-column="specific-evals" checked><span class="checkmark"></span> Eval. Específicas</label>
            </div>
        </div>

        <div class="filter-bar">
            <input type="text" id="filter-name" class="input-field" placeholder="Buscar por nombre...">
            <select id="filter-area" class="filter-select" aria-label="Filtrar por área"><option value="">Todas las áreas</option></select>
            <select id="filter-risk" class="filter-select" aria-label="Filtrar por nivel de riesgo"><option value="">Todos los riesgos</option><option value="low">Bajo (≤40%)</option><option value="medium">Medio (41-70%)</option><option value="high">Alto (>70%)</option></select>
        </div>

        <div class="report-table-container" id="report-table-wrapper">
            <table class="report-table">
                    <thead>
                        <tr>
                            <th class="col-expand"></th>
                            <th class="col-name sortable-header" data-sort-key="name">Centro de Trabajo</th>
                            <th class="col-score sortable-header" data-sort-key="score_general">Score</th>                          
                            <th class="col-eval-inicial filterable-header" data-filter-key="hasInitialEval" data-filter-type="boolean">
                                <div class="header-content-wrapper">
                                    <span>Eval. Inicial <span class="header-count" data-header-count="hasInitialEval"></span></span>
                                    <i class="fa-solid fa-filter filter-icon"></i>
                                </div>
                            </th>
                            <th class="col-fotos filterable-header" data-filter-key="hasPhotos" data-filter-type="boolean">
                                <div class="header-content-wrapper">
                                    <span>Fotos <span class="header-count" data-header-count="hasPhotos"></span></span>
                                    <i class="fa-solid fa-filter filter-icon"></i>
                                </div>
                            </th>
                            <th class="col-specific-evals filterable-header" data-filter-key="hasSpecificEval" data-filter-type="boolean">
                                <div class="header-content-wrapper">
                                    <span>Eval. Específicas <span class="header-count" data-header-count="hasSpecificEval"></span></span>
                                    <i class="fa-solid fa-filter filter-icon"></i>
                                </div>
                            </th>
                            <th class="col-closed filterable-header" data-filter-key="is_closed" data-filter-type="boolean">
                                <div class="header-content-wrapper">
                                    <span>Cerrado <span class="header-count" data-header-count="is_closed"></span></span>
                                    <i class="fa-solid fa-filter filter-icon"></i>
                                </div>
                            </th>
                        </tr>
                    </thead>
                <tbody id="report-tbody">
                    <tr class="loading-skeleton"><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-circle"></div></td><td><div class="skeleton-circle"></div></td><td><div class="skeleton-circle"></div></td><td><div class="skeleton-circle"></div></td><td><div class="skeleton-circle"></div></td><td><div class="skeleton-circle"></div></td></tr>
                    <tr class="loading-skeleton"><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-circle"></div></td><td><div class="skeleton-circle"></div></td><td><div class="skeleton-circle"></div></td><td><div class="skeleton-circle"></div></td><td><div class="skeleton-circle"></div></td><td><div class="skeleton-circle"></div></td></tr>
                    <tr class="loading-skeleton"><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-circle"></div></td><td><div class="skeleton-circle"></div></td><td><div class="skeleton-circle"></div></td><td><div class="skeleton-circle"></div></td><td><div class="skeleton-circle"></div></td><td><div class="skeleton-circle"></div></td></tr>
                </tbody>
            </table>
        </div>
    </div>
    <script>

        let activeFilters = {};
        document.addEventListener('DOMContentLoaded', async () => {
            // Inicialización y Autenticación
            if (!ERGOAuth.initializeAuthContext()) {
                console.error("Fallo en la autenticación. Redirigiendo al login...");
                ERGOUtils.showToast('Tu sesión ha expirado. Por favor, inicia sesión de nuevo.', 'error');
                setTimeout(() => ERGOAuth.redirectToLogin(), 1500);
                return;
            }
            if (window.HeaderComponent) {
                HeaderComponent.init({ title: "Reporte General", breadcrumb: "Reportes" });
            }

            // Variables de estado
            const tbody = document.getElementById('report-tbody');
            let allCentersData = [];
            let currentSortKey = 'name';
            let isSortAscending = true;
            let activeFilters = {};

            
            const getStatusIcon = (condition) => condition ? `<div class="status-icon success"><i class="fa-solid fa-check-circle"></i></div>` : `<div class="status-icon danger"><i class="fa-solid fa-times-circle"></i></div>`;            
            const updateKPIs = (centers, areas, specificEvals) => {
                
                const totalAreas = areas.length;
                const centersWithEval = centers.filter(c => c.hasInitialEval).length;
                const totalSpecificEvals = specificEvals.length;
                const headerCount = document.getElementById("header-count");
                const avgScoreEl = document.getElementById("average-score");

                const scored = centers.filter(c => typeof c.score_general === "number");
                const avgScore = scored.length
                ? scored.reduce((sum, c) => sum + c.score_general, 0) / scored.length
                : 0;
                

                const totalAreasKPI = document.getElementById('total-areas-kpi');
                if (totalAreasKPI) {
                    const kpiNumber = totalAreasKPI.querySelector('.kpi-number');
                    if (kpiNumber) kpiNumber.textContent = totalAreas;
                }
                
                document.getElementById('centros-evaluados-kpi').textContent = `${centersWithEval} / ${centers.length}`;
                document.getElementById('score-promedio-kpi').textContent = `${avgScore.toFixed(1)}%`;
                document.getElementById('total-actividades-kpi').textContent = totalSpecificEvals;
            };

            const renderTable = (data) => {
                const tbody = document.getElementById("report-tbody");
                
                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 3rem;">No se encontraron centros que coincidan con los filtros.</td></tr>`;
                    return;
                }

                tbody.innerHTML = "";
  const fragment = document.createDocumentFragment();
                data.forEach(center => {
                    const dataRow = document.createElement('tr');
                    
                    dataRow.innerHTML = `
                        <td class="col-expand" data-label=""><span class="expand-arrow" data-center-id="${center.id}">▶</span></td>
                        <td class="col-name" data-label="Centro de Trabajo">
                            <div class="center-name">${center.name}</div>
                            <div class="area-name-report">${center.area_name}</div>
                        </td>
                        <td class="col-score" data-label="Score">${(center.score_general || 0).toFixed(2)}%</td>
                        <td class="col-eval-inicial" data-label="Eval. Inicial">${getStatusIcon(center.hasInitialEval)}</td>
                        <td class="col-fotos" data-label="Fotos">${getStatusIcon(center.hasPhotos)}</td>
                        <td class="col-specific-evals" data-label="Eval. Específicas">${getStatusIcon(center.hasSpecificEval)}</td>
                        <td class="col-closed" data-label="Cerrado">${getStatusIcon(center.is_closed)}</td>
                    `;
                    fragment.appendChild(dataRow);
                    const detailsRow = document.createElement('tr');
                    detailsRow.className = 'details-row';
                    detailsRow.setAttribute('data-details-for', center.id);                    
                    let detailsContent = '<h4>No hay evaluaciones específicas registradas.</h4>';
                    if (center.specificEvaluations && center.specificEvaluations.length > 0) {
                        detailsContent = `
                        <h4>Actividades</h4>
                        <ul class="evaluation-list">
                            ${center.specificEvaluations.map(ev => `
                            <li class="evaluation-item">
                                <div style="flex-grow:1;">
                                <span style="font-weight:600; color: var(--gray-800); display:block;">
                                    ${ev.titulo || 'Actividad sin nombre'}
                                </span>
                                <span style="font-size:0.85em; color: var(--gray-500);">
                                    Método: ${ev.tipo} • Score: ${(ev.score_final || 0).toFixed(1)}%
                                </span>
                                </div>
                                <span class="eval-date">${ERGOUtils.formatDate(ev.created_at)}</span>
                            </li>`).join('')}
                        </ul>`;
                    }
                    
                    detailsRow.innerHTML = `<td colspan="7"><div class="details-content">${detailsContent}</div></td>`;
                    fragment.appendChild(detailsRow);
                });
                tbody.appendChild(fragment);
            };
            
            async function fetchAndProcessData() {
                try {
                    const [centrosData, scoresData, areasData, todasLasFotos, allSpecificEvals] = await Promise.all([
                        dataClient.getWorkCenters(),
                        dataClient.query('scores_resumen'),
                        dataClient.getAreas(),
                        dataClient.query('fotos_centros', 'GET', null, '?select=work_center_id'),
                        dataClient.getAllSpecificEvaluationsFlat()
                    ]);

                    if (!centrosData || !areasData) {
                        throw new Error("No se pudieron cargar los datos de centros o áreas.");
                    }
                    
                    const areaMap = new Map(areasData.map(area => [area.id, area.name]));
                    const photosCountMap = new Map();
                    todasLasFotos.forEach(foto => {
                        const count = photosCountMap.get(foto.work_center_id) || 0;
                        photosCountMap.set(foto.work_center_id, count + 1);
                    });

                    const specificEvalsMap = new Map();
                    allSpecificEvals.forEach(ev => {
                        if (!specificEvalsMap.has(ev.work_center_id)) {
                            specificEvalsMap.set(ev.work_center_id, []);
                        }
                        specificEvalsMap.get(ev.work_center_id).push(ev);
                    });

                    allCentersData = centrosData.map(center => {
                        const scoreInfo = scoresData.find(s => s.work_center_id === center.id) || {};
                        const specificEvalsForCenter = specificEvalsMap.get(center.id) || [];
                        
                        return {
                            ...center,
                            area_name: areaMap.get(center.area_id) || 'Sin área',
                            score_general: scoreInfo.score_actual || 0,
                            is_closed: scoreInfo.is_closed || false,
                            hasInitialEval: !!scoreInfo.fecha_ultima_evaluacion, 
                            hasPhotos: (photosCountMap.get(center.id) || 0) > 0,
                            hasSpecificEval: specificEvalsForCenter.length > 0,
                            specificEvaluations: specificEvalsForCenter
                        };
                    });

                    // Una vez que los datos están listos, actualizamos la UI
                    updateKPIs(allCentersData, areasData, allSpecificEvals);
                    populateAreaFilter(areasData);
                    createDistributionChart(areasData); // 🔹 Pasamos las áreas ya descargadas
                    applyFiltersAndSort(); // Renderiza tabla inicial y contadores

                } catch (error) {
                    console.error("Error al cargar los datos del reporte:", error);
                    tbody.innerHTML = `<tr><td colspan="7" class="error-cell">Error al cargar los datos. Por favor, recarga la página.</td></tr>`;
                }
            }
        
        function populateAreaFilter(areas) {
                const areaFilter = document.getElementById('filter-area');
                areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = area.id;
                    option.textContent = area.name;
                    areaFilter.appendChild(option);
                });
            }

function updateHeaderCounts(data) {
			const counts = { hasInitialEval: 0, hasPhotos: 0, hasSpecificEval: 0, is_closed: 0 };
			data.forEach(center => {
				if (center.hasInitialEval) counts.hasInitialEval++;
				if (center.hasPhotos) counts.hasPhotos++;
				if (center.hasSpecificEval) counts.hasSpecificEval++;
				if (center.is_closed) counts.is_closed++;
			});

			for (const key in counts) {
				const countElement = document.querySelector(`.header-count[data-header-count="${key}"]`);
				if (countElement) {
					countElement.textContent = `(${counts[key]})`;
				}
			}
		}
                function applyFiltersAndSort() {
                const nameValue = document.getElementById('filter-name').value.toLowerCase();
                const areaValue = document.getElementById('filter-area').value;
                const riskValue = document.getElementById('filter-risk').value;                
                let filteredData = allCentersData.filter(center => {
                    const nameMatch = center.name.toLowerCase().includes(nameValue);
                    const areaMatch = !areaValue || center.area_id.toString() === areaValue;
                    
                    let riskMatch = true;
                    if (riskValue === 'low') riskMatch = (center.score_general || 0) <= 40;
                    else if (riskValue === 'medium') riskMatch = (center.score_general || 0) > 40 && (center.score_general || 0) <= 70;
                    else if (riskValue === 'high') riskMatch = (center.score_general || 0) > 70;

                    const popoverFiltersMatch = Object.keys(activeFilters).every(key => {
                        const filterValue = activeFilters[key];
                        if (filterValue === null || filterValue === undefined) {
                            return true;
                        }
                        return center[key] === filterValue;
                    });
                    
                    return nameMatch && areaMatch && riskMatch && popoverFiltersMatch;
                });
                
                const sortedData = sortData(filteredData);
                renderTable(sortedData);
                updateHeaderCounts(filteredData);
                updateSortHeadersUI();
            }



// --- AÑADIR TODA ESTA NUEVA SECCIÓN DE CÓDIGO ---

function closeAllPopovers() {
    document.querySelectorAll('.filter-popover').forEach(popover => popover.remove());
}

const numericKeys = new Set(['score_general']);
function sortData(data) {
  return [...data].sort((a, b) => {
    const isNum = numericKeys.has(currentSortKey);
    const valA = (a[currentSortKey] ?? (isNum ? 0 : ''));
    const valB = (b[currentSortKey] ?? (isNum ? 0 : ''));
    const cmp = isNum ? (valA - valB) : String(valA).localeCompare(String(valB), 'es');
    return isSortAscending ? cmp : -cmp;
  });
}

function createFilterPopover(headerElement) {
    closeAllPopovers(); // Cierra cualquier otro popover que esté abierto

    const filterKey = headerElement.dataset.filterKey;
    const filterType = headerElement.dataset.filterType;
    const currentFilterValue = activeFilters[filterKey];
    
    let options = [];
    if (filterType === 'boolean') {
        options = [
            { label: 'Mostrar Todos', value: null, icon: 'fa-solid fa-globe' },
            { label: 'Sí (Completado)', value: true, icon: 'fa-solid fa-check-circle' },
            { label: 'No (Pendiente)', value: false, icon: 'fa-solid fa-times-circle' }
        ];
    }
    // Aquí podrías añadir más lógicas para otros tipos de filtros (texto, número, etc.)

    const popover = document.createElement('div');
    popover.className = 'filter-popover';
    popover.innerHTML = options.map(opt => `
        <div class="filter-option ${currentFilterValue === opt.value ? 'selected' : ''}" data-value="${opt.value}">
            <i class="${opt.icon} ${currentFilterValue === opt.value ? 'success' : 'status-icon'}"></i>
            <span>${opt.label}</span>
        </div>
    `).join('');

    // Event listener para las opciones del popover
    popover.querySelectorAll('.filter-option').forEach(optionEl => {
        optionEl.addEventListener('click', () => {
            let value = optionEl.dataset.value;
            // Convertir el string del data-attribute al tipo correcto
            if (value === 'true') value = true;
            else if (value === 'false') value = false;
            else value = null;

            if (value === null) {
                delete activeFilters[filterKey];
                headerElement.querySelector('.filter-icon').classList.remove('active');
            } else {
                activeFilters[filterKey] = value;
                headerElement.querySelector('.filter-icon').classList.add('active');
            }
            
            applyFiltersAndSort();
            closeAllPopovers();
        });
    });

    headerElement.appendChild(popover);
}

// Event Delegation para todos los filtros y clics fuera
document.addEventListener('click', function(event) {
    const filterIcon = event.target.closest('.filter-icon');
    
    if (filterIcon) {
        event.stopPropagation();
        const header = filterIcon.closest('.filterable-header');
        // Si el popover para este header ya existe, lo cerramos. Si no, lo creamos.
        if (header.querySelector('.filter-popover')) {
            closeAllPopovers();
        } else {
            createFilterPopover(header);
        }
        return;
    }

    // Si se hace clic en cualquier otro lugar fuera de un popover, se cierran todos
    if (!event.target.closest('.filter-popover')) {
        closeAllPopovers();
    }
});

            function updateSortHeadersUI() {
                document.querySelectorAll('.sortable-header').forEach(header => {
                    header.classList.remove('sorted-asc', 'sorted-desc');
                    if (header.dataset.sortKey === currentSortKey) {
                        header.classList.add(isSortAscending ? 'sorted-asc' : 'sorted-desc');
                    }
                });
            }

            document.getElementById('filter-name').addEventListener('input', applyFiltersAndSort);
            document.getElementById('filter-area').addEventListener('change', applyFiltersAndSort);

            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', () => {
                    const key = header.dataset.sortKey;
                    if (currentSortKey === key) {
                        isSortAscending = !isSortAscending;
                    } else {
                        currentSortKey = key;
                        isSortAscending = true;
                    }
                    applyFiltersAndSort();
                });
            });

             document.querySelectorAll('.column-selector input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const column = e.target.dataset.column;
                    const tableWrapper = document.getElementById('report-table-wrapper');
                    tableWrapper.classList.toggle(`hide-col-${column}`, !e.target.checked);
                });
            });

                        tbody.addEventListener('click', function(event) {
                const arrow = event.target.closest('.expand-arrow');
                if (arrow) {
                    // Evita que el clic en la flecha navegue a otra página
                    event.stopPropagation(); 
                    
                    const centerId = arrow.dataset.centerId;
                    const detailsRow = tbody.querySelector(`tr[data-details-for="${centerId}"]`);
                    if (detailsRow) {
                        const isVisible = detailsRow.style.display === 'table-row';
                        detailsRow.style.display = isVisible ? 'none' : 'table-row';
                        arrow.classList.toggle('expanded', !isVisible);
                    }
                } else {
                    // Si se hizo clic en cualquier otra parte de la fila, navega
                    const row = event.target.closest('tr');
                    if (row && !row.classList.contains('details-row')) {
                    }
                }
            });

    function createDistributionChart(areas) {
        try {
            Chart.register(ChartDataLabels);

            if (!areas || areas.length === 0) {
                console.warn('No hay datos de áreas para mostrar en la gráfica.');
                return;
            }

        const labels = areas.map(area => area.name);
        const dataPoints = areas.map(area => area.total_centros);
        const totalGlobalCentros = dataPoints.reduce((sum, current) => sum + current, 0);

        const ctx = document.getElementById('areasDistributionChart').getContext('2d');

        // 🎨 Gradientes modernos con transparencia
        const gradients = [
            ['rgba(76,110,245,0.9)', 'rgba(34,139,230,0.6)'],
            ['rgba(21,170,191,0.9)', 'rgba(18,184,134,0.6)'],
            ['rgba(64,192,87,0.9)', 'rgba(130,201,30,0.6)'],
            ['rgba(250,176,5,0.9)', 'rgba(253,126,20,0.6)'],
            ['rgba(255,99,132,0.9)', 'rgba(230,73,128,0.6)'],
            ['rgba(190,75,219,0.9)', 'rgba(121,80,242,0.6)'],
            ['rgba(52,152,219,0.9)', 'rgba(41,128,185,0.6)']
        ].map(pair => {
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, pair[0]);
            gradient.addColorStop(1, pair[1]);
            return gradient;
        });

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels,
                datasets: [{
                    label: 'Centros de Trabajo',
                    data: dataPoints,
                    backgroundColor: gradients,
                    borderColor: 'rgba(255,255,255,0.8)',
                    borderWidth: 2,
                    hoverOffset: 30 // más grande al hover
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: 30
                },
                animation: {
                    animateScale: true,
                    animateRotate: true,
                    duration: 1500,
                    easing: 'easeOutBack'
                },
                plugins: {
                    // 🔠 Título más chico y sutil
                    title: {
                        display: true,
                        text: 'Distribución de Centros por Área',
                        color: 'rgba(255,255,255,0.8)',
                        font: {
                            size: 16,
                            weight: '400',
                            family: "'Inter', sans-serif"
                        },
                        padding: { bottom: 10 }
                    },
                    // 🚫 Ocultamos leyenda estática
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(255,255,255,0.3)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: 'rgba(255,255,255,0.5)',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 12,
                        caretPadding: 10,
                        caretSize: 8,
                        callbacks: {
                            title: function (context) {
                                return context[0].label; // aparece el título sólo al hover
                            },
                            label: function (context) {
                                const value = context.raw;
                                const percentage = ((value / totalGlobalCentros) * 100).toFixed(1) + '%';
                                return ` ${value} centros (${percentage})`;
                            }
                        }
                    },
                    datalabels: areas.length > 25 ? false : {
                        formatter: (value, context) => {
                            const percentage = (value / totalGlobalCentros) * 100;
                            // 🔹 Ocultar etiquetas con menos del 3%
                            return percentage >= 3 ? percentage.toFixed(1) + '%' : '';
                        },
                        color: 'rgba(255,255,255,0.95)',
                        font: {
                            weight: 'bold',
                            size: 14,
                            family: "'Inter', sans-serif"
                        },
                        textStrokeColor: 'rgba(0,0,0,0.4)',
                        textStrokeWidth: 3,
                        shadowBlur: 8,
                        shadowColor: 'rgba(0,0,0,0.6)'
                    }
                }
            }
        });

        // 🎇 CSS extra para efecto glass
        const chartCanvas = document.getElementById('areasDistributionChart');
        chartCanvas.style.background = "rgba(255,255,255,0.15)";
        chartCanvas.style.backdropFilter = "blur(12px)";
        chartCanvas.style.borderRadius = "20px";
        chartCanvas.style.boxShadow = "0 8px 32px rgba(0,0,0,0.3)";

    } catch (error) {
        console.error('Error al crear la gráfica de distribución:', error);
        const chartContainer = document.querySelector('.chart-container');
        if (chartContainer) {
            chartContainer.innerHTML = '<p style="text-align:center; color: var(--danger-500);">No se pudo cargar la gráfica.</p>';
        }
    }
}
            async function createActivitiesDashboard() {
    try {
        const { data: summary, error } = await dataClient.supabase.rpc('get_reporte_actividades_summary');
        if (error) throw error;
        if (!summary) return;

        // --- KPI ---
        document.getElementById('total-actividades-kpi').textContent = summary.totalActividades;

        // --- Datos ---
        const activitiesData = summary.actividadesPorArea;
        const labels = activitiesData.map(item => item.area_name);
        const dataPoints = activitiesData.map(item => item.count);

        const ctx = document.getElementById('activitiesByAreaChart').getContext('2d');

        // Gradiente azul pro
        const gradient = ctx.createLinearGradient(0, 0, 600, 0);
        gradient.addColorStop(0, "rgba(76, 110, 245, 0.9)");
        gradient.addColorStop(1, "rgba(34, 197, 255, 0.7)");

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'Nº de Actividades',
                    data: dataPoints,
                    backgroundColor: gradient,
                    borderRadius: 12,
                    borderSkipped: false,
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                },
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        backgroundColor: 'rgba(255,255,255,0.6)',
                        borderRadius: 6,
                        padding: 4,
                        color: '#1e293b',
                        font: { weight: 'bold', size: 12 }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: { drawTicks: false, color: 'rgba(0,0,0,0.05)' },
                        ticks: { precision: 0, color: '#64748b' }
                    },
                    y: {
                        grid: { display: false },
                        ticks: { color: '#475569', font: { weight: 500 } }
                    }
                }
            }
        });

    } catch (error) {
        console.error('Error al crear el dashboard de actividades:', error);
    }
}
             async function createRiskCompositionChart() {
    try {
        const { data, error } = await dataClient.supabase.rpc('get_reporte_riesgo_por_area');
        if (error) throw error;

        const labels = data.map(item => item.area_name);
        const redData = data.map(item => item.riesgos.rojo);
        const orangeData = data.map(item => item.riesgos.naranja);
        const greenData = data.map(item => item.riesgos.verde);

        const ctx = document.getElementById('riskCompositionChart').getContext('2d');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    {
                        label: 'Riesgo Alto',
                        data: redData,
                        backgroundColor: ' rgba(239,68,69,0.9)',
                        borderRadius: 6
                    },
                    {
                        label: 'Riesgo Moderado',
                        data: orangeData,
                        backgroundColor: 'rgba(249,115,22,0.8)',
                        borderRadius: 6
                    },
                    {
                        label: 'Riesgo Bajo',
                        data: greenData,
                        backgroundColor: 'rgba(34,197,94,0.8)',
                        borderRadius: 6
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1200,
                    easing: 'easeOutBack'
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            pointStyle: 'circle',
                            font: { size: 8, weight: '500' },
                            color: '#334155'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(30,41,59,0.9)',
                        borderColor: 'rgba(255,255,255,0.2)',
                        borderWidth: 1,
                        padding: 10,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const dataset = context.dataset.label;
                                return `${dataset}: ${value}`;
                            },
                            footer: function(tooltipItems) {
                                const index = tooltipItems[0].dataIndex;
                                const areaData = data[index];
                                const total = areaData.riesgos.total;
                                return `Total Centros: ${total}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        grid: { drawTicks: false, color: 'rgba(0,0,0,0.05)' },
                        ticks: { color: '#475569' }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: { precision: 0, color: '#475569' },
                        grid: { display: false }
                    }
                }
            }
        });

    } catch (error) {
        console.error('Error al crear la gráfica de composición de riesgo:', error);
    }
}

            fetchAndProcessData();
            createDistributionChart();
            createActivitiesDashboard();
            createRiskCompositionChart();
            if (window.realtimeClient) {
                window.realtimeClient.subscribeAndCache(
                    'sync_areas_reporte',
                    'areas',
                    (payload) => {
                        console.log('🔄 Cambio detectado en "areas", recargando datos del reporte...');
                        fetchAndProcessData();
                    },
                    'cache_key_areas'
                );
            } else {
                console.warn("⚠️ realtimeClient no está disponible en window.");
            }
        });


        document.addEventListener('DOMContentLoaded', () => {
    const totalAreasKPI = document.getElementById('total-areas-kpi');
    if (!totalAreasKPI) return; // Validación de existencia

    const detailPanel = totalAreasKPI.querySelector('.areas-detail-panel');
    if (!detailPanel) return; // Validación de existencia

    const detailList = detailPanel.querySelector('.areas-detail-list');
    if (!detailList) return; // Validación de existencia

    let isOpen = false;

    // Función para actualizar el panel con los datos
    const updateAreasPanel = (areasData) => {
        if (!areasData || !Array.isArray(areasData)) return;

        detailList.innerHTML = areasData
            .sort((a, b) => b.total_centros - a.total_centros)
            .map(area => `
                <li class="area-detail-item">
                    <span class="area-name">${area.name}</span>
                    <span class="area-count">${area.total_centros}</span>
                </li>
            `).join('');
    };

    // Click en el KPI
totalAreasKPI.addEventListener('click', async (e) => {
        e.stopPropagation();
        isOpen = !isOpen;
        detailPanel.classList.toggle('active', isOpen);
        totalAreasKPI.classList.toggle('expanded', isOpen);

        if (isOpen) {
            try {
                // Ahora la llamada es mucho más limpia y usa la caché
                const areas = await ERGOData.getAreas(); 
                if (areas) {
                    updateAreasPanel(areas);
                }
            } catch (error) {
                console.error('Error al cargar detalles de áreas:', error);
                detailList.innerHTML = '<li class="area-detail-item">Error al cargar los datos</li>';
            }
        }
    });
    // Cerrar al hacer click fuera
    document.addEventListener('click', (e) => {
        if (isOpen && !totalAreasKPI.contains(e.target)) {
            isOpen = false;
            detailPanel.classList.remove('active');
        }
    });
});
    </script>
</body>
</html>