<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Evaluación Ergonómica (EJA)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../globals.js"></script>
    <script src="../supabase-config.js"></script>
    <script src="../auth-client.js"></script>
    <script src="./johnson-eval.js"></script>
    
    <style>
    /**
     * Estilos generales y de layout
     */
    * {
      margin: 0;
    }

    p, label {
      font-size: 12px;
    }
    #main-header-container {
    display: flex;
    gap: 20px; /* Espacio entre la info y la tabla */
    align-items: flex-start;
    padding: 0 20px; /* Añade un poco de padding lateral */
    }
    .container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    width: 350px; /* Ancho fijo */
    flex-shrink: 0; /* Evita que se encoja */
    }
    .summary-container {
    flex: 1; /* Ocupa el espacio restante */
    margin-top: 0; /* Eliminamos el margen superior */
    font-family: sans-serif;
    }

    .info-content {
      display: flex;
      gap: 3px;
      height: 15px;
      align-items: center;
    }

    .info-content label {
      color: var(--text-color);
      margin: 0;
      width: 100px;
    }

    .container-evaluation {
      margin-top: 10px; /* Margen superior consistente */
      display: flex;
      align-items: stretch;
      border: 1px solid #d0d7de; /* Bordes suaves por defecto */
      border-radius: 6px; /* Radio suave por defecto */
      padding: 5px;
      width: 350px;
      height: 130px; /* Altura inicial, se ajusta posteriormente por CSS dinámico */
      box-sizing: border-box; /* Incluye padding y border en el tamaño total */
      background-color: #ffffff;
    }

    img {
      height: 35px;
      width: 35px;
      margin: 5px 0; /* Margen vertical consistente */
      object-fit: contain; /* Mantiene la proporción de la imagen */
    }

    .indicators {
    display: flex;
    flex-direction: column;
    flex: 1; 
    min-width: 130px; 
    height: 100%;
    gap: 5px;
    padding-right: 10px;
    }

    .aditional-info {
      display: grid;
      grid-template-columns: 2fr 1fr;
      font-size: 12px;
      align-items: center;
      gap: 5px; /* Espaciado consistente */
      margin-top: auto; /* Empuja al fondo del contenedor */
    }

    .aditional-info input {
      width: 15px;
      height: 20px;
      border-radius: 5px;
      border: 1px solid var(--border-color);
      padding: 0 10px;
      font-size: 11px;
    }
    .score-indicators {
        display: flex;
        flex-direction: row;
        justify-content: space-around;
        width:65%;
        margin: 0;
        align-items: flex-start;
    }

    .score-indicators div {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        width: 40px; 
    }
    .is-locked .custom-x {
    pointer-events: none;
    opacity: 0.6;
    }
    /* 1. Oculta el checkbox original */
    .score-indicators input[type="checkbox"] {
        display: none;
    }

    /* 2. Estilo base para el recuadro personalizado que lo reemplaza */
    .score-indicators .custom-x {
        width: 32px;
        height: 18px;
        margin: 2px 0;
        line-height: 24px;
        text-align: center;
        align-content: center;
    }

    /* 3. Asigna el color de fondo a cada recuadro SIEMPRE */
    .score-indicators input.rojo + .custom-x { background-color: #e53935; }
    .score-indicators input.amarillo + .custom-x { background-color: #fbc02d; }
    .score-indicators input.azul + .custom-x { background-color: #1e40af; }
    .score-indicators input.gris + .custom-x { background-color: #757575; }
    .score-indicators input.verde + .custom-x { background-color: #03ba00; }


    /* 4. CUANDO SE SELECCIONA, hace la 'X' visible */
    .score-indicators input[type="checkbox"]:checked + .custom-x {
        color: #fff; /* Cambia el color del texto a blanco para que la 'X' sea visible */
    }

    .score-indicators input[type="checkbox"]:checked + .custom-x::after {
        content: "X"; /* Añade la 'X' como contenido */
    }

    #evaluations-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: flex-start;
    }

    .evaluation-column {
        display: flex;
        flex-direction: column;
        gap: 10px; /* Cambiado de 3px para dar más espacio consistente */
        width: 350px;
        flex-shrink: 0; /* Evita que la columna se encoja */
    }

    .evaluation-title {
        font-size: 14px; /* Tamaño de fuente consistente */
        margin: 0;
        line-height: 1.2; /* Altura de línea consistente */
    }
    .score-display {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 40px;
    }

    .score-display p:first-child {
        font-size: 12px;
        margin: 0;
        color: #333;
        margin-top: 0;
        padding-top: 0;
    }

    .selected-score {
        font-size: 14px;
        font-weight: bold;
        margin: 2px 0;
        color: #000;
        padding: 3px 0;
    }

    .score-indicators label {
        margin-top: 2px;
        font-size: 12px;
    }

    @media (max-width: 600px) {
  
    /* El contenedor principal ahora apila sus elementos verticalmente. */
    .container-evaluation {
        flex-direction: column;
        height: auto; /* La altura se ajusta al contenido */
        align-items: center;
        gap: 15px;
    }

    /* Ambas secciones ocupan el ancho completo en móviles. */
    .indicators,
    .score-indicators {
        width: 100%;
    }
    
    /* Las cajas de score pueden pasar a la siguiente línea si no caben. */
    .score-indicators {
        flex-wrap: wrap; 
        justify-content: center; /* Centra las cajas de score */
        gap: 10px;
        width: 100%;
    }
    
    /* La info adicional también se apila para mejor lectura. */
    .aditional-info {
        grid-template-columns: 1fr; /* Cambia a una sola columna */
    }
    }

    .score-indicators input.verde + .custom-x, 
    .score-indicators .custom-x.verde { 
        background-color: #03ba00;
        color: transparent; /* Inicialmente transparente como los otros */
    }

    .score-indicators input[type="checkbox"].verde:checked + .custom-x {
        color: #fff;
    }

    .score-indicators input[type="checkbox"].verde:checked + .custom-x::after {
        content: "X";
        color: white;
        font-weight: bold;
        display: block;
        line-height: 18px;
    }

    #risk-level-text {
    font-weight: bold;
    font-size: 12px;
    margin-left: 10px;
    }
    .low { color: #2e7d32; } /* Verde */
    .moderate { color: #ff8f00; } /* Naranja */
    .high { color: #c62828; } /* Rojo */
</style>

</head>

<body>
    <div id="main-header-container">
        <section class="container">
            <div class="info-content"> <label>Job/Task</label> <input type="text" id="job" placeholder="Almacen"> </div>
            <div class="info-content"> <label>Company</label> <input type="text" id="company" placeholder="J&J"> </div>
            <div class="info-content"> <label>Location</label> <input type="text" id="location" placeholder="Puebla"> </div>
            <div class="info-content"> <label># of Empoyees</label> <input type="text" id="Employees" placeholder="44"> </div>
            <div class="info-content"> <label>Name of Analyst</label> <input type="text" id="nAnalyst" placeholder="Brandon Cortes"> </div>
        </section>
        <section class="summary-container">
            <h2>Resumen de Puntuación</h2>
            <table class="summary-table">
                <tbody>
                    <tr>
                        <td><strong>Puntaje de Riesgo del Puesto</strong><br><span>(Suma de puntajes de las categorías 1-40)</span></td>
                        <td id="job-risk-score-cell"><span id="job-risk-score">0</span><span id="risk-level-text"></span></td>
                    </tr>
                    <tr>
                        <td><strong>Número de Empleados</strong></td>
                        <td id="num-employees-display">0</td>
                    </tr>
                    <tr>
                        <td><strong>Puntaje Total del Puesto</strong><br><span>(Puntaje de Riesgo x No. de Empleados)</span></td>
                        <td id="total-job-score">0</td>
                    </tr>
                </tbody>
            </table>
        </section>
    </div>

    <div id="evaluations-container"></div>
    <div id="action-buttons-container" style="position: fixed; bottom: 24px; right: 24px; z-index: 100;">
        <button id="edit-button" title="Editar evaluación" class="btn" style="display: none; background-color: #ffc107;">Editar</button>
        <button id="save-button" title="Guardar evaluación" class="btn btn-primary">Guardar evaluación</button>
    </div>

    <template id="evaluation-template">
        <section class="container-evaluation">
            <div class="indicators"> <h3 class="evaluation-title"></h3> <img src="" alt="#" class="evaluation-image"> <div class="aditional-info"> <label>Number of cases</label> <input type="text" class="cases-input" placeholder="44"> <label>Number of incidents</label> <input type="text" class="incident-input" placeholder="2"> </div> </div>
            <div class="score-indicators">
                <div> <p>High</p> <input type="checkbox" name="loss-high" class="rojo"> <span class="custom-x rojo"></span> <label></label> </div>
                <div> <p>Mod</p> <input type="checkbox" name="loss-mod" class="amarillo"> <span class="custom-x amarillo"></span> <label></label> </div>
                <div> <p>Low</p> <input type="checkbox" name="loss-low" class="azul"> <span class="custom-x azul"></span> <label></label> </div>
                <div> <p>Ok</p> <input type="checkbox" name="loss-ok" class="gris"> <span class="custom-x gris"></span> <label></label> </div>
                <div> <p>N/A</p> <input type="checkbox" name="loss-na"> <span class="custom-x verde"></span> <label class="na-label"></label> <div class="score-display"> <p>SCORE</p> <p class="selected-score">-</p> </div> </div>
            </div>
        </section>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (!window.ERGOAuth?.initializeAuthContext()) {
                console.error("Fallo de inicialización de autenticación. La redirección será manejada por el sistema.");
                return;
            }
            console.log('✅ Contexto de autenticación establecido en Johnson_Evaluation.html');
            // --- FIN: AUTENTICACIÓN ---

                const EJA_Evaluation = {
                actividadId: null,
                formContainer: document.getElementById('evaluations-container'),
                formElements: document.querySelectorAll('#main-header-container input, #evaluations-container input'),
                saveButton: document.getElementById('save-button'),
                editButton: document.getElementById('edit-button'),

                init: function() {
                    const urlParams = new URLSearchParams(window.location.search);
                    this.actividadId = urlParams.get('actividadId');
                    if (!this.actividadId) {
                        ERGOUtils.showToast('ID de actividad no encontrado.', 'error');
                        return;
                    }
                    this.setupEventListeners();
                    this.cargarDatosExistentes();
                },

                cargarDatosExistentes: async function() {
                    try {
                        const datos = await dataClient.getDatosAnalisisActividad(this.actividadId);
                        if (datos) {
                            console.log("Cargando datos existentes...", datos);
                            this.poblarFormulario(datos);
                            this.bloquearFormulario();
                        } else {
                            console.log("No se encontraron datos previos. Formulario listo para nueva entrada.");
                            this.desbloquearFormulario();
                        }
                    } catch (error) {
                        console.error("Error al cargar datos existentes:", error);
                        ERGOUtils.showToast("No se pudieron cargar los datos previos.", "error");
                    }
                },

                poblarFormulario: function(datos) {
                    // La lógica para poblar el formulario que ya tienes es correcta y no necesita cambios.
                },

                bloquearFormulario: function() {
                    this.formElements.forEach(el => el.disabled = true);
                    this.formContainer.classList.add('is-locked');
                    this.editButton.style.display = 'inline-block';
                    this.saveButton.style.display = 'none';
                },

                desbloquearFormulario: function() {
                    this.formElements.forEach(el => el.disabled = false);
                    this.formContainer.classList.remove('is-locked');
                    this.editButton.style.display = 'none';
                    this.saveButton.style.display = 'inline-block';
                },

                setupEventListeners: function() {
                    this.saveButton.addEventListener('click', () => this.guardarEvaluacion());
                    this.editButton.addEventListener('click', () => this.desbloquearFormulario());
                },

                guardarEvaluacion: async function() {
                    const evaluacionData = {
                        infoGeneral: {
                            job: document.getElementById('job').value,
                            company: document.getElementById('company').value,
                            location: document.getElementById('location').value,
                            employees: document.getElementById('Employees').value,
                            analyst: document.getElementById('nAnalyst').value
                        },
                        resumen: {
                            puntajeRiesgo: document.getElementById('job-risk-score').textContent,
                            nivelRiesgo: document.getElementById('risk-level-text').textContent,
                            puntajeTotal: document.getElementById('total-job-score').textContent
                        },
                        detalles: []
                    };
                    document.querySelectorAll('.container-evaluation').forEach(tarjeta => {
                        evaluacionData.detalles.push({
                            factor: tarjeta.querySelector('.evaluation-title').textContent,
                            puntaje: tarjeta.querySelector('.selected-score').textContent
                        });
                    });

                    try {
                        ERGOUtils.showToast('Guardando evaluación...', 'info');
                        await dataClient.actualizarDatosAnalisisActividad(this.actividadId, evaluacionData);
                        ERGOUtils.showToast('Evaluación guardada con éxito.', 'success');
                        this.bloquearFormulario();
                    } catch (error) {
                        console.error('Error al guardar la evaluación:', error);
                        ERGOUtils.showToast('No se pudo guardar la evaluación.', 'error');
                    }
                }
            };

            // Iniciar la lógica de la página
            EJA_Evaluation.init();
            // --- INICIO: LÓGICA DE LA PÁGINA ---
            // A partir de aquí, se ejecuta toda tu lógica de UI, ahora que la sesión es válida.
            
            function updateSummary() {
                let totalScore = 0;
                document.querySelectorAll('.selected-score').forEach(el => {
                    const score = parseInt(el.textContent, 10);
                    if (!isNaN(score)) totalScore += score;
                });

                const isHighRisk = document.querySelectorAll('input.rojo:checked').length > 0;
                const riskLevelElement = document.getElementById('risk-level-text');
                if (isHighRisk || totalScore >= 30) {
                    riskLevelElement.textContent = '(Riesgo Alto)';
                    riskLevelElement.className = 'high';
                } else if (totalScore >= 20) {
                    riskLevelElement.textContent = '(Riesgo Moderado)';
                    riskLevelElement.className = 'moderate';
                } else {
                    riskLevelElement.textContent = '(Riesgo Bajo)';
                    riskLevelElement.className = 'low';
                }

                const numEmployees = parseInt(document.getElementById('Employees').value, 10) || 0;
                document.getElementById('job-risk-score').textContent = totalScore;
                document.getElementById('num-employees-display').textContent = numEmployees;
                document.getElementById('total-job-score').textContent = totalScore * numEmployees;
            }

            const sectionsData = [
                { number: 1, title: 'Loss Information', image: './Johnson Evaluation_files/Imagen1.png', scores: [12, 8, 4, 0] },
                { number: 2, title: 'Employee Response', image: './Johnson Evaluation_files/Imagen2.png', scores: [8,4,2,0] },
                { number: 3, title: 'Miscellaneous', image: './Johnson Evaluation_files/Imagen3.png', scores: [8,4,2,0] },
                { number: 4, title: 'Hand Grip Force / Power Grip', image: './Johnson Evaluation_files/Imagen3.png', scores: [6,4,2,0] },
                { number: 5, title: 'Pinch Grip Force', image: './Johnson Evaluation_files/Imagen2.png', scores: [6,4,2,0] },
                { number: 6, title: 'Finger or Thumb Press Force', image: './Johnson Evaluation_files/Imagen3.png', scores: [6,4,2,0] },
                { number: 7, title: 'Wrist Flexion', image: './Johnson Evaluation_files/Imagen3.png', scores: [3,3,1,0] },
                { number: 8, title: 'Wrist Extension', image: './Johnson Evaluation_files/Imagen2.png', scores: [3,3,1,0] },
                { number: 9, title: 'Wrist Radial Deviation', image: './Johnson Evaluation_files/Imagen3.png', scores: [3,3,1,0] },
                { number: 10, title: 'Wrist Ulnar Deviation', image: './Johnson Evaluation_files/Imagen3.png', scores: [3,3,1,0] },
                { number: 11, title: 'Repetition', image: './Johnson Evaluation_files/Imagen1.png', scores: [6,4,2,0] },
                { number: 12, title: 'Vibration', image: './Johnson Evaluation_files/Imagen2.png', scores: [6,4,2,0] },
                { number: 13, title: 'Mechanical Stress to Hand', image: './Johnson Evaluation_files/Imagen3.png', scores: [6,4,2,0] },
                { number: 14, title: 'Mechanical Stress to Arm', image: './Johnson Evaluation_files/Imagen3.png', scores: [3,3,1,0] },
                { number: 15, title: 'Hand Palm-Up (Forearm Supination)', image: './Johnson Evaluation_files/Imagen2.png', scores: [3,3,1,0] },
                { number: 16, title: 'Hand Palm-Down (Forearm Pronation)', image: './Johnson Evaluation_files/Imagen3.png', scores: [3,3,1,0] },
                { number: 17, title: 'Pull Down with One or Both Arms', image: './Johnson Evaluation_files/Imagen3.png', scores: [6,4,2,0] },
                { number: 18, title: 'One-handed Push or Pull', image: './Johnson Evaluation_files/Imagen2.png', scores: [6,4,2,0] },
                { number: 19, title: 'Shoulder Abduction or Flexion', image: './Johnson Evaluation_files/Imagen3.png', scores: [6,4,2,0] },
                { number: 20, title: 'Reach Across Body', image: './Johnson Evaluation_files/Imagen3.png', scores: [3,2,1,0] },
                { number: 21, title: 'Reach Behind Body', image: './Johnson Evaluation_files/Imagen1.png', scores: [3,2,1,0] },
                { number: 22, title: 'Neck Flexion', image: './Johnson Evaluation_files/Imagen2.png', scores: [3,2,1,0] },
                { number: 23, title: 'Neck Extension', image: './Johnson Evaluation_files/Imagen3.png', scores: [3,2,1,0] },
                { number: 24, title: 'Lateral Bending of Neck', image: './Johnson Evaluation_files/Imagen3.png', scores: [3,2,1,0] },
                { number: 25, title: 'Employee Response', image: './Johnson Evaluation_files/Imagen2.png', scores: [3,2,1,0] },
                { number: 26, title: 'Bending Forward', image: './Johnson Evaluation_files/Imagen3.png', scores: [6,4,2,0] },
                { number: 27, title: 'Bending to Side', image: './Johnson Evaluation_files/Imagen3.png', scores: [3,2,1,0] },
                { number: 28, title: 'Twisting', image: './Johnson Evaluation_files/Imagen2.png', scores: [3,2,1,0] },
                { number: 29, title: 'Stand on Unpadded Surface', image: './Johnson Evaluation_files/Imagen3.png', scores: [3,2,1,0] },
                { number: 30, title: 'Impact Stress to Knees and Ankles', image: './Johnson Evaluation_files/Imagen3.png', scores: [3,2,1,0] },
                { number: 31, title: 'Ankle Extension', image: './Johnson Evaluation_files/Imagen3.png', scores: [3,2,1,0] },
                { number: 32, title: 'Static Ankle Flexion', image: './Johnson Evaluation_files/Imagen3.png', scores: [3,2,1,0] },
                { number: 33, title: 'Lifting', image: './Johnson Evaluation_files/Imagen2.png', scores: [6,4,2,0] },
                { number: 34, title: 'Carrying', image: './Johnson Evaluation_files/Imagen3.png', scores: [6,4,2,0] },
                { number: 35, title: 'Pushing and Pulling (Initial Force)', image: './Johnson Evaluation_files/Imagen3.png', scores: [6,4,2,0] },
                { number: 36, title: 'Noise', image: './Johnson Evaluation_files/Imagen2.png', scores: [3,2,1,0] },
                { number: 37, title: 'Heat Stress', image: './Johnson Evaluation_files/Imagen3.png', scores: [3,2,1,0] },
                { number: 38, title: 'Cold Stress', image: './Johnson Evaluation_files/Imagen3.png', scores: [3,2,1,0] },
                { number: 39, title: 'Lighting', image: './Johnson Evaluation_files/Imagen1.png', scores: [3,2,1,0] },
                { number: 40, title: 'Human Error', image: './Johnson Evaluation_files/Imagen2.png', scores: [3,2,1,0] }
            ];

            const container = document.getElementById('evaluations-container');
            const template = document.getElementById('evaluation-template');
            const ITEMS_PER_COLUMN = 10;

            for (let i = 0; i < sectionsData.length; i += ITEMS_PER_COLUMN) {
                const column = document.createElement('div');
                column.className = 'evaluation-column';
                const columnData = sectionsData.slice(i, i + ITEMS_PER_COLUMN);

                columnData.forEach((data, colIndex) => {
                    const clone = document.importNode(template.content, true);
                    clone.querySelector('.evaluation-title').textContent = `${data.number}. ${data.title}`;
                    clone.querySelector('.evaluation-image').src = data.image;

                    const scoreDivs = clone.querySelectorAll('.score-indicators > div');
                    const colorClasses = ['rojo', 'amarillo', 'azul', 'gris'];

                    scoreDivs.forEach((div, j) => {
                        const input = div.querySelector('input[type="checkbox"]');
                        const label = div.querySelector('label');
                        if (!input) return;

                        const nameSuffix = `group-${i + colIndex}`;
                        input.name = nameSuffix;

                        if (j === 4) { // N/A
                            input.classList.add('verde');
                            input.setAttribute('data-score', '0');
                            if(label) label.style.display = 'none';
                        } else {
                            input.classList.add(colorClasses[j]);
                            if (label && data.scores[j] !== undefined) {
                                label.textContent = data.scores[j];
                            }
                        }
                    });

                    const checkboxes = clone.querySelectorAll('.score-indicators input[type="checkbox"]');
                    checkboxes.forEach(chk => {
                        chk.addEventListener('change', function() {
                            if (this.checked) {
                                checkboxes.forEach(other => { if (other !== this) other.checked = false; });
                                const scoreEl = this.closest('.container-evaluation').querySelector('.selected-score');
                                const scoreValue = this.classList.contains('verde') ? this.getAttribute('data-score') : this.parentElement.querySelector('label').textContent;
                                scoreEl.textContent = scoreValue;
                            } else {
                                this.closest('.container-evaluation').querySelector('.selected-score').textContent = '-';
                            }
                            updateSummary();
                        });
                    });

                    clone.querySelectorAll('.custom-x').forEach(span => {
                        span.addEventListener('click', function() {
                            const input = this.previousElementSibling;
                            if (input && !input.checked) {
                                input.checked = true;
                                input.dispatchEvent(new Event('change'));
                            }
                        });
                    });
                    
                    column.appendChild(clone);
                });
                container.appendChild(column);
            }

            document.getElementById('Employees').addEventListener('input', updateSummary);
            updateSummary();

            // --- INICIO: LÓGICA DE UX/UI AVANZADA ---
            const improvedCss = `
                :root { --high-color: #e57373; --mod-color: #ffb74d; --low-color: #64b5f6; --ok-color: #b0bec5; --na-color: #81c784; --text-color: #333333; --subtext-color: #666666; --border-color: #d0d7de; --background: #f5f7fa; --card-bg: #ffffff; }
                body { background-color: var(--background); font-family: "Segoe UI", Tahoma, Arial, sans-serif; color: var(--text-color); line-height: 1.4; }
                #main-header-container { position: sticky; top: 0; background-color: var(--background); z-index: 10; transition: all 0.3s ease; padding: 20px; display: flex; flex-wrap: wrap; gap: 24px; }
                #main-header-container.header-collapsed { padding: 8px 20px; gap: 12px; }
                #main-header-container.header-collapsed .container { gap: 8px; }
                #main-header-container.header-collapsed h2 { font-size: 16px; }
                #main-header-container.header-collapsed .info-content label { font-size: 11px; width: 110px; }
                #main-header-container.header-collapsed .info-content input { height: 28px; font-size: 12px; }
                #main-header-container.header-collapsed .summary-table td { padding: 6px 8px; font-size: 12px; }
                #main-header-container.header-collapsed .summary-table td strong { font-size: 12px; }
                #main-header-container.header-collapsed:hover { padding: 20px; gap: 24px; }
                #evaluations-container { height: calc(100vh - 280px); overflow-y: auto; overflow-x: hidden; }
                .container-evaluation { height: 150px; border: 1px solid var(--border-color); box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06); border-radius: 8px; background-color: var(--card-bg); }
                #save-button { position: fixed; bottom: 24px; right: 24px; z-index: 100; padding: 12px 20px; background-color: var(--high-color); border: none; border-radius: 30px; color: #ffffff; font-size: 14px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: background 0.3s, box-shadow 0.3s; }
                #save-button:hover { background-color: #b94a48; box-shadow: 0 6px 12px rgba(0,0,0,0.3); }
            `;
            const styleEl = document.createElement('style');
            styleEl.textContent = improvedCss;
            document.head.appendChild(styleEl);

            const headerElement = document.getElementById('main-header-container');
            const evalContainer = document.getElementById('evaluations-container');
            function toggleHeader() {
                if (evalContainer.scrollTop > 60) {
                    headerElement.classList.add('header-collapsed');
                } else {
                    headerElement.classList.remove('header-collapsed');
                }
            }
            evalContainer.addEventListener('scroll', toggleHeader);
            toggleHeader();

            // --- INICIO: LÓGICA DE GUARDADO ---
            async function guardarEvaluacion() {
                const urlParams = new URLSearchParams(window.location.search);
                const actividadId = urlParams.get('actividadId');
                if (!actividadId) {
                    return ERGOUtils.showToast('Error: No se encontró el ID de la actividad.', 'error');
                }

                // 1. Recolecta los datos generales y de resumen
                const evaluacionData = {
                    infoGeneral: {
                        job: document.getElementById('job').value,
                        company: document.getElementById('company').value,
                        location: document.getElementById('location').value,
                        employees: document.getElementById('Employees').value,
                        analyst: document.getElementById('nAnalyst').value
                    },
                    resumen: {
                        puntajeRiesgo: document.getElementById('job-risk-score').textContent,
                        nivelRiesgo: document.getElementById('risk-level-text').textContent,
                        puntajeTotal: document.getElementById('total-job-score').textContent
                    },
                    detalles: []
                };

                // 2. Recolecta los detalles de cada uno de los 40 factores
                document.querySelectorAll('.container-evaluation').forEach(tarjeta => {
                    evaluacionData.detalles.push({
                        factor: tarjeta.querySelector('.evaluation-title').textContent,
                        puntaje: tarjeta.querySelector('.selected-score').textContent
                    });
                });
                
                // 3. Envía el objeto JSON completo a Supabase
                try {
                    ERGOUtils.showToast('Guardando evaluación...', 'info');
                    await dataClient.actualizarDatosAnalisisActividad(actividadId, evaluacionData);
                    ERGOUtils.showToast('Evaluación guardada con éxito.', 'success');
                } catch (error) {
                    console.error('Error al guardar la evaluación:', error);
                    ERGOUtils.showToast('No se pudo guardar la evaluación.', 'error');
                }
            }

            // 4. Asigna la función al botón de guardar
            document.getElementById('save-button').addEventListener('click', guardarEvaluacion);
            // --- FIN: LÓGICA DE GUARDADO ---
// aquí termina
        });
    </script>
</body>
</html>