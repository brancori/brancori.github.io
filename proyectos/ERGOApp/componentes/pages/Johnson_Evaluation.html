<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Johnson Evaluation</title>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script src="../globals.js"></script>
    <script src="../localStorage-cache.js"></script>
    <script src="../supabase-config.js"></script>
    <script src="../auth-client.js"></script>
    <script src="../realtime-client.js"></script>
    <style>
        :root {
            --color-high: #e53935;
            --color-mod: #fbc02d;
            --color-low: #1e40af;
            --color-ok: #757575;
            --color-na: #03ba00;
            --color-risk-high: #c62828;
            --color-risk-moderate: #ff8f00;
            --color-risk-low: #2e7d32;
            --border: #ddd;
            --bg: #f5f5f5;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--bg);
            font-size: 13px;
            line-height: 1.4;
        }

        /* ===== HEADER STICKY ===== */
        #main-header-container {
            position: sticky;
            top: 0;
            background: white;
            border-bottom: 2px solid var(--border);
            z-index: 1000;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Header expandido (scroll top) */
        #main-header-container.expanded {
            padding: 16px 20px;
        }

        #main-header-container.expanded .header-full {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
            align-items: start;
        }

        #main-header-container.expanded .header-compact {
            display: none;
        }

        /* Header compacto (scroll down) */
        #main-header-container.collapsed {
            padding: 8px 20px;
        }

        #main-header-container.collapsed .header-full {
            display: none;
        }

        #main-header-container.collapsed .header-compact {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-compact {
            display: none;
        }

        .header-compact-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-compact-left strong {
            font-size: 14px;
            color: #333;
        }

        .header-compact-right {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        /* ===== ESTILOS DEL MODAL ===== */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 2000;
    display: none; /* Oculto por defecto */
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    width: 90%;
    max-width: 700px;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    background: #fafafa;
}

.modal-header h2 {
    font-size: 18px;
    color: #333;
    margin: 0;
}

.modal-header span {
    font-size: 11px;
    font-weight: 600;
    color: #667eea;
    text-transform: uppercase;
}

.modal-close {
    font-size: 28px;
    font-weight: 300;
    color: #888;
    background: none;
    border: none;
    cursor: pointer;
    line-height: 1;
    padding: 0;
}

.modal-body {
    padding: 24px;
    overflow-y: auto;
    font-size: 14px;
    line-height: 1.6;
}

.modal-body p {
    margin-bottom: 16px;
}

/* Estilos para el contenido 'list' */
.modal-list-item {
    margin-bottom: 16px;
    border-left: 3px solid;
    padding-left: 12px;
}
.modal-list-item strong {
    display: block;
    font-size: 14px;
    margin-bottom: 4px;
}
.modal-list-item p {
    font-size: 13px;
    margin: 0;
    color: #555;
}
.modal-list-item.high { border-color: var(--color-high); }
.modal-list-item.high strong { color: var(--color-high); }
.modal-list-item.moderate { border-color: var(--color-mod); }
.modal-list-item.moderate strong { color: var(--color-mod); }
.modal-list-item.low { border-color: var(--color-low); }
.modal-list-item.low strong { color: var(--color-low); }

/* Estilos para el contenido 'table' */
.modal-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
}
.modal-table th, .modal-table td {
    border: 1px solid var(--border);
    padding: 8px 10px;
    text-align: left;
}
.modal-table th {
    background-color: #f5f5f5;
    font-weight: 600;
}
.modal-table td:first-child {
    font-weight: 600;
    background: #fafafa;
}
.modal-table td:not(:first-child) {
    text-align: center;
}

/* Estilos para 'multi-table' */
.modal-multi-table {
    margin-bottom: 20px;
}
.modal-multi-table h4 {
    font-size: 15px;
    margin-bottom: 10px;
}
        /* Info general */
        .container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .info-content {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 8px;
            align-items: center;
        }

        .info-content label {
            font-size: 12px;
            font-weight: 600;
            color: #555;
        }

        .info-content input {
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 12px;
        }

        .info-content input:focus {
            outline: none;
            border-color: #666;
        }

        /* Resumen */
        .summary-container h2 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #333;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border: 1px solid var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .summary-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
        }

        .summary-table tr:last-child td {
            border-bottom: none;
        }

        .summary-table td:first-child {
            background: #fafafa;
            width: 65%;
        }

        .summary-table td:last-child {
            text-align: center;
            font-weight: bold;
            font-size: 20px;
        }

        .summary-table strong {
            display: block;
            color: #333;
        }

        .summary-table span:not(#risk-level-text) {
            font-size: 11px;
            color: #777;
            font-weight: normal;
        }

        #risk-level-text {
            display: block;
            font-size: 11px;
            font-weight: 600;
            margin-top: 2px;
        }

        .low { color: var(--color-risk-low); }
        .moderate { color: var(--color-risk-moderate); }
        .high { color: var(--color-risk-high); }

        /* ===== BÚSQUEDA ===== */
        .search-container {
            padding: 12px 20px;
            background: white;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 999;
        }

        #search-input {
            width: 100%;
            max-width: 400px;
            padding: 8px 12px 8px 36px;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 13px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23666" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>') no-repeat 12px center;
            background-size: 16px;
        }

        #search-input:focus {
            outline: none;
            border-color: #666;
        }

        /* ===== EVALUACIONES ===== */
        #evaluations-container {
            padding: 12px 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 12px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .evaluation-column {
            display: contents;
        }

        .container-evaluation {
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            display: flex;
            gap: 12px;
            transition: all 0.2s;
        }

        .container-evaluation:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .container-evaluation.hidden {
            display: none;
        }

        /* Lado izquierdo */
        .indicators {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 0;
        }

        .evaluation-title {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            line-height: 1.3;
        }

        .evaluation-image {
            width: 32px;
            height: 32px;
            object-fit: contain;
            opacity: 0.6;
        }

        .aditional-info {
            display: grid;
            grid-template-columns: auto 50px;
            gap: 6px;
            align-items: center;
            font-size: 11px;
            margin-top: auto;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }

        .aditional-info label {
            color: #666;
        }

        .aditional-info input {
            padding: 4px 6px;
            border: 1px solid var(--border);
            border-radius: 3px;
            font-size: 11px;
            text-align: center;
        }

        /* Lado derecho - SCORES HORIZONTALES */
        .score-indicators {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 140px;
        }

        .score-indicators > div:not(.score-display) {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .score-indicators p {
            font-size: 11px;
            font-weight: 600;
            color: #666;
            min-width: 32px;
        }

        .score-indicators input[type="checkbox"] {
            display: none;
        }

        .score-indicators .custom-x {
            width: 28px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
            font-weight: bold;
            font-size: 14px;
            color: transparent;
            flex-shrink: 0;
        }

        .custom-x:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }

        .score-indicators input.rojo + .custom-x { background-color: var(--color-high); }
        .score-indicators input.amarillo + .custom-x { background-color: var(--color-mod); }
        .score-indicators input.azul + .custom-x { background-color: var(--color-low); }
        .score-indicators input.gris + .custom-x { background-color: var(--color-ok); }
        .score-indicators input.verde + .custom-x { background-color: var(--color-na); }

        .score-indicators input[type="checkbox"]:checked + .custom-x {
            color: white;
            box-shadow: 0 0 0 2px rgba(0,0,0,0.2);
        }

        .score-indicators input[type="checkbox"]:checked + .custom-x::after {
            content: "✓";
        }

        .score-indicators label {
            font-size: 12px;
            font-weight: 600;
            min-width: 18px;
            text-align: left;
            color: #333;
        }

        .na-label {
            display: none !important;
        }

        .score-display {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }

        .score-display p:first-child {
            font-size: 10px;
            color: #999;
            font-weight: 600;
        }

        .selected-score {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            min-width: 24px;
        }

        /* ===== BOTONES ===== */
        #action-buttons-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-warning {
            background: #f5576c;
            color: white;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1200px) {
            #evaluations-container {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
        }

        @media (max-width: 768px) {
            #main-header-container.expanded .header-full {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            #evaluations-container {
                grid-template-columns: 1fr;
                padding: 12px;
            }

            .container-evaluation {
                flex-direction: column;
            }

            .score-indicators {
                width: 100%;
                min-width: 100%;
            }

            .aditional-info {
                grid-template-columns: 1fr;
            }

            #action-buttons-container {
                bottom: 12px;
                right: 12px;
                left: 12px;
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            #search-input {
                max-width: 100%;
            }
        }

        @media (max-width: 480px) {
            .info-content {
                grid-template-columns: 1fr;
            }

            .summary-table td {
                padding: 8px;
                font-size: 11px;
            }

            .summary-table td:last-child {
                font-size: 16px;
            }
        }
        .form-disabled {
            pointer-events: none; /* Bloquea todos los clics */
            opacity: 0.7;       /* Le da un aspecto "apagado" */
            user-select: none;  /* Evita que se pueda seleccionar texto */
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- HEADER STICKY -->
    <div id="main-header-container" class="expanded">
        <!-- Vista completa -->
        <div class="header-full">
            <section class="container">
                <div class="info-content">
                    <label>Job/Task</label>
                    <input type="text" id="job" placeholder="Almacén">
                </div>
                <div class="info-content">
                    <label>Company</label>
                    <input type="text" id="company" placeholder="J&J">
                </div>
                <div class="info-content">
                    <label>Location</label>
                    <input type="text" id="location" placeholder="Puebla">
                </div>
                <div class="info-content">
                    <label># of Employees</label>
                    <input type="text" id="Employees" placeholder="44">
                </div>
                <div class="info-content">
                    <label>Name of Analyst</label>
                    <input type="text" id="nAnalyst" placeholder="Brandon Cortes">
                </div>
            </section>

            <section class="summary-container">
                <h2>Resumen de Puntuación</h2>
                <table class="summary-table">
                    <tbody>
                        <tr>
                            <td>
                                <strong>Puntaje de Riesgo del Puesto</strong>
                                <span>(Suma de puntajes 1-40)</span>
                            </td>
                            <td>
                                <span id="job-risk-score">0</span>
                                <span id="risk-level-text"></span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Número de Empleados</strong></td>
                            <td id="num-employees-display">0</td>
                        </tr>
                        <tr>
                            <td>
                                <strong>Puntaje Total del Puesto</strong>
                                <span>(Riesgo × Empleados)</span>
                            </td>
                            <td id="total-job-score">0</td>
                        </tr>
                    </tbody>
                </table>
            </section>
        </div>

        <!-- Vista compacta -->
        <div class="header-compact">
            <div class="header-compact-left">
                <strong id="compact-job">-</strong>
            </div>
            <div class="header-compact-right">
                <span>Score: <span id="compact-score">0</span></span>
                <span id="compact-risk"></span>
            </div>
        </div>
    </div>

    <!-- BÚSQUEDA -->
    <div class="search-container">
        <input type="text" id="search-input" placeholder="Buscar evaluación... (ej: Wrist, Lifting, Noise)">
    </div>

    <!-- EVALUACIONES -->
    <div id="evaluations-container"></div>

    <!-- BOTONES -->
    <div id="action-buttons-container">
        <button id="edit-button" class="btn btn-warning" style="display: none;">Editar</button>
        <button id="save-button" class="btn btn-primary">Guardar</button>
    </div>

    <!-- TEMPLATE -->
    <template id="evaluation-template">
        <section class="container-evaluation">
            <div class="indicators">
                <h3 class="evaluation-title"></h3>
                <img src="" alt="Icon" class="evaluation-image">
                <div class="aditional-info">
                    <label>Cases</label>
                    <input type="text" class="cases-input" placeholder="0">
                    <label>Incidents</label>
                    <input type="text" class="incident-input" placeholder="0">
                </div>
            </div>
            <div class="score-indicators">
                <div>
                    <p>High</p>
                    <input type="checkbox" class="rojo">
                    <span class="custom-x"></span>
                    <label></label>
                </div>
                <div>
                    <p>Mod</p>
                    <input type="checkbox" class="amarillo">
                    <span class="custom-x"></span>
                    <label></label>
                </div>
                <div>
                    <p>Low</p>
                    <input type="checkbox" class="azul">
                    <span class="custom-x"></span>
                    <label></label>
                </div>
                <div>
                    <p>Ok</p>
                    <input type="checkbox" class="gris">
                    <span class="custom-x"></span>
                    <label></label>
                </div>
                <div>
                    <p>N/A</p>
                    <input type="checkbox" class="verde">
                    <span class="custom-x"></span>
                    <label class="na-label"></label>
                </div>
                <div class="score-display">
                    <p>SCORE</p>
                    <p class="selected-score">-</p>
                </div>
            </div>
        </section>
    </template>

    <div id="details-modal-overlay" class="modal-overlay">
    <div id="details-modal-content" class="modal-content">
        <header class="modal-header">
            <div>
                <span id="modal-category"></span>
                <h2 id="modal-title"></h2>
            </div>
            <button id="modal-close-btn" class="modal-close">×</button>
        </header>
        <div id="modal-body-content" class="modal-body">
            </div>
    </div>
</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            window.updateSummary = function() {
                let totalScore = 0;
                document.querySelectorAll('.selected-score').forEach(el => {
                    const score = parseInt(el.textContent, 10);
                    if (!isNaN(score)) totalScore += score;
                });

                const isHighRisk = document.querySelectorAll('input.rojo:checked').length > 0;
                const riskLevelElement = document.getElementById('risk-level-text');
                const compactRisk = document.getElementById('compact-risk');
                
                let riskText = '';
                let riskClass = '';
                
                if (isHighRisk || totalScore >= 30) {
                    riskText = '(Alto)';
                    riskClass = 'high';
                } else if (totalScore >= 20) {
                    riskText = '(Moderado)';
                    riskClass = 'moderate';
                } else {
                    riskText = '(Bajo)';
                    riskClass = 'low';
                }

                riskLevelElement.textContent = riskText;
                riskLevelElement.className = riskClass;
                compactRisk.textContent = riskText;
                compactRisk.className = riskClass;

                const numEmployees = parseInt(document.getElementById('Employees').value, 10) || 0;
                document.getElementById('job-risk-score').textContent = totalScore;
                document.getElementById('compact-score').textContent = totalScore;
                document.getElementById('num-employees-display').textContent = numEmployees;
                document.getElementById('total-job-score').textContent = totalScore * numEmployees;
            };

            const sectionsData = [
                { number: 1, title: 'Loss Information', image: 'https://placehold.co/32', scores: [12, 8, 4, 0] },
                { number: 2, title: 'Employee Response', image: 'https://placehold.co/32', scores: [8,4,2,0] },
                { number: 3, title: 'Miscellaneous', image: 'https://placehold.co/32', scores: [8,4,2,0] },
                { number: 4, title: 'Hand Grip Force / Power Grip', image: 'https://placehold.co/32', scores: [6,4,2,0] },
                { number: 5, title: 'Pinch Grip Force', image: 'https://placehold.co/32', scores: [6,4,2,0] },
                { number: 6, title: 'Finger or Thumb Press Force', image: 'https://placehold.co/32', scores: [6,4,2,0] },
                { number: 7, title: 'Wrist Flexion', image: 'https://placehold.co/32', scores: [3,3,1,0] },
                { number: 8, title: 'Wrist Extension', image: 'https://placehold.co/32', scores: [3,3,1,0] },
                { number: 9, title: 'Wrist Radial Deviation', image: 'https://placehold.co/32', scores: [3,3,1,0] },
                { number: 10, title: 'Wrist Ulnar Deviation', image: 'https://placehold.co/32', scores: [3,3,1,0] },
                { number: 11, title: 'Repetition', image: 'https://placehold.co/32', scores: [6,4,2,0] },
                { number: 12, title: 'Vibration', image: 'https://placehold.co/32', scores: [6,4,2,0] },
                { number: 13, title: 'Mechanical Stress to Hand', image: 'https://placehold.co/32', scores: [6,4,2,0] },
                { number: 14, title: 'Mechanical Stress to Arm', image: 'https://placehold.co/32', scores: [3,3,1,0] },
                { number: 15, title: 'Hand Palm-Up (Forearm Supination)', image: 'https://placehold.co/32', scores: [3,3,1,0] },
                { number: 16, title: 'Hand Palm-Down (Forearm Pronation)', image: 'https://placehold.co/32', scores: [3,3,1,0] },
                { number: 17, title: 'Pull Down with One or Both Arms', image: 'https://placehold.co/32', scores: [6,4,2,0] },
                { number: 18, title: 'One-handed Push or Pull', image: 'https://placehold.co/32', scores: [6,4,2,0] },
                { number: 19, title: 'Shoulder Abduction or Flexion', image: 'https://placehold.co/32', scores: [6,4,2,0] },
                { number: 20, title: 'Reach Across Body', image: 'https://placehold.co/32', scores: [3,2,1,0] },
                { number: 21, title: 'Reach Behind Body', image: 'https://placehold.co/32', scores: [3,2,1,0] },
                { number: 22, title: 'Neck Flexion', image: 'https://placehold.co/32', scores: [3,2,1,0] },
                { number: 23, title: 'Neck Extension', image: 'https://placehold.co/32', scores: [3,2,1,0] },
                { number: 24, title: 'Lateral Bending of Neck', image: 'https://placehold.co/32', scores: [3,2,1,0] },
                { number: 25, title: 'Employee Response', image: 'https://placehold.co/32', scores: [3,2,1,0] },
                { number: 26, title: 'Bending Forward', image: 'https://placehold.co/32', scores: [6,4,2,0] },
                { number: 27, title: 'Bending to Side', image: 'https://placehold.co/32', scores: [3,2,1,0] },
                { number: 28, title: 'Twisting', image: 'https://placehold.co/32', scores: [3,2,1,0] },
                { number: 29, title: 'Stand on Unpadded Surface', image: 'https://placehold.co/32', scores: [3,2,1,0] },
                { number: 30, title: 'Impact Stress to Knees and Ankles', image: 'https://placehold.co/32', scores: [3,2,1,0] },
                { number: 31, title: 'Ankle Extension', image: 'https://placehold.co/32', scores: [3,2,1,0] },
                { number: 32, title: 'Static Ankle Flexion', image: 'https://placehold.co/32', scores: [3,2,1,0] },
                { number: 33, title: 'Lifting', image: 'https://placehold.co/32', scores: [6,4,2,0] },
                { number: 34, title: 'Carrying', image: 'https://placehold.co/32', scores: [6,4,2,0] },
                { number: 35, title: 'Pushing and Pulling (Initial Force)', image: 'https://placehold.co/32', scores: [6,4,2,0] },
                { number: 36, title: 'Noise', image: 'https://placehold.co/32', scores: [3,2,1,0] },
                { number: 37, title: 'Heat Stress', image: 'https://placehold.co/32', scores: [3,2,1,0] },
                { number: 38, title: 'Cold Stress', image: 'https://placehold.co/32', scores: [3,2,1,0] },
                { number: 39, title: 'Lighting', image: 'https://placehold.co/32', scores: [3,2,1,0] },
                { number: 40, title: 'Human Error', image: 'https://placehold.co/32', scores: [3,2,1,0] }
            ];

            const container = document.getElementById('evaluations-container');
            const template = document.getElementById('evaluation-template');
            sectionsData.forEach((data, index) => {

                const clone = document.importNode(template.content, true);
                clone.querySelector('.evaluation-title').textContent = `${data.number}. ${data.title}`;
                clone.querySelector('.evaluation-image').src = data.image;

                const card = clone.querySelector('.container-evaluation');
                card.dataset.searchText = data.title.toLowerCase();
                card.addEventListener('click', () => openDetailsModal(data.number));

                const scoreDivs = clone.querySelectorAll('.score-indicators > div:not(.score-display)');
                const colorClasses = ['rojo', 'amarillo', 'azul', 'gris', 'verde'];

                scoreDivs.forEach((div, j) => {
                    const input = div.querySelector('input[type="checkbox"]');
                    const label = div.querySelector('label');
                    
                    if (!input) return;

                    input.name = `group-${index}`;
                    input.classList.add(colorClasses[j]);

                    if (j === 4) {
                        input.setAttribute('data-score', '0');
                        if(label) label.style.display = 'none';
                    } else if (label && data.scores[j] !== undefined) {
                        label.textContent = data.scores[j];
                    }
                });

                const checkboxes = clone.querySelectorAll('.score-indicators input[type="checkbox"]');
                checkboxes.forEach(chk => {
                    chk.addEventListener('change', function() {
                        if (this.checked) {
                            checkboxes.forEach(other => { if (other !== this) other.checked = false; });
                            const scoreEl = this.closest('.container-evaluation').querySelector('.selected-score');
                            const scoreValue = this.classList.contains('verde') ? 
                                this.getAttribute('data-score') : 
                                this.parentElement.querySelector('label').textContent;
                            scoreEl.textContent = scoreValue;
                        } else {
                            this.closest('.container-evaluation').querySelector('.selected-score').textContent = '-';
                        }
                        window.updateSummary();
                        const saveBtn = document.getElementById('save-button');
            if (saveBtn) {
                console.log('Event listener agregado a #save-button');
                saveBtn.addEventListener('click', saveJohnsonEvaluation);
            } else {
                console.error('No se encontró el botón con id "save-button"');
            }
                    });
                });

                clone.querySelectorAll('.custom-x').forEach(span => {
                    span.addEventListener('click', function() {
                        const input = this.previousElementSibling;
                        if (input && !input.checked) {
                            input.checked = true;
                            input.dispatchEvent(new Event('change'));
                        }
                    });
                });
                
                container.appendChild(clone);
            });

            // Búsqueda
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('.container-evaluation').forEach(card => {
                    const text = card.dataset.searchText;
                    if (text.includes(searchTerm)) {
                        card.classList.remove('hidden');
                    } else {
                        card.classList.add('hidden');
                    }
                });
            });

            // Header sticky con colapso
            const header = document.getElementById('main-header-container');
            const jobInput = document.getElementById('job');
            const compactJob = document.getElementById('compact-job');

            jobInput.addEventListener('input', () => {
                compactJob.textContent = jobInput.value || '-';
            });
let isHeaderCompact = false;
const scrollThreshold = 150; // El punto donde quieres que cambie

window.addEventListener('scroll', () => {
  const scrollY = window.scrollY;

  // SÓLO se compacta si el scroll es mayor Y NO ESTÁ compacto
  if (scrollY > scrollThreshold && !isHeaderCompact) {
    header.classList.add('header-compact');
    isHeaderCompact = true; // Fija el estado
  
  // SÓLO se expande si el scroll es menor Y SÍ ESTÁ compacto
  } else if (scrollY <= scrollThreshold && isHeaderCompact) {
    header.classList.remove('header-compact');
    isHeaderCompact = false; // Fija el estado
  }
  
  // Si ninguna condición se cumple, no hace nada y rompe el bucle.
});

            // Listener para empleados
            document.getElementById('Employees').addEventListener('input', window.updateSummary);
            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
        document.getElementById('details-modal-overlay').addEventListener('click', (e) => {
            if (e.target.id === 'details-modal-overlay') {
                closeModal();
            }
        });

        // Cargar los datos del JSON al iniciar
        loadModalData();
            const saveBtn = document.getElementById('save-button');
    if (saveBtn) {
        console.log('Event listener agregado a #save-button');
        saveBtn.addEventListener('click', saveJohnsonEvaluation);
    } else {
        console.error('No se encontró el botón con id "save-button"');
    }

    // Conectar el botón de editar
    const editBtn = document.getElementById('edit-button');
    if (editBtn) {
        console.log('Event listener agregado a #edit-button');
        editBtn.addEventListener('click', () => {
            // Al hacer clic en Editar, ocultamos "Editar" y mostramos "Guardar"
            editBtn.style.display = 'none';
            saveBtn.style.display = 'block';
            setFormEnabled(true);
            // Opcional: notificar al usuario
            const toast = window.ERGOUtils?.showToast;
            if(toast) toast('Modo de edición activado.', 'info');
            else console.log('Modo de edición activado.');
        });
    }

    // LLAMAR A LA FUNCIÓN DE CARGA
    // Esto rellenará el formulario y actualizará el resumen si hay datos
    loadJohnsonEvaluation();
            // Actualizar resumen inicial
        });

        /**
 * @file johnson-saver.js
 * Contiene la lógica para recopilar y guardar los datos de
 * Johnson_Evaluation.html en la base de datos Supabase.
 */

/**
 * Obtiene la selección de riesgo de un contenedor de evaluación.
 * @param {HTMLElement} container - El elemento .container-evaluation
 * @returns {string} - 'high', 'mod', 'low', 'ok', 'na', o 'none'
 */
function _getJohnsonSelection(container) {
  const checkedBox = container.querySelector(
    '.score-indicators input[type="checkbox"]:checked'
  );
  if (!checkedBox) return 'none';

  if (checkedBox.classList.contains('rojo')) return 'high';
  if (checkedBox.classList.contains('amarillo')) return 'mod';
  if (checkedBox.classList.contains('azul')) return 'low';
  if (checkedBox.classList.contains('gris')) return 'ok';
  if (checkedBox.classList.contains('verde')) return 'na';

  return 'none';
}

/**
 * Recopila todos los datos del formulario de Evaluación Johnson en un objeto JSON.
 * @returns {object} - El objeto JSON con todos los datos de la evaluación.
 */
function getJohnsonEvaluationData() {
  const header = {
    job: document.getElementById('job')?.value || '',
    company: document.getElementById('company')?.value || '',
    location: document.getElementById('location')?.value || '',
    employees: parseInt(document.getElementById('Employees')?.value, 10) || 0,
    analyst: document.getElementById('nAnalyst')?.value || '',
  };

  const summary = {
    jobRiskScore:
      parseInt(document.getElementById('job-risk-score')?.textContent, 10) || 0,
    riskLevel: document.getElementById('risk-level-text')?.textContent || '',
    totalJobScore:
      parseInt(document.getElementById('total-job-score')?.textContent, 10) || 0,
  };

  const details = [];
  const containers = document.querySelectorAll('.container-evaluation');

  containers.forEach((container) => {
    const fullTitle =
      container.querySelector('.evaluation-title')?.textContent || '';
    const scoreText =
      container.querySelector('.selected-score')?.textContent || '-';

    details.push({
      id: parseInt(fullTitle.split('.')[0], 10) || 0,
      title: fullTitle.split('.')[1]?.trim() || '',
      cases: container.querySelector('.cases-input')?.value || '',
      incidents: container.querySelector('.incident-input')?.value || '',
      score: scoreText === '-' ? 0 : parseInt(scoreText, 10),
      selection: _getJohnsonSelection(container),
    });
  });

  return {
    header,
    summary,
    details,
  };
}

/**
 * Rellena el formulario de Johnson con datos existentes.
 * @param {object} ejaData - El objeto 'eja' guardado en Supabase.
 */
function populateJohnsonForm(ejaData) {
  console.log('Rellenando formulario con EJA existente...', ejaData);

  // 1. Rellenar el Encabezado (Header)
  try {
    document.getElementById('job').value = ejaData.header.job || '';
    document.getElementById('company').value = ejaData.header.company || '';
    document.getElementById('location').value = ejaData.header.location || '';
    document.getElementById('Employees').value = ejaData.header.employees || 0;
    document.getElementById('nAnalyst').value = ejaData.header.analyst || '';
    console.log('Encabezado rellenado.');
  } catch (error) {
    console.error('Error al rellenar el encabezado:', error);
  }

  // Mapa para convertir la selección guardada al selector de clase del checkbox
  const selectionToClass = {
    high: '.rojo',
    mod: '.amarillo',
    low: '.azul',
    ok: '.gris',
    na: '.verde',
  };

  // 2. Rellenar los Detalles de Evaluación
  const containers = document.querySelectorAll('.container-evaluation');
  
  if (ejaData.details && Array.isArray(ejaData.details)) {
    ejaData.details.forEach((detail) => {
      // Encontrar el contenedor correcto usando el ID (ej: 1, 2, 3...)
      const card = Array.from(containers).find((c) => {
        const title = c.querySelector('.evaluation-title')?.textContent || '';
        return title.startsWith(detail.id + '.');
      });

      if (card) {
        card.querySelector('.cases-input').value = detail.cases || '';
        card.querySelector('.incident-input').value = detail.incidents || '';

        // Encontrar el checkbox correcto basado en la selección guardada
        const selector = selectionToClass[detail.selection];
        if (selector) {
          const checkbox = card.querySelector(selector);
          if (checkbox) {
            checkbox.checked = true;
            // IMPORTANTE: Disparar el evento 'change' para actualizar el score visual
            checkbox.dispatchEvent(new Event('change'));
          }
        }
      } else {
        console.warn(`No se encontró la tarjeta para el ID: ${detail.id}`);
      }
    });
    console.log('Detalles de evaluaciones rellenados.');
  }

  // 3. Actualizar los totales
  window.updateSummary();
  console.log('Resumen actualizado.');

  // 4. Cambiar botones: Ocultar Guardar, Mostrar Editar
  // Asumimos que si cargó datos, no queremos guardar inmediatamente
  document.getElementById('save-button').style.display = 'none';
  document.getElementById('edit-button').style.display = 'block';
}

/**
 * Carga una Evaluación Johnson existente desde Supabase al iniciar la página.
 */
async function loadJohnsonEvaluation() {
  console.log('Intentando cargar evaluación existente...');

  const dbClient = window.dataClient?.supabase;
  if (!dbClient) {
    console.error('loadJohnsonEvaluation: dbClient no encontrado.');
    return;
  }

  const urlParams = new URLSearchParams(window.location.search);
  const actividad_id = urlParams.get('actividadId') || urlParams.get('actividad_id');

  if (!actividad_id) {
    console.log('No hay actividad_id en la URL. Se asume nueva evaluación.');
    setFormEnabled(true);
    return;
  }

  console.log(`Buscando EJA para actividad_id: ${actividad_id}`);

  try {
    const { data, error: fetchError } = await dbClient
      .from('evaluaciones_completas')
      .select('eja') // Solo traemos la columna EJA
      .eq('actividad_id', actividad_id)
      .maybeSingle();

    if (fetchError) throw fetchError;

    if (data && data.eja) {
      console.log('Datos EJA encontrados. Rellenando formulario...');
      populateJohnsonForm(data.eja);
      setFormEnabled(false);
    } else {
      console.log('No se encontraron datos EJA para esta actividad. Es una nueva evaluación.');
      // Si no hay datos, nos aseguramos que el botón de Guardar esté visible
      document.getElementById('save-button').style.display = 'block';
      document.getElementById('edit-button').style.display = 'none';
      setFormEnabled(true);
    }
  } catch (error) {
    console.error('Error al cargar la Evaluación Johnson:', error);
    alert(`Error cargando datos: ${error.message}`);
  }
}

/**
 * Guarda los datos de la Evaluación Johnson en la tabla 'evaluaciones_completas'.
 * Verifica si existe un registro para la actividad_id; si existe, actualiza 'eja',
 * si no, crea un nuevo registro.
 */
async function saveJohnsonEvaluation() {
  console.log('Iniciando saveJohnsonEvaluation...');
  autoFillEmptyAsOk();

  const saveButton = document.getElementById('save-button'); // ID CORREGIDO
  if (saveButton) saveButton.disabled = true;

  const toast = window.ERGOUtils?.showToast;
  if (!toast) {
    console.error('ERGOUtils.showToast no está disponible.');
    alert('Error: Utilidades no cargadas.');
    if (saveButton) saveButton.disabled = false;
    return;
  }
  

  const dbClient = window.dataClient?.supabase;
  if (!dbClient) {
    console.error('dbClient (window.dataClient.supabase) no encontrado.');
    toast('Error: No se pudo conectar a la base de datos.', 'error');
    if (saveButton) saveButton.disabled = false;
    return;
  }

  const urlParams = new URLSearchParams(window.location.search);
  const actividad_id = urlParams.get('actividadId') || urlParams.get('actividad_id');
  const work_center_id = urlParams.get('workCenter') || urlParams.get('work_center_id');
  const area_id = urlParams.get('area') || urlParams.get('area_id');

  if (!actividad_id || !work_center_id || !area_id) {
    console.error('Error: Faltan IDs en la URL.', { actividad_id, work_center_id, area_id });
    toast('Error: Faltan IDs (actividad, centro, área) en la URL.', 'error');
    if (saveButton) saveButton.disabled = false;
    return;
  }
  
  console.log('IDs de URL obtenidos:', { actividad_id, work_center_id, area_id });

  const user = window.ERGOAuth?.getCurrentUser();
  const user_id = user?.id || null;
  autoFillEmptyAsOk();
  const ejaData = getJohnsonEvaluationData();
  const evaluador = ejaData.header.analyst || user?.nombre || 'No especificado';

  console.log('Datos de EJA recopilados:', ejaData);
  console.log('Datos para Supabase:', { user_id, evaluador });

  try {
    toast('Guardando...', 'info');
    console.log('Buscando registro existente para actividad_id:', actividad_id);

    const { data: existing, error: fetchError } = await dbClient
      .from('evaluaciones_completas')
      .select('id')
      .eq('actividad_id', actividad_id)
      .maybeSingle();

    if (fetchError) throw fetchError;

    if (existing) {
      console.log('Registro existente encontrado (ID:', existing.id, '). Actualizando...');
      // --- ACTUALIZAR REGISTRO EXISTENTE ---
      const { error: updateError } = await dbClient
        .from('evaluaciones_completas')
        .update({
          eja: ejaData,
          evaluador: evaluador,
          trabajadores: ejaData.header.employees,
          titulo: ejaData.header.job,
          updated_at: new Date().toISOString(),
        })
        .eq('id', existing.id);

      if (updateError) throw updateError;
      console.log('Actualización exitosa.');
      toast('Evaluación actualizada correctamente.', 'success');
    } else {
      console.log('No se encontró registro. Creando uno nuevo...');
      // --- CREAR NUEVO REGISTRO ---
      const { error: insertError } = await dbClient
        .from('evaluaciones_completas')
        .insert({
          actividad_id: actividad_id,
          work_center_id: work_center_id,
          area_id: area_id,
          user_id: user_id,
          evaluador: evaluador,
          trabajadores: ejaData.header.employees,
          titulo: ejaData.header.job,
          eja: ejaData,
        });

      if (insertError) throw insertError;
      console.log('Inserción exitosa.');
      toast('Evaluación guardada correctamente.', 'success');
    }
  } catch (error) {
    console.error('Error al guardar la Evaluación Johnson:', error);
    toast(`Error: ${error.message}`, 'error');
  } finally {
    if (saveButton) saveButton.disabled = false;
    console.log('Proceso saveJohnsonEvaluation finalizado.');
  }
}

/**
 * Habilita o deshabilita visualmente la edición del formulario.
 * @param {boolean} enabled - true para habilitar, false para deshabilitar (modo lectura).
 */
function setFormEnabled(enabled) {
  // Obtenemos los 3 contenedores principales
  const header = document.getElementById('main-header-container');
  const search = document.querySelector('.search-container');
  const evals = document.getElementById('evaluations-container');

  const elements = [header, search, evals];

  if (enabled) {
    console.log('Formulario HABILITADO para edición.');
    // Quitamos la clase 'form-disabled' para activar todo
    elements.forEach(el => el?.classList.remove('form-disabled'));
  } else {
    console.log('Formulario DESHABILITADO (modo lectura).');
    // Añadimos la clase 'form-disabled' para apagar todo
    elements.forEach(el => el?.classList.add('form-disabled'));
  }
}
/**
 * @fileoverview
 * Revisa todas las tarjetas de evaluación antes de guardar.
 * Si una tarjeta no tiene ninguna selección, la marca
 * automáticamente como 'OK' (score 0).
 */
function autoFillEmptyAsOk() {
  console.log('Verificando tarjetas vacías...');
  let filledCount = 0;
  const containers = document.querySelectorAll('.container-evaluation');

  containers.forEach((container, index) => {
    // 1. Verificar si alguna casilla ya está marcada
    const anyChecked = container.querySelector(
      '.score-indicators input[type="checkbox"]:checked'
    );

    // 2. Si ninguna está marcada...
    if (!anyChecked) {
      // 3. Encontrar la casilla 'OK' (que usa la clase 'gris')
      const okCheckbox = container.querySelector('.score-indicators input.gris');

      if (okCheckbox) {
        // 4. Marcarla y (MUY IMPORTANTE) disparar el evento 'change'
        // para que se actualice el score visualmente.
        okCheckbox.checked = true;
        okCheckbox.dispatchEvent(new Event('change'));
        filledCount++;
      }
    }
  });

  if (filledCount > 0) {
    console.log(`Se autocompletaron ${filledCount} tarjetas vacías como 'OK'.`);
    // Actualizamos el resumen final una vez más por si acaso
    window.updateSummary();
  } else {
    console.log('Todas las tarjetas tenían un valor. No se autocompletó nada.');
  }
}
let johnsonDetailsData = []; // Para almacenar los datos del JSON

/**
 * Carga los datos del JSON al iniciar
 */
async function loadModalData() {
    try {
        const response = await fetch('johnson_details.json'); // Asegúrate que la ruta sea correcta
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        johnsonDetailsData = await response.json();
        console.log('Datos de detalles (JSON) cargados.', johnsonDetailsData);
    } catch (error) {
        console.error('Error al cargar johnson_details.json:', error);
    }
}

/**
 * Abre el modal y lo rellena con la información del ID
 * @param {number} id - El ID de la evaluación (1-40)
 */
function openDetailsModal(id) {
    const data = johnsonDetailsData.find(item => item.id === id);
    if (!data) {
        console.warn(`No se encontraron datos para el modal con ID: ${id}`);
        return;
    }

    // Rellenar cabecera
    document.getElementById('modal-category').textContent = data.category || 'Ergonomic Factor';
    document.getElementById('modal-title').textContent = `${data.id}. ${data.title}`;
    
    // Construir cuerpo
    const body = document.getElementById('modal-body-content');
    body.innerHTML = ''; // Limpiar contenido anterior
    
    // 1. Descripción
    const descriptionEl = document.createElement('p');
    descriptionEl.className = 'modal-description';
    descriptionEl.textContent = data.description;
    body.appendChild(descriptionEl);
    
    // 2. Contenido (lista o tabla)
    const contentHtml = buildModalContent(data);
    body.insertAdjacentHTML('beforeend', contentHtml);

    // Mostrar modal
    document.getElementById('details-modal-overlay').style.display = 'flex';
}

/**
 * Genera el HTML para el cuerpo del modal basado en el content_type
 * @param {object} data - El objeto de datos para un item
 * @returns {string} - El string HTML para el contenido
 */
function buildModalContent(data) {
    // TIPO: LISTA (ej. 1, 2, 3)
    if (data.content_type === 'list') {
        const c = data.content;
        return `
            <div class="modal-list">
                <div class="modal-list-item high">
                    <strong>${c.high.title}</strong>
                    <p>${c.high.text}</p>
                </div>
                <div class="modal-list-item moderate">
                    <strong>${c.moderate.title}</strong>
                    <p>${c.moderate.text}</p>
                </div>
                <div class="modal-list-item low">
                    <strong>${c.low.title}</strong>
                    <p>${c.low.text}</p>
                </div>
            </div>
        `;
    }
    
    // TIPO: TABLA SIMPLE (ej. 4, 5)
    if (data.content_type === 'table') {
        const c = data.content;
        let headers = c.headers.map(h => `<th>${h}</th>`).join('');
        let rows = c.rows.map(row => {
            let values = row.values.map(val => `<td>${val}</td>`).join('');
            return `<tr><td>${row.label}</td>${values}</tr>`;
        }).join('');
        
        return `<table class="modal-table">
                    <thead><tr>${headers}</tr></thead>
                    <tbody>${rows}</tbody>
                </table>`;
    }

    // TIPO: MÚLTIPLES TABLAS (ej. 6)
    if (data.content_type === 'multi-table') {
        return data.content.map(tableSet => {
            const c = tableSet.table;
            let headers = c.headers.map(h => `<th>${h}</th>`).join('');
            let rows = c.rows.map(row => {
                let values = row.values.map(val => `<td>${val}</td>`).join('');
                return `<tr><td>${row.label}</td>${values}</tr>`;
            }).join('');
            
            return `<div class="modal-multi-table">
                        <h4>${tableSet.title}</h4>
                        <table class="modal-table">
                            <thead><tr>${headers}</tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>`;
        }).join('');
    }

    // --- NUEVO CÓDIGO AÑADIDO ---
    // TIPO: TABLA DOBLE (ej. 7-10, posturas)
    if (data.content_type === 'dual-table') {
        const c = data.content;
        
        // Función auxiliar para crear una tabla
        const createTable = (tableData) => {
            let headers = tableData.headers.map(h => `<th>${h}</th>`).join('');
            let rows = tableData.rows.map(row => {
                let values = row.values.map(val => `<td>${val}</td>`).join('');
                return `<tr><td>${row.label}</td>${values}</tr>`;
            }).join('');
            return `<div class="modal-multi-table">
                        <h4>${tableData.title}</h4>
                        <table class="modal-table">
                            <thead><tr>${headers}</tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>`;
        };

        // Crear ambas tablas
        let table1Html = createTable(c.table1);
        let table2Html = createTable(c.table2);
        
        return table1Html + table2Html;
    }
    // --- FIN DEL CÓDIGO AÑADIDO ---

    // Mensaje de error si ningún 'if' coincide
    return '<p>No se encontró un tipo de contenido válido.</p>';
}

/**
 * Cierra el modal
 */
function closeModal() {
    document.getElementById('details-modal-overlay').style.display = 'none';
}
    </script>
</body>
</html>